<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NDNT.modules.layers.readouts API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../layers.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NDNT.modules.layers</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#ReadoutLayer">ReadoutLayer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReadoutLayer.__init__">ReadoutLayer</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.batch_sample">batch_sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.sample_mode">sample_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.init_mu_range">init_mu_range</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.init_sigma">init_sigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.align_corners">align_corners</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.grid_shape">grid_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.mu">mu</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.sigma">sigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.level_reg">level_reg</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.sample">sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.features">features</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer.grid">grid</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.initialize_spatial_mapping">initialize_spatial_mapping</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.sample_grid">sample_grid</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.get_weights">get_weights</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.compute_reg_loss">compute_reg_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.forward">forward</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.set_readout_locations">set_readout_locations</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.get_readout_locations">get_readout_locations</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.passive_readout">passive_readout</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.fit_mus">fit_mus</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.enforce_grid">enforce_grid</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer.layer_dict">layer_dict</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReadoutLayer3d">ReadoutLayer3d</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReadoutLayer3d.__init__">ReadoutLayer3d</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer3d.input_dims">input_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer3d.filter_dims">filter_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayer3d.reg">reg</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer3d.set_mask">set_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer3d.forward">forward</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer3d.passive_readout">passive_readout</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayer3d.layer_dict">layer_dict</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FixationLayer">FixationLayer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FixationLayer.__init__">FixationLayer</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.num_spatial_dims">num_spatial_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.num_fixations">num_fixations</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.batch_sample">batch_sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.init_sigma">init_sigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.single_sigma">single_sigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.fix_n_index">fix_n_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#FixationLayer.sample">sample</a>
                        </li>
                        <li>
                                <a class="function" href="#FixationLayer.forward">forward</a>
                        </li>
                        <li>
                                <a class="function" href="#FixationLayer.initialize">initialize</a>
                        </li>
                        <li>
                                <a class="function" href="#FixationLayer.layer_dict">layer_dict</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReadoutLayerQsample">ReadoutLayerQsample</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.__init__">ReadoutLayerQsample</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.batch_Qsample">batch_Qsample</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.Qsample_mode">Qsample_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.init_Qsigma">init_Qsigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.Qgrid_shape">Qgrid_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.Qmu">Qmu</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.Qsigma">Qsigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReadoutLayerQsample.Qsample">Qsample</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.sample_Qgrid">sample_Qgrid</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.fit_Qmus">fit_Qmus</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.forward">forward</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.degrees2mu">degrees2mu</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.mu2degrees">mu2degrees</a>
                        </li>
                        <li>
                                <a class="function" href="#ReadoutLayerQsample.layer_dict">layer_dict</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../NDNT.html">NDNT</a><wbr>.<a href="./../../modules.html">modules</a><wbr>.<a href="./../layers.html">layers</a><wbr>.readouts    </h1>

                
                        <input id="mod-readouts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-readouts-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Parameter</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">.ndnlayer</span> <span class="kn">import</span> <span class="n">NDNLayer</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="k">class</span> <span class="nc">ReadoutLayer</span><span class="p">(</span><span class="n">NDNLayer</span><span class="p">):</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">    ReadoutLayer for spatial readout.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>            <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>            <span class="n">batch_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>            <span class="n">init_mu_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>            <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>            <span class="n">gauss_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;isotropic&#39;</span><span class="p">,</span> <span class="c1"># &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>            <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span>  <span class="c1"># &#39;nearest&#39; is also possible</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">        ReadoutLayer: Spatial readout layer for NDNs.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">        Args:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">            num_filters: number of output filters</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">            filter_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">            batch_sample: bool, whether to sample grid locations separately per sample per batch</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">            init_mu_range: float, range for uniform initialization of means</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">            gauss_type: str, &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">            align_corners: bool, whether to align corners in grid_sample</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">            mode: str, &#39;bilinear&#39; or &#39;nearest&#39;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify input_dims&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>        <span class="k">assert</span> <span class="n">num_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify num_filters&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>        <span class="c1"># Make sure filter_dims is filled in, and to single the spatial filter dimensions</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="k">if</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>        
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>        <span class="n">filter_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>        
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cant handle temporal filter dims here, yet.&#39;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>        
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>            <span class="n">num_filters</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="n">filter_dims</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>        <span class="c1"># Determine whether one- or two-dimensional readout</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="k">if</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="c1"># Additional readout parameters (below)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;minval&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>            <span class="c1"># Does this apply to both weights and biases? Should be separate?</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="c1"># self.flatten = nn.Flatten()</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span> <span class="o">=</span> <span class="n">batch_sample</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span> <span class="o">=</span> <span class="n">mode</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">=</span> <span class="n">init_mu_range</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;either init_mu_range doesn&#39;t belong to [0.0, 1.0] or init_sigma_range is non-positive&quot;</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span>  <span class="c1"># only 1-d to sample sigma in</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">=</span> <span class="n">gauss_type</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span> <span class="o">=</span> <span class="n">align_corners</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="c1"># position grid shape</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 2, 2)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;uncorrelated&#39;</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 1, 2)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;isotropic&#39;</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 1, 1)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gauss_type &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span><span class="si">}</span><span class="s1">&quot; not known&#39;</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="c1"># initialize means and spreads</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="n">map_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">*</span><span class="n">map_size</span><span class="p">))</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span><span class="p">))</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="c1"># For use with scaffold_level_regularization</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># just so info is available</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_scaffold_level_weights&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_spatial_mapping</span><span class="p">()</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="c1"># END ReadoutLayer.__init__</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="nd">@property</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>            <span class="c1">#feat = F.relu(self.weight)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="k">return</span> <span class="n">feat</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="nd">@property</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="c1">#@property</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>    <span class="c1">#def mu(self):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>    <span class="c1">#    return self.mu</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>    <span class="k">def</span> <span class="nf">initialize_spatial_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">        Initializes the mean, and sigma of the Gaussian readout.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">        Args:</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">            None</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span><span class="p">)</span>  <span class="c1"># random initializations uniformly spread....</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="c1"># if self.gauss_type != &#39;full&#39;:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="c1">#     self.sigma.data.fill_(self.init_sigma)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="c1"># else:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="c1">#self.sigma.data.uniform_(0, self.init_sigma)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="c1">#self.weight.data.fill_(1 / self.input_dims[0])</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>    <span class="k">def</span> <span class="nf">sample_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        Returns the grid locations from the core by sampling from a Gaussian distribution</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">        More specifically, it returns sampled positions for each batch over all elements, given mus and sigmas</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        If &#39;sample&#39; is false, it just gives mu back (so testing has no randomness)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        This code is inherited and then modified, so different style than most other</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">        Args:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">            batch_size (int): size of the batch</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">            sample (bool/None): sample determines whether we draw a sample from Gaussian distribution, N(mu,sigma), defined per neuron</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">                            or use the mean, mu, of the Gaussian distribution without sampling.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">                           if sample is None (default), samples from the N(mu,sigma) during training phase and</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">                             fixes to the mean, mu, during evaluation phase.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">                           if sample is True/False, overrides the model_state (i.e training or eval) and does as instructed</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="c1">#self.mu.clamp(min=-1, max=1)  # at eval time, only self.mu is used so it must belong to [-1,1]</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">!=</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sigma/variance is always a positive quantity</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="n">grid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sample</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">grid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">grid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>            <span class="c1"># this is dan&#39;s 1-d kluge code -- necessary because grid_sampler has to have last dimension of 2. maybe problem....</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>            <span class="n">grid2d</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="c1">#grid2d[:,:,:,0] = (norm * self.sigma + self.mu).clamp(-1,1).squeeze(-1)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>            <span class="c1">## SEEMS dim-4 HAS TO BE IN THE SECOND DIMENSION (RATHER THAN FIRST)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>            <span class="n">grid2d</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="k">return</span> <span class="n">grid2d</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="c1">#return (norm * self.sigma + self.mu).clamp(-1,1) # this needs second dimension</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">!=</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="c1"># grid locations in feature space sampled randomly around the mean self.mu</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                <span class="c1">#return (norm * self.sigma + self.mu).clamp(-1,1)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">norm</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ancd,bnid-&gt;bnic&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># grid locations in feature space sampled randomly around the mean self.mu</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="c1"># END ReadoutLayer.sample_grid() </span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_reshape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_reverse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_inh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        Overloaded to read not use preprocess weights but instead use layer property features.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        </span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        Args:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">            to_reshape (bool): whether to reshape the weights to the filter_dims</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">            time_reverse (bool): whether to reverse the time dimension</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">            num_inh (int): number of inhibitory units</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">        Returns:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">            ws: weights of the readout layer</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="k">assert</span> <span class="n">time_reverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  READOUT: time_reverse will not work here.&quot;</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="k">assert</span> <span class="n">num_inh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  READOUT: num_inh will not work here.&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="k">if</span> <span class="n">to_reshape</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="c1"># Add singleton dimension corresponding to number of filters</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="k">return</span> <span class="n">ws</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>    <span class="c1"># END ReadoutLayer.get_weights()</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>    <span class="k">def</span> <span class="nf">_set_scaffold_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaffold_level_parse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level_exponent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">        Set regularization that applies to scaffold level to force weights towards low levels.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        This function should not be called directly, since will need to pass in non-local scaffold </span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">        information available only at the NDN level.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">        </span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">        Args: </span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">            reg_val (float or None): regularization weight to set, default None</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">            scaffold_level_parse (np.array): level weighting with dimension of number of filters in each</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">                scaffold level [4,25,8,4], but should include total number of weights (in case 4th dim)    </span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">            level_exponent (positive float): how much to weight each level </span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">        Returns:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">            None</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">         &quot;&quot;&quot;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>            <span class="c1"># Otherwise, construct weighting across filter_input dimensions</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="k">assert</span> <span class="n">level_exponent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;SCAFFOLD REG: level_exponent must be &gt;0&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scaffold_level_parse</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;SCAFFOLD REG: Internal error with scaffold_level_parse&quot;</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="n">reg_val</span>  <span class="c1"># just to keep track (should be register_buffer?)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="n">scaffold_weights</span> <span class="o">=</span> <span class="n">reg_val</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="n">place_holder</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scaffold_level_parse</span><span class="p">)):</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                <span class="n">scaffold_weights</span><span class="p">[</span><span class="n">place_holder</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">scaffold_level_parse</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">ii</span><span class="o">**</span><span class="n">level_exponent</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>                <span class="n">place_holder</span> <span class="o">+=</span> <span class="n">scaffold_level_parse</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_scaffold_level_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                <span class="n">scaffold_weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="c1"># END ReadoutLayer._set_scaffold_reg()</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="k">def</span> <span class="nf">compute_reg_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">        Compute the regularization loss for the layer: superceding super, by calling reg_module to do</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="sd">        this and then adding scaffold weight regularization if needed.</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">        Args:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">            None</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        Returns:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">            reg_loss: torch.Tensor, regularization loss</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_weights</span><span class="p">()</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="n">regloss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">compute_reg_loss</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="n">regloss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaffold_level_weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="p">)</span> 
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="k">return</span> <span class="n">regloss</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="c1"># ReadoutLayer.compute_reg_loss()</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        Propagates the input forwards through the readout.</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        </span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        Args:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">            x: input data</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">        Returns:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="n">c_in</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="n">h_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">c_in</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="n">h_in</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>  <span class="c1"># this is the filter weights for each unit</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>    <span class="c1"># END ReadoutLayer.forward</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="k">def</span> <span class="nf">set_readout_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">):</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        This hasn&#39;t been tested yet, but should be self-explanatory.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        </span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">        Args:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">            locs: locations of the readout units</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="n">NC</span><span class="p">,</span> <span class="n">num_dim</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="k">assert</span> <span class="n">num_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of spatial dimensions&#39;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="k">assert</span> <span class="n">NC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of neuron positions.&#39;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>    <span class="k">def</span> <span class="nf">get_readout_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">        Currently returns center location and sigmas, as list.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">        </span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">        Returns:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">            mu: center locations of the readout units</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">            sigma: sigmas of the readout units</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>    
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>    <span class="k">def</span> <span class="nf">passive_readout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">        This will not fit mu and std, but set them to zero. It will pass identities in,</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        so number of input filters must equal number of readout units.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">        </span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="sd">        Args:</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">            None</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">        Returns:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">            None</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Must have #filters = #output units.&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="c1"># Set parameters for default readout</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">):</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    <span class="k">def</span> <span class="nf">fit_mus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        Quick function that turns on or off fitting mus/sigmas and toggles sample</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        </span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        Args:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">            val (bool): True or False -- must specify</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">            sigma (float): choose starting sigma value (default no choice)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fit_mus(): must set val to be True or False&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: fitting mus&quot;</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: not fitting mus&quot;</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    <span class="c1"># END ReadoutLayer.fit_mus()</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>    <span class="k">def</span> <span class="nf">enforce_grid</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        Function that adjusts mus to correspond to precise points on pixel grid</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        </span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">        Args:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">            None</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">pixels</span><span class="p">[</span><span class="n">pixels</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">pixels</span><span class="p">[</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        <span class="c1"># Convert back to mu values</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pixels</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>    <span class="c1"># END ReadoutLayer.enforce_grid()</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>    <span class="k">def</span> <span class="nf">_layer_abbrev</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="k">return</span> <span class="s2">&quot; readout&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        Args:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">            NLtype: str, type of nonlinearity</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">        Returns:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readout&#39;</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="c1"># Added arguments</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_mu_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;gauss_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span> <span class="c1">#&#39;uncorrelated&#39;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;align_corners&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># also &#39;nearest&#39;</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="c1"># Change default -- readouts will usually be softplus</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;NLtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NLtype</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>    <span class="c1"># END [classmethod] ReadoutLayer.layer_dict</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="k">class</span> <span class="nc">ReadoutLayer3d</span><span class="p">(</span><span class="n">ReadoutLayer</span><span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">    ReadoutLayer3d for 3d readout.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">    This is a subclass of ReadoutLayer, but with the added dimension of time.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">        ReadoutLayer3d: 3d readout layer for NDNs.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        Args:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, depth, lags)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="k">assert</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer3d: should not be using this layer if no 3rd dimension of input&quot;</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="c1"># Need to tuck lag dimension into channel-dims so parent constructor makes the right filter shape</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="n">input_dims_mod</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="n">input_dims_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="n">input_dims_mod</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>                
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims_mod</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="c1">#print(&#39;OLD FILTER DIMS&#39;, self.filter_dims)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="c1">#self.filter_dims = [input_dims[0], input_dims[3], 1, 1]  # making spatial so max_space can be used</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="c1">#print(&#39;NEW FILTER DIMS&#39;, self.filter_dims)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="c1"># Redo regularization with new filter_dims</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>      
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>        <span class="kn">from</span> <span class="nn">...modules.regularization</span> <span class="kn">import</span> <span class="n">Regularization</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">Regularization</span><span class="p">(</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="n">reg_vals</span><span class="p">,</span> 
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="n">num_outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span> <span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>    <span class="c1"># END ReadoutLayer3d.__init__</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="k">def</span> <span class="nf">set_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        Sets mask -- instead of plugging in by hand. Registers mask as being set, and checks dimensions.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">        Can also use to rest to have trivial mask (all 1s)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        Mask will be numpy, leave mask blank if want to set to default mask (all ones)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">        </span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        Args:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">            mask: numpy array of size of filters (filter_dims x num_filters)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>    <span class="c1"># END MaskLayer.set_mask()</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>    
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">        Propagates the input forwards through the readout</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        Args:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">            x: input data</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">        Returns:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>  <span class="c1"># 3d change -- has extra dimension at end</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="n">c</span> <span class="o">*=</span> <span class="n">T</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="c1"># get those last filter dims up before spatial</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span> 
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="c1">#c_in, w_in, h_in = self.input_dims[:3]</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="c1">#if (c_in, w_in, h_in) != (c, w, h):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="c1">#    raise ValueError(&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="c1"># this is the filter weights for each unit</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>  <span class="c1"># 3d change -- this is num_chan x num_angles now</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>    <span class="c1"># END ReadoutLayer3d.forward</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    <span class="k">def</span> <span class="nf">passive_readout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">        This might have to be redone for readout3d to take into account extra filter dim.</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: SCAF3d: this function is not vetted and likely will clunk&quot;</span><span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Must have #filters = #output units.&quot;</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="c1"># Set parameters for default readout</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">):</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>    <span class="k">def</span> <span class="nf">_layer_abbrev</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="k">return</span> <span class="s2">&quot;readout3&quot;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">        Args:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">            None</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        Returns:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readout3d&#39;</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>    <span class="c1"># END [classmethod] ReadoutLayer3d.layer_dict</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="k">class</span> <span class="nc">FixationLayer</span><span class="p">(</span><span class="n">NDNLayer</span><span class="p">):</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">    FixationLayer for fixation.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            <span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="c1">#input_dims=None,  # this has to be set to [1,1,1,1] by default</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>            <span class="n">batch_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="n">fix_n_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="c1">#init_mu_range=0.1,</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>            <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="n">single_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>            <span class="c1">#gauss_type: str=&#39;uncorrelated&#39;, # &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>            <span class="c1">#align_corners=False,</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">        Layer weights become the shift for each fixation, sigma is constant over each dimension.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        </span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">        Args:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">            num_fixations: int, number of fixations</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">            num_spatial_dims: int, number of spatial dimensions</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">            batch_sample: bool, whether to sample grid locations separately per sample per batch</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">            fix_n_index: bool, whether to index fixations starting at 1</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">            single_sigma: bool, whether to use a single sigma for all fixations</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">            bias: bool, whether to include bias term</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">            NLtype: str, type of nonlinearity</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="c1">#self.num_fixations = layer_params[&#39;input_dims&#39;][0]</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="c1">#assert np.prod(input_dims[1:]) == 1, &#39;something wrong with fix-layer input_dims&#39;</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="k">assert</span> <span class="n">num_fixations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;FIX LAYER: Must set number of fixations&quot;</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="k">assert</span> <span class="n">num_spatial_dims</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;FIX LAYER: num_space must be set to spatial dimensionality (1 or 2)&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">bias</span><span class="p">,</span> <span class="s2">&quot;FIX LAYER: cannot have bias term&quot;</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="n">num_filters</span> <span class="o">=</span> <span class="n">num_spatial_dims</span><span class="p">,</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_fixations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="n">NLtype</span> <span class="o">=</span> <span class="n">NLtype</span><span class="p">,</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="c1"># Determine whether one- or two-dimensional readout</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span> <span class="o">=</span> <span class="n">num_spatial_dims</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span> <span class="o">=</span> <span class="n">num_fixations</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span> <span class="o">=</span> <span class="n">batch_sample</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span> <span class="o">=</span> <span class="n">single_sigma</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n_index</span> <span class="o">=</span> <span class="n">fix_n_index</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="c1"># shared sigmas across all fixations</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">))</span> 
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="c1"># individual sigmas for each fixation </span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span><span class="p">)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>    <span class="c1"># END FixationLayer.__init__</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">        The input is the sampled fixation-stim</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        </span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">        Args:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">            x: input data</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        Returns:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="c1"># with torch.no_grad():</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="c1"># self.weight.clamp(min=-1, max=1)  # at eval time, only self.mu is used so it must belong to [-1,1]</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="c1"># self.sigmas.clamp(min=0)  # sigma/variance is always a positive quantity</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># batch size</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>        <span class="c1"># If using X-matrix to extract relevant weights</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="c1"># y = (x@self.weight) </span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="c1"># use indexing: x is just a list of weight indices</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="c1"># In case x gets passed in with trivial second dim (squeeze)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  WARNING: fixations should not have second dimension -- squeeze it&#39;</span><span class="p">)</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="c1"># Actual fixations labeled 1-NFIX</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="c1"># Will make by default fixation label &#39;0&#39; lead to no shift</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="n">shift_array</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">shift_array</span><span class="p">[</span><span class="n">x</span><span class="p">,:])</span>   <span class="c1"># fix_n</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="c1">#s = self.sigmas**2</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> 
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="c1">#s = self.sigmas[x]**2</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="n">sigma_array</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">sigma_array</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="c1"># this will be batch-size x num_spatial dims (corresponding to mean loc)        </span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>  <span class="c1"># can turn off sampling, even with training</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                <span class="c1"># add sigma-like noise around mean locations</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                    <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">,)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                    <span class="n">gaus_sample</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">sample_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                    <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">,)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                    <span class="n">gaus_sample</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">sample_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaus_sample</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>    <span class="c1"># END FixationLayer.forward</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>    
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        This will initialize the layer parameters.</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;initialize is not implemented for &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        Args:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">            num_fixations: int, number of fixations</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">            num_spatial_dims: int, number of spatial dimensions</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">        Returns:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="k">if</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;FIX DICT: Set filter_dims to #fixations and leave input_dims alone&quot;</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixation&#39;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="c1"># delete standard layer info for purposes of constructor</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">]</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="c1"># Added arguments</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;fix_n_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_mu_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;single_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;gauss_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;uncorrelated&#39;</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;align_corners&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_fixations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_fixations</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_spatial_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>    <span class="c1"># END [classmethod] FixatonLayer.layer_dict</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="k">class</span> <span class="nc">ReadoutLayerQsample</span><span class="p">(</span><span class="n">ReadoutLayer3d</span><span class="p">):</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">    ReadoutLayerQsample for 3d readout with sampling over angle dimension Q.</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">    This is a subclass of ReadoutLayer3d.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_Qsample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_Qsigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Qsample_mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        ReadoutLayerQsample: 3d readout layer for NDNs.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        Args:</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">            filter_dims: tuple or list of ints, (num_channels, height, width, depth, lags)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">            batch_Qample: bool, whether to sample Qgrid locations separately per sample per batch</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">            Qsample_mode: str, &#39;bilinear&#39; or &#39;nearest&#39;</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify input_dims&quot;</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="c1"># Make sure filter_dims is filled in, and to single the spatial filter dimensions</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="k">if</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="n">filter_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cant handle temporal filter dims here, yet.&#39;</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="n">filter_dims</span><span class="p">,</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_Qsample</span> <span class="o">=</span> <span class="n">batch_Qsample</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample_mode</span> <span class="o">=</span> <span class="n">Qsample_mode</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span> <span class="o">=</span> <span class="n">init_Qsigma</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;init_Qsigma is non-positive&quot;</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qgrid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span><span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>    <span class="c1"># END ReadoutLayerQsample.__init__</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>    <span class="k">def</span> <span class="nf">sample_Qgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">        Returns the chosen angle (Q) from the core by sampling from a Gaussian distribution</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">        More specifically, it returns sampled angle for each batch over all elements, given Qmus and Qsigmas</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">        Also implements wrap around for Qmus so edge mus get mapped back to first angle</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">        If &#39;Qsample&#39; is false, it just gives mu back (so testing has no randomness)</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        This code is inherited and then modified, so different style than most other</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        Args:</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">            batch_size (int): size of the batch</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">            Qsample (bool/None): sample determines whether we draw a sample from Gaussian distribution, N(Qmu,Qsigma), defined per neuron</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">                            or use the mean, Qmu, of the Gaussian distribution without sampling.</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">                           if Qsample is None (default), samples from the N(Qmu,Qsigma) during training phase and</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">                             fixes to the mean, Qmu, during evaluation phase.</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">                           if Qsample is True/False, overrides the model_state (i.e training or eval) and does as instructed</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="n">Qgrid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qgrid_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="n">Qsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">if</span> <span class="n">Qsample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Qsample</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">if</span> <span class="n">Qsample</span><span class="p">:</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">Qgrid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">Qgrid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="c1"># posision for sampling cells</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="n">cell_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="n">cell_pos</span> <span class="o">=</span> <span class="n">cell_pos</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">out_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">Qgrid_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="c1">## SEEMS dim-4 HAS TO BE IN THE SECOND DIMENSION (RATHER THAN FIRST)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="n">out_norm</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_pos</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>        <span class="n">mu_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># scal mu values to account for circular padding</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="c1">#mu_scale = 1</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="n">out_norm</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_scale</span><span class="o">*</span><span class="p">(((</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># wraps around</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="k">return</span> <span class="n">out_norm</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>    <span class="k">def</span> <span class="nf">fit_Qmus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Qsigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">        Quick function that turns on or off fitting Qmus/Qsigmas and toggles sample</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">        </span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        Args:</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">            val (bool): True or False -- must specify</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">            Qsigma (float): choose starting Qsigma value (default no choice)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fit_mus(): must set val to be True or False&quot;</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qmu&#39;</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qsigma&#39;</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="k">if</span> <span class="n">Qsigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">Qsigma</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: fitting Qmus&quot;</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: not fitting Qmus&quot;</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">        Propagates the input forwards through the readout</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">        Args:</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">            x: input data</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        Returns:</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">            z: neuronal activity</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>  <span class="c1"># 3d change -- has extra dimension at end</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="n">c</span> <span class="o">*=</span> <span class="n">T</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="c1"># get those last filter dims up before spatial</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="c1">#c_in, w_in, h_in = self.input_dims[:3]</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="c1">#if (c_in, w_in, h_in) != (c, w, h):</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="c1">#    raise ValueError(&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="c1"># this is the filter weights for each unit</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>  <span class="c1"># 3d change -- this is num_chan x num_angles now</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>        
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="c1"># Might have to do sample per cell (i.e. for loop)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_Qsample</span><span class="p">:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>            <span class="n">Qgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Qgrid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="n">Qgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Qgrid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="n">y_pad</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;circular&#39;</span><span class="p">)</span> <span class="c1"># circular padding for angle dim)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="c1"># reduce grid sample for angle</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">y_pad</span><span class="p">,</span> <span class="n">Qgrid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="c1"># reduce grid sample for angle</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="c1">#z = torch.zeros((N,self.input_dims[0],self.num_filters,1), dtype=torch.float32, device=self.weight.device)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="c1">#for i in range(self.num_filters):</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="c1">#    y_i = y[:,:,i,:].reshape(N,self.input_dims[0],self.input_dims[3],1)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="c1">#    Qgrid_i = Qgrid[:,i,:,:].reshape(N,1,1,2)</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="c1">#    z_i = F.grid_sample(y_i, Qgrid_i, mode=self.Qsample_mode, align_corners=self.align_corners, padding_mode=&#39;border&#39;)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="c1">#    z[:,:,i,:] = z_i.reshape(N,self.input_dims[0],1)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="c1">#z = (z.squeeze(-1)).sum(1).view(N, outdims) # for testing only</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="k">return</span> <span class="n">z</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>    <span class="c1"># END ReadoutLayer3d.forward</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>    <span class="k">def</span> <span class="nf">degrees2mu</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">theta_deg</span><span class="p">,</span> <span class="n">to_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span> <span class="p">):</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">        Converts degrees into mu-values. If to_output=True, outputs to an array, and otherwise</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        stores in the Qmu variable. It detects whether half-circle of full circle using stored angle values</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        </span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        Args:</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">            theta_deg (np array): array of angles in degrees into mu values, based on 180 or 360 deg wrap-around</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">            to_output (Boolean): whether to output to variable or store internally as Qmu (default: False, is the latter)</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">            continuous (Boolean): whether to convert to continuous angle or closest &quot;integer&quot; mu value (def True, continuous)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">            max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        Returns:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">            Qmus: as numpy-array, if to_output is set to True, otherwise, nothing </span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="n">num_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="c1"># convert inputs to np.array</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theta_deg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>            <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta_deg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">continuous</span><span class="p">:</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>            <span class="n">dQ</span> <span class="o">=</span> <span class="n">max_angle</span><span class="o">/</span><span class="n">num_angles</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>            <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">dQ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">theta_deg</span><span class="o">/</span><span class="n">dQ</span><span class="p">)</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">theta_deg</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_deg</span><span class="o">%</span><span class="n">max_angle</span><span class="p">)</span>  <span class="c1"># map between 0 and max_angle</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="n">mu_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_angles</span> <span class="c1"># first bin at 0 degrees is actually a shifted mu value (not right at edge)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="n">Qmus</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_deg</span><span class="o">-</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">mu_offset</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="n">Qmus</span><span class="p">[</span><span class="n">Qmus</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">Qmus</span><span class="p">[</span><span class="n">Qmus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>        <span class="k">if</span> <span class="n">to_output</span><span class="p">:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="k">return</span> <span class="n">Qmus</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Qmus</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;incorrect number of angles input </span><span class="si">%d</span><span class="s2"> neq </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qmus</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">Qmus</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>    <span class="c1"># END ReadoutLayerQsample.degrees2mu()</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    <span class="k">def</span> <span class="nf">mu2degrees</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span> <span class="p">):</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">        Converts Qmu-values into degrees. Automatically reads from Qmu variable, and outputs a numpy array</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        It detects whether half-circle of full circle using stored angle values</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        </span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        Args:     </span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">            Qmus: if dont want to read from layer, pass in values directly (default None, using self.Qmu)       </span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">            max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        Returns:</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">            thetas: angles in degrees (between 0 to max_angle)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="n">num_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="n">mu</span> <span class="o">+=</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_angles</span> <span class="c1"># first bin at 0 degrees is actually a shifted mu value (not right at edge)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">thetas</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span> <span class="o">%</span> <span class="n">max_angle</span> 
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="k">return</span> <span class="n">thetas</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="c1"># END ReadoutLayerQsample.mu2degrees()</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="k">def</span> <span class="nf">_layer_abbrev</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="k">return</span> <span class="s2">&quot;readQsmp&quot;</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Qsigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">        Args:</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">            None</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">        Returns:</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readoutQ&#39;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_Qample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_Qsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;Qsample_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>    <span class="c1"># END [classmethod] ReadoutLayer3d.layer_dict</span>
</span></pre></div>


            </section>
                <section id="ReadoutLayer">
                            <input id="ReadoutLayer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ReadoutLayer</span><wbr>(<span class="base"><a href="ndnlayer.html#NDNLayer">NDNT.modules.layers.ndnlayer.NDNLayer</a></span>):

                <label class="view-source-button" for="ReadoutLayer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer-11"><a href="#ReadoutLayer-11"><span class="linenos"> 11</span></a><span class="k">class</span> <span class="nc">ReadoutLayer</span><span class="p">(</span><span class="n">NDNLayer</span><span class="p">):</span>
</span><span id="ReadoutLayer-12"><a href="#ReadoutLayer-12"><span class="linenos"> 12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-13"><a href="#ReadoutLayer-13"><span class="linenos"> 13</span></a><span class="sd">    ReadoutLayer for spatial readout.</span>
</span><span id="ReadoutLayer-14"><a href="#ReadoutLayer-14"><span class="linenos"> 14</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-15"><a href="#ReadoutLayer-15"><span class="linenos"> 15</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="ReadoutLayer-16"><a href="#ReadoutLayer-16"><span class="linenos"> 16</span></a>            <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ReadoutLayer-17"><a href="#ReadoutLayer-17"><span class="linenos"> 17</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ReadoutLayer-18"><a href="#ReadoutLayer-18"><span class="linenos"> 18</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="ReadoutLayer-19"><a href="#ReadoutLayer-19"><span class="linenos"> 19</span></a>            <span class="n">batch_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ReadoutLayer-20"><a href="#ReadoutLayer-20"><span class="linenos"> 20</span></a>            <span class="n">init_mu_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="ReadoutLayer-21"><a href="#ReadoutLayer-21"><span class="linenos"> 21</span></a>            <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="ReadoutLayer-22"><a href="#ReadoutLayer-22"><span class="linenos"> 22</span></a>            <span class="n">gauss_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;isotropic&#39;</span><span class="p">,</span> <span class="c1"># &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="ReadoutLayer-23"><a href="#ReadoutLayer-23"><span class="linenos"> 23</span></a>            <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ReadoutLayer-24"><a href="#ReadoutLayer-24"><span class="linenos"> 24</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span>  <span class="c1"># &#39;nearest&#39; is also possible</span>
</span><span id="ReadoutLayer-25"><a href="#ReadoutLayer-25"><span class="linenos"> 25</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer-26"><a href="#ReadoutLayer-26"><span class="linenos"> 26</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-27"><a href="#ReadoutLayer-27"><span class="linenos"> 27</span></a><span class="sd">        ReadoutLayer: Spatial readout layer for NDNs.</span>
</span><span id="ReadoutLayer-28"><a href="#ReadoutLayer-28"><span class="linenos"> 28</span></a>
</span><span id="ReadoutLayer-29"><a href="#ReadoutLayer-29"><span class="linenos"> 29</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-30"><a href="#ReadoutLayer-30"><span class="linenos"> 30</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="ReadoutLayer-31"><a href="#ReadoutLayer-31"><span class="linenos"> 31</span></a><span class="sd">            num_filters: number of output filters</span>
</span><span id="ReadoutLayer-32"><a href="#ReadoutLayer-32"><span class="linenos"> 32</span></a><span class="sd">            filter_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="ReadoutLayer-33"><a href="#ReadoutLayer-33"><span class="linenos"> 33</span></a><span class="sd">            batch_sample: bool, whether to sample grid locations separately per sample per batch</span>
</span><span id="ReadoutLayer-34"><a href="#ReadoutLayer-34"><span class="linenos"> 34</span></a><span class="sd">            init_mu_range: float, range for uniform initialization of means</span>
</span><span id="ReadoutLayer-35"><a href="#ReadoutLayer-35"><span class="linenos"> 35</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="ReadoutLayer-36"><a href="#ReadoutLayer-36"><span class="linenos"> 36</span></a><span class="sd">            gauss_type: str, &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="ReadoutLayer-37"><a href="#ReadoutLayer-37"><span class="linenos"> 37</span></a><span class="sd">            align_corners: bool, whether to align corners in grid_sample</span>
</span><span id="ReadoutLayer-38"><a href="#ReadoutLayer-38"><span class="linenos"> 38</span></a><span class="sd">            mode: str, &#39;bilinear&#39; or &#39;nearest&#39;</span>
</span><span id="ReadoutLayer-39"><a href="#ReadoutLayer-39"><span class="linenos"> 39</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-40"><a href="#ReadoutLayer-40"><span class="linenos"> 40</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify input_dims&quot;</span>
</span><span id="ReadoutLayer-41"><a href="#ReadoutLayer-41"><span class="linenos"> 41</span></a>        <span class="k">assert</span> <span class="n">num_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify num_filters&quot;</span>
</span><span id="ReadoutLayer-42"><a href="#ReadoutLayer-42"><span class="linenos"> 42</span></a>
</span><span id="ReadoutLayer-43"><a href="#ReadoutLayer-43"><span class="linenos"> 43</span></a>        <span class="c1"># Make sure filter_dims is filled in, and to single the spatial filter dimensions</span>
</span><span id="ReadoutLayer-44"><a href="#ReadoutLayer-44"><span class="linenos"> 44</span></a>        <span class="k">if</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-45"><a href="#ReadoutLayer-45"><span class="linenos"> 45</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer-46"><a href="#ReadoutLayer-46"><span class="linenos"> 46</span></a>        
</span><span id="ReadoutLayer-47"><a href="#ReadoutLayer-47"><span class="linenos"> 47</span></a>        <span class="n">filter_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayer-48"><a href="#ReadoutLayer-48"><span class="linenos"> 48</span></a>        
</span><span id="ReadoutLayer-49"><a href="#ReadoutLayer-49"><span class="linenos"> 49</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cant handle temporal filter dims here, yet.&#39;</span>
</span><span id="ReadoutLayer-50"><a href="#ReadoutLayer-50"><span class="linenos"> 50</span></a>        
</span><span id="ReadoutLayer-51"><a href="#ReadoutLayer-51"><span class="linenos"> 51</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="p">,</span>
</span><span id="ReadoutLayer-52"><a href="#ReadoutLayer-52"><span class="linenos"> 52</span></a>            <span class="n">num_filters</span><span class="p">,</span>
</span><span id="ReadoutLayer-53"><a href="#ReadoutLayer-53"><span class="linenos"> 53</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="n">filter_dims</span><span class="p">,</span>
</span><span id="ReadoutLayer-54"><a href="#ReadoutLayer-54"><span class="linenos"> 54</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer-55"><a href="#ReadoutLayer-55"><span class="linenos"> 55</span></a>        
</span><span id="ReadoutLayer-56"><a href="#ReadoutLayer-56"><span class="linenos"> 56</span></a>        <span class="c1"># Determine whether one- or two-dimensional readout</span>
</span><span id="ReadoutLayer-57"><a href="#ReadoutLayer-57"><span class="linenos"> 57</span></a>        <span class="k">if</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer-58"><a href="#ReadoutLayer-58"><span class="linenos"> 58</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer-59"><a href="#ReadoutLayer-59"><span class="linenos"> 59</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-60"><a href="#ReadoutLayer-60"><span class="linenos"> 60</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="ReadoutLayer-61"><a href="#ReadoutLayer-61"><span class="linenos"> 61</span></a>
</span><span id="ReadoutLayer-62"><a href="#ReadoutLayer-62"><span class="linenos"> 62</span></a>        <span class="c1"># Additional readout parameters (below)</span>
</span><span id="ReadoutLayer-63"><a href="#ReadoutLayer-63"><span class="linenos"> 63</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="ReadoutLayer-64"><a href="#ReadoutLayer-64"><span class="linenos"> 64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;minval&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</span><span id="ReadoutLayer-65"><a href="#ReadoutLayer-65"><span class="linenos"> 65</span></a>            <span class="c1"># Does this apply to both weights and biases? Should be separate?</span>
</span><span id="ReadoutLayer-66"><a href="#ReadoutLayer-66"><span class="linenos"> 66</span></a>
</span><span id="ReadoutLayer-67"><a href="#ReadoutLayer-67"><span class="linenos"> 67</span></a>        <span class="c1"># self.flatten = nn.Flatten()</span>
</span><span id="ReadoutLayer-68"><a href="#ReadoutLayer-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span> <span class="o">=</span> <span class="n">batch_sample</span>
</span><span id="ReadoutLayer-69"><a href="#ReadoutLayer-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span> <span class="o">=</span> <span class="n">mode</span>
</span><span id="ReadoutLayer-70"><a href="#ReadoutLayer-70"><span class="linenos"> 70</span></a>
</span><span id="ReadoutLayer-71"><a href="#ReadoutLayer-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">=</span> <span class="n">init_mu_range</span>
</span><span id="ReadoutLayer-72"><a href="#ReadoutLayer-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="ReadoutLayer-73"><a href="#ReadoutLayer-73"><span class="linenos"> 73</span></a>
</span><span id="ReadoutLayer-74"><a href="#ReadoutLayer-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="ReadoutLayer-75"><a href="#ReadoutLayer-75"><span class="linenos"> 75</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;either init_mu_range doesn&#39;t belong to [0.0, 1.0] or init_sigma_range is non-positive&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer-76"><a href="#ReadoutLayer-76"><span class="linenos"> 76</span></a>        
</span><span id="ReadoutLayer-77"><a href="#ReadoutLayer-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer-78"><a href="#ReadoutLayer-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span>  <span class="c1"># only 1-d to sample sigma in</span>
</span><span id="ReadoutLayer-79"><a href="#ReadoutLayer-79"><span class="linenos"> 79</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-80"><a href="#ReadoutLayer-80"><span class="linenos"> 80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">=</span> <span class="n">gauss_type</span>
</span><span id="ReadoutLayer-81"><a href="#ReadoutLayer-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span> <span class="o">=</span> <span class="n">align_corners</span>
</span><span id="ReadoutLayer-82"><a href="#ReadoutLayer-82"><span class="linenos"> 82</span></a>
</span><span id="ReadoutLayer-83"><a href="#ReadoutLayer-83"><span class="linenos"> 83</span></a>        <span class="c1"># position grid shape</span>
</span><span id="ReadoutLayer-84"><a href="#ReadoutLayer-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer-85"><a href="#ReadoutLayer-85"><span class="linenos"> 85</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer-86"><a href="#ReadoutLayer-86"><span class="linenos"> 86</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 2, 2)</span>
</span><span id="ReadoutLayer-87"><a href="#ReadoutLayer-87"><span class="linenos"> 87</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayer-88"><a href="#ReadoutLayer-88"><span class="linenos"> 88</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;uncorrelated&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer-89"><a href="#ReadoutLayer-89"><span class="linenos"> 89</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 1, 2)</span>
</span><span id="ReadoutLayer-90"><a href="#ReadoutLayer-90"><span class="linenos"> 90</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayer-91"><a href="#ReadoutLayer-91"><span class="linenos"> 91</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;isotropic&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer-92"><a href="#ReadoutLayer-92"><span class="linenos"> 92</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 1, 1)</span>
</span><span id="ReadoutLayer-93"><a href="#ReadoutLayer-93"><span class="linenos"> 93</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayer-94"><a href="#ReadoutLayer-94"><span class="linenos"> 94</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-95"><a href="#ReadoutLayer-95"><span class="linenos"> 95</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gauss_type &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span><span class="si">}</span><span class="s1">&quot; not known&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer-96"><a href="#ReadoutLayer-96"><span class="linenos"> 96</span></a>
</span><span id="ReadoutLayer-97"><a href="#ReadoutLayer-97"><span class="linenos"> 97</span></a>        <span class="c1"># initialize means and spreads</span>
</span><span id="ReadoutLayer-98"><a href="#ReadoutLayer-98"><span class="linenos"> 98</span></a>        <span class="n">map_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer-99"><a href="#ReadoutLayer-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">*</span><span class="n">map_size</span><span class="p">))</span>
</span><span id="ReadoutLayer-100"><a href="#ReadoutLayer-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span><span class="p">))</span>
</span><span id="ReadoutLayer-101"><a href="#ReadoutLayer-101"><span class="linenos">101</span></a>
</span><span id="ReadoutLayer-102"><a href="#ReadoutLayer-102"><span class="linenos">102</span></a>        <span class="c1"># For use with scaffold_level_regularization</span>
</span><span id="ReadoutLayer-103"><a href="#ReadoutLayer-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer-104"><a href="#ReadoutLayer-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># just so info is available</span>
</span><span id="ReadoutLayer-105"><a href="#ReadoutLayer-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_scaffold_level_weights&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span><span id="ReadoutLayer-106"><a href="#ReadoutLayer-106"><span class="linenos">106</span></a>
</span><span id="ReadoutLayer-107"><a href="#ReadoutLayer-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_spatial_mapping</span><span class="p">()</span>
</span><span id="ReadoutLayer-108"><a href="#ReadoutLayer-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer-109"><a href="#ReadoutLayer-109"><span class="linenos">109</span></a>
</span><span id="ReadoutLayer-110"><a href="#ReadoutLayer-110"><span class="linenos">110</span></a>    <span class="c1"># END ReadoutLayer.__init__</span>
</span><span id="ReadoutLayer-111"><a href="#ReadoutLayer-111"><span class="linenos">111</span></a>
</span><span id="ReadoutLayer-112"><a href="#ReadoutLayer-112"><span class="linenos">112</span></a>    <span class="nd">@property</span>
</span><span id="ReadoutLayer-113"><a href="#ReadoutLayer-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer-114"><a href="#ReadoutLayer-114"><span class="linenos">114</span></a>
</span><span id="ReadoutLayer-115"><a href="#ReadoutLayer-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="ReadoutLayer-116"><a href="#ReadoutLayer-116"><span class="linenos">116</span></a>            <span class="c1">#feat = F.relu(self.weight)</span>
</span><span id="ReadoutLayer-117"><a href="#ReadoutLayer-117"><span class="linenos">117</span></a>            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">**</span><span class="mi">2</span>
</span><span id="ReadoutLayer-118"><a href="#ReadoutLayer-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-119"><a href="#ReadoutLayer-119"><span class="linenos">119</span></a>            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
</span><span id="ReadoutLayer-120"><a href="#ReadoutLayer-120"><span class="linenos">120</span></a>        
</span><span id="ReadoutLayer-121"><a href="#ReadoutLayer-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="n">feat</span>
</span><span id="ReadoutLayer-122"><a href="#ReadoutLayer-122"><span class="linenos">122</span></a>
</span><span id="ReadoutLayer-123"><a href="#ReadoutLayer-123"><span class="linenos">123</span></a>    <span class="nd">@property</span>
</span><span id="ReadoutLayer-124"><a href="#ReadoutLayer-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer-125"><a href="#ReadoutLayer-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ReadoutLayer-126"><a href="#ReadoutLayer-126"><span class="linenos">126</span></a>
</span><span id="ReadoutLayer-127"><a href="#ReadoutLayer-127"><span class="linenos">127</span></a>    <span class="c1">#@property</span>
</span><span id="ReadoutLayer-128"><a href="#ReadoutLayer-128"><span class="linenos">128</span></a>    <span class="c1">#def mu(self):</span>
</span><span id="ReadoutLayer-129"><a href="#ReadoutLayer-129"><span class="linenos">129</span></a>    <span class="c1">#    return self.mu</span>
</span><span id="ReadoutLayer-130"><a href="#ReadoutLayer-130"><span class="linenos">130</span></a>
</span><span id="ReadoutLayer-131"><a href="#ReadoutLayer-131"><span class="linenos">131</span></a>    <span class="k">def</span> <span class="nf">initialize_spatial_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer-132"><a href="#ReadoutLayer-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-133"><a href="#ReadoutLayer-133"><span class="linenos">133</span></a><span class="sd">        Initializes the mean, and sigma of the Gaussian readout.</span>
</span><span id="ReadoutLayer-134"><a href="#ReadoutLayer-134"><span class="linenos">134</span></a>
</span><span id="ReadoutLayer-135"><a href="#ReadoutLayer-135"><span class="linenos">135</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-136"><a href="#ReadoutLayer-136"><span class="linenos">136</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer-137"><a href="#ReadoutLayer-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-138"><a href="#ReadoutLayer-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span><span class="p">)</span>  <span class="c1"># random initializations uniformly spread....</span>
</span><span id="ReadoutLayer-139"><a href="#ReadoutLayer-139"><span class="linenos">139</span></a>        <span class="c1"># if self.gauss_type != &#39;full&#39;:</span>
</span><span id="ReadoutLayer-140"><a href="#ReadoutLayer-140"><span class="linenos">140</span></a>        <span class="c1">#     self.sigma.data.fill_(self.init_sigma)</span>
</span><span id="ReadoutLayer-141"><a href="#ReadoutLayer-141"><span class="linenos">141</span></a>        <span class="c1"># else:</span>
</span><span id="ReadoutLayer-142"><a href="#ReadoutLayer-142"><span class="linenos">142</span></a>        <span class="c1">#self.sigma.data.uniform_(0, self.init_sigma)</span>
</span><span id="ReadoutLayer-143"><a href="#ReadoutLayer-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span><span class="p">)</span>
</span><span id="ReadoutLayer-144"><a href="#ReadoutLayer-144"><span class="linenos">144</span></a>        
</span><span id="ReadoutLayer-145"><a href="#ReadoutLayer-145"><span class="linenos">145</span></a>        <span class="c1">#self.weight.data.fill_(1 / self.input_dims[0])</span>
</span><span id="ReadoutLayer-146"><a href="#ReadoutLayer-146"><span class="linenos">146</span></a>
</span><span id="ReadoutLayer-147"><a href="#ReadoutLayer-147"><span class="linenos">147</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-148"><a href="#ReadoutLayer-148"><span class="linenos">148</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer-149"><a href="#ReadoutLayer-149"><span class="linenos">149</span></a>
</span><span id="ReadoutLayer-150"><a href="#ReadoutLayer-150"><span class="linenos">150</span></a>    <span class="k">def</span> <span class="nf">sample_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer-151"><a href="#ReadoutLayer-151"><span class="linenos">151</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-152"><a href="#ReadoutLayer-152"><span class="linenos">152</span></a><span class="sd">        Returns the grid locations from the core by sampling from a Gaussian distribution</span>
</span><span id="ReadoutLayer-153"><a href="#ReadoutLayer-153"><span class="linenos">153</span></a><span class="sd">        More specifically, it returns sampled positions for each batch over all elements, given mus and sigmas</span>
</span><span id="ReadoutLayer-154"><a href="#ReadoutLayer-154"><span class="linenos">154</span></a><span class="sd">        If &#39;sample&#39; is false, it just gives mu back (so testing has no randomness)</span>
</span><span id="ReadoutLayer-155"><a href="#ReadoutLayer-155"><span class="linenos">155</span></a><span class="sd">        This code is inherited and then modified, so different style than most other</span>
</span><span id="ReadoutLayer-156"><a href="#ReadoutLayer-156"><span class="linenos">156</span></a>
</span><span id="ReadoutLayer-157"><a href="#ReadoutLayer-157"><span class="linenos">157</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-158"><a href="#ReadoutLayer-158"><span class="linenos">158</span></a><span class="sd">            batch_size (int): size of the batch</span>
</span><span id="ReadoutLayer-159"><a href="#ReadoutLayer-159"><span class="linenos">159</span></a><span class="sd">            sample (bool/None): sample determines whether we draw a sample from Gaussian distribution, N(mu,sigma), defined per neuron</span>
</span><span id="ReadoutLayer-160"><a href="#ReadoutLayer-160"><span class="linenos">160</span></a><span class="sd">                            or use the mean, mu, of the Gaussian distribution without sampling.</span>
</span><span id="ReadoutLayer-161"><a href="#ReadoutLayer-161"><span class="linenos">161</span></a><span class="sd">                           if sample is None (default), samples from the N(mu,sigma) during training phase and</span>
</span><span id="ReadoutLayer-162"><a href="#ReadoutLayer-162"><span class="linenos">162</span></a><span class="sd">                             fixes to the mean, mu, during evaluation phase.</span>
</span><span id="ReadoutLayer-163"><a href="#ReadoutLayer-163"><span class="linenos">163</span></a><span class="sd">                           if sample is True/False, overrides the model_state (i.e training or eval) and does as instructed</span>
</span><span id="ReadoutLayer-164"><a href="#ReadoutLayer-164"><span class="linenos">164</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-165"><a href="#ReadoutLayer-165"><span class="linenos">165</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="ReadoutLayer-166"><a href="#ReadoutLayer-166"><span class="linenos">166</span></a>            <span class="c1">#self.mu.clamp(min=-1, max=1)  # at eval time, only self.mu is used so it must belong to [-1,1]</span>
</span><span id="ReadoutLayer-167"><a href="#ReadoutLayer-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">!=</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer-168"><a href="#ReadoutLayer-168"><span class="linenos">168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sigma/variance is always a positive quantity</span>
</span><span id="ReadoutLayer-169"><a href="#ReadoutLayer-169"><span class="linenos">169</span></a>
</span><span id="ReadoutLayer-170"><a href="#ReadoutLayer-170"><span class="linenos">170</span></a>        <span class="n">grid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayer-171"><a href="#ReadoutLayer-171"><span class="linenos">171</span></a>                
</span><span id="ReadoutLayer-172"><a href="#ReadoutLayer-172"><span class="linenos">172</span></a>        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sample</span>
</span><span id="ReadoutLayer-173"><a href="#ReadoutLayer-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
</span><span id="ReadoutLayer-174"><a href="#ReadoutLayer-174"><span class="linenos">174</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">grid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="ReadoutLayer-175"><a href="#ReadoutLayer-175"><span class="linenos">175</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-176"><a href="#ReadoutLayer-176"><span class="linenos">176</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">grid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayer-177"><a href="#ReadoutLayer-177"><span class="linenos">177</span></a>        
</span><span id="ReadoutLayer-178"><a href="#ReadoutLayer-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer-179"><a href="#ReadoutLayer-179"><span class="linenos">179</span></a>            <span class="c1"># this is dan&#39;s 1-d kluge code -- necessary because grid_sampler has to have last dimension of 2. maybe problem....</span>
</span><span id="ReadoutLayer-180"><a href="#ReadoutLayer-180"><span class="linenos">180</span></a>            <span class="n">grid2d</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayer-181"><a href="#ReadoutLayer-181"><span class="linenos">181</span></a>            <span class="c1">#grid2d[:,:,:,0] = (norm * self.sigma + self.mu).clamp(-1,1).squeeze(-1)</span>
</span><span id="ReadoutLayer-182"><a href="#ReadoutLayer-182"><span class="linenos">182</span></a>            <span class="c1">## SEEMS dim-4 HAS TO BE IN THE SECOND DIMENSION (RATHER THAN FIRST)</span>
</span><span id="ReadoutLayer-183"><a href="#ReadoutLayer-183"><span class="linenos">183</span></a>            <span class="n">grid2d</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayer-184"><a href="#ReadoutLayer-184"><span class="linenos">184</span></a>            <span class="k">return</span> <span class="n">grid2d</span>
</span><span id="ReadoutLayer-185"><a href="#ReadoutLayer-185"><span class="linenos">185</span></a>            <span class="c1">#return (norm * self.sigma + self.mu).clamp(-1,1) # this needs second dimension</span>
</span><span id="ReadoutLayer-186"><a href="#ReadoutLayer-186"><span class="linenos">186</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-187"><a href="#ReadoutLayer-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">!=</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer-188"><a href="#ReadoutLayer-188"><span class="linenos">188</span></a>                <span class="c1"># grid locations in feature space sampled randomly around the mean self.mu</span>
</span><span id="ReadoutLayer-189"><a href="#ReadoutLayer-189"><span class="linenos">189</span></a>                <span class="c1">#return (norm * self.sigma + self.mu).clamp(-1,1)</span>
</span><span id="ReadoutLayer-190"><a href="#ReadoutLayer-190"><span class="linenos">190</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">norm</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="ReadoutLayer-191"><a href="#ReadoutLayer-191"><span class="linenos">191</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-192"><a href="#ReadoutLayer-192"><span class="linenos">192</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ancd,bnid-&gt;bnic&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># grid locations in feature space sampled randomly around the mean self.mu</span>
</span><span id="ReadoutLayer-193"><a href="#ReadoutLayer-193"><span class="linenos">193</span></a>    <span class="c1"># END ReadoutLayer.sample_grid() </span>
</span><span id="ReadoutLayer-194"><a href="#ReadoutLayer-194"><span class="linenos">194</span></a>
</span><span id="ReadoutLayer-195"><a href="#ReadoutLayer-195"><span class="linenos">195</span></a>    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_reshape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_reverse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_inh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer-196"><a href="#ReadoutLayer-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-197"><a href="#ReadoutLayer-197"><span class="linenos">197</span></a><span class="sd">        Overloaded to read not use preprocess weights but instead use layer property features.</span>
</span><span id="ReadoutLayer-198"><a href="#ReadoutLayer-198"><span class="linenos">198</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-199"><a href="#ReadoutLayer-199"><span class="linenos">199</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-200"><a href="#ReadoutLayer-200"><span class="linenos">200</span></a><span class="sd">            to_reshape (bool): whether to reshape the weights to the filter_dims</span>
</span><span id="ReadoutLayer-201"><a href="#ReadoutLayer-201"><span class="linenos">201</span></a><span class="sd">            time_reverse (bool): whether to reverse the time dimension</span>
</span><span id="ReadoutLayer-202"><a href="#ReadoutLayer-202"><span class="linenos">202</span></a><span class="sd">            num_inh (int): number of inhibitory units</span>
</span><span id="ReadoutLayer-203"><a href="#ReadoutLayer-203"><span class="linenos">203</span></a>
</span><span id="ReadoutLayer-204"><a href="#ReadoutLayer-204"><span class="linenos">204</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-205"><a href="#ReadoutLayer-205"><span class="linenos">205</span></a><span class="sd">            ws: weights of the readout layer</span>
</span><span id="ReadoutLayer-206"><a href="#ReadoutLayer-206"><span class="linenos">206</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-207"><a href="#ReadoutLayer-207"><span class="linenos">207</span></a>
</span><span id="ReadoutLayer-208"><a href="#ReadoutLayer-208"><span class="linenos">208</span></a>        <span class="k">assert</span> <span class="n">time_reverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  READOUT: time_reverse will not work here.&quot;</span>
</span><span id="ReadoutLayer-209"><a href="#ReadoutLayer-209"><span class="linenos">209</span></a>        <span class="k">assert</span> <span class="n">num_inh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  READOUT: num_inh will not work here.&quot;</span>
</span><span id="ReadoutLayer-210"><a href="#ReadoutLayer-210"><span class="linenos">210</span></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
</span><span id="ReadoutLayer-211"><a href="#ReadoutLayer-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">to_reshape</span><span class="p">:</span>
</span><span id="ReadoutLayer-212"><a href="#ReadoutLayer-212"><span class="linenos">212</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="ReadoutLayer-213"><a href="#ReadoutLayer-213"><span class="linenos">213</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-214"><a href="#ReadoutLayer-214"><span class="linenos">214</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="ReadoutLayer-215"><a href="#ReadoutLayer-215"><span class="linenos">215</span></a>
</span><span id="ReadoutLayer-216"><a href="#ReadoutLayer-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer-217"><a href="#ReadoutLayer-217"><span class="linenos">217</span></a>            <span class="c1"># Add singleton dimension corresponding to number of filters</span>
</span><span id="ReadoutLayer-218"><a href="#ReadoutLayer-218"><span class="linenos">218</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ReadoutLayer-219"><a href="#ReadoutLayer-219"><span class="linenos">219</span></a>    
</span><span id="ReadoutLayer-220"><a href="#ReadoutLayer-220"><span class="linenos">220</span></a>        <span class="k">return</span> <span class="n">ws</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="ReadoutLayer-221"><a href="#ReadoutLayer-221"><span class="linenos">221</span></a>    <span class="c1"># END ReadoutLayer.get_weights()</span>
</span><span id="ReadoutLayer-222"><a href="#ReadoutLayer-222"><span class="linenos">222</span></a>
</span><span id="ReadoutLayer-223"><a href="#ReadoutLayer-223"><span class="linenos">223</span></a>    <span class="k">def</span> <span class="nf">_set_scaffold_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaffold_level_parse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level_exponent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span id="ReadoutLayer-224"><a href="#ReadoutLayer-224"><span class="linenos">224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-225"><a href="#ReadoutLayer-225"><span class="linenos">225</span></a><span class="sd">        Set regularization that applies to scaffold level to force weights towards low levels.</span>
</span><span id="ReadoutLayer-226"><a href="#ReadoutLayer-226"><span class="linenos">226</span></a><span class="sd">        This function should not be called directly, since will need to pass in non-local scaffold </span>
</span><span id="ReadoutLayer-227"><a href="#ReadoutLayer-227"><span class="linenos">227</span></a><span class="sd">        information available only at the NDN level.</span>
</span><span id="ReadoutLayer-228"><a href="#ReadoutLayer-228"><span class="linenos">228</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-229"><a href="#ReadoutLayer-229"><span class="linenos">229</span></a><span class="sd">        Args: </span>
</span><span id="ReadoutLayer-230"><a href="#ReadoutLayer-230"><span class="linenos">230</span></a><span class="sd">            reg_val (float or None): regularization weight to set, default None</span>
</span><span id="ReadoutLayer-231"><a href="#ReadoutLayer-231"><span class="linenos">231</span></a><span class="sd">            scaffold_level_parse (np.array): level weighting with dimension of number of filters in each</span>
</span><span id="ReadoutLayer-232"><a href="#ReadoutLayer-232"><span class="linenos">232</span></a><span class="sd">                scaffold level [4,25,8,4], but should include total number of weights (in case 4th dim)    </span>
</span><span id="ReadoutLayer-233"><a href="#ReadoutLayer-233"><span class="linenos">233</span></a><span class="sd">            level_exponent (positive float): how much to weight each level </span>
</span><span id="ReadoutLayer-234"><a href="#ReadoutLayer-234"><span class="linenos">234</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-235"><a href="#ReadoutLayer-235"><span class="linenos">235</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer-236"><a href="#ReadoutLayer-236"><span class="linenos">236</span></a><span class="sd">         &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-237"><a href="#ReadoutLayer-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-238"><a href="#ReadoutLayer-238"><span class="linenos">238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer-239"><a href="#ReadoutLayer-239"><span class="linenos">239</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ReadoutLayer-240"><a href="#ReadoutLayer-240"><span class="linenos">240</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-241"><a href="#ReadoutLayer-241"><span class="linenos">241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ReadoutLayer-242"><a href="#ReadoutLayer-242"><span class="linenos">242</span></a>            <span class="c1"># Otherwise, construct weighting across filter_input dimensions</span>
</span><span id="ReadoutLayer-243"><a href="#ReadoutLayer-243"><span class="linenos">243</span></a>            <span class="k">assert</span> <span class="n">level_exponent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;SCAFFOLD REG: level_exponent must be &gt;0&quot;</span>
</span><span id="ReadoutLayer-244"><a href="#ReadoutLayer-244"><span class="linenos">244</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scaffold_level_parse</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;SCAFFOLD REG: Internal error with scaffold_level_parse&quot;</span>
</span><span id="ReadoutLayer-245"><a href="#ReadoutLayer-245"><span class="linenos">245</span></a>
</span><span id="ReadoutLayer-246"><a href="#ReadoutLayer-246"><span class="linenos">246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="n">reg_val</span>  <span class="c1"># just to keep track (should be register_buffer?)</span>
</span><span id="ReadoutLayer-247"><a href="#ReadoutLayer-247"><span class="linenos">247</span></a>
</span><span id="ReadoutLayer-248"><a href="#ReadoutLayer-248"><span class="linenos">248</span></a>            <span class="n">scaffold_weights</span> <span class="o">=</span> <span class="n">reg_val</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ReadoutLayer-249"><a href="#ReadoutLayer-249"><span class="linenos">249</span></a>            <span class="n">place_holder</span><span class="o">=</span><span class="mi">0</span>
</span><span id="ReadoutLayer-250"><a href="#ReadoutLayer-250"><span class="linenos">250</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scaffold_level_parse</span><span class="p">)):</span>
</span><span id="ReadoutLayer-251"><a href="#ReadoutLayer-251"><span class="linenos">251</span></a>                <span class="n">scaffold_weights</span><span class="p">[</span><span class="n">place_holder</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">scaffold_level_parse</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">ii</span><span class="o">**</span><span class="n">level_exponent</span>
</span><span id="ReadoutLayer-252"><a href="#ReadoutLayer-252"><span class="linenos">252</span></a>                <span class="n">place_holder</span> <span class="o">+=</span> <span class="n">scaffold_level_parse</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ReadoutLayer-253"><a href="#ReadoutLayer-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_scaffold_level_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="ReadoutLayer-254"><a href="#ReadoutLayer-254"><span class="linenos">254</span></a>                <span class="n">scaffold_weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ReadoutLayer-255"><a href="#ReadoutLayer-255"><span class="linenos">255</span></a>    <span class="c1"># END ReadoutLayer._set_scaffold_reg()</span>
</span><span id="ReadoutLayer-256"><a href="#ReadoutLayer-256"><span class="linenos">256</span></a>
</span><span id="ReadoutLayer-257"><a href="#ReadoutLayer-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="nf">compute_reg_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer-258"><a href="#ReadoutLayer-258"><span class="linenos">258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-259"><a href="#ReadoutLayer-259"><span class="linenos">259</span></a><span class="sd">        Compute the regularization loss for the layer: superceding super, by calling reg_module to do</span>
</span><span id="ReadoutLayer-260"><a href="#ReadoutLayer-260"><span class="linenos">260</span></a><span class="sd">        this and then adding scaffold weight regularization if needed.</span>
</span><span id="ReadoutLayer-261"><a href="#ReadoutLayer-261"><span class="linenos">261</span></a>
</span><span id="ReadoutLayer-262"><a href="#ReadoutLayer-262"><span class="linenos">262</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-263"><a href="#ReadoutLayer-263"><span class="linenos">263</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer-264"><a href="#ReadoutLayer-264"><span class="linenos">264</span></a>
</span><span id="ReadoutLayer-265"><a href="#ReadoutLayer-265"><span class="linenos">265</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-266"><a href="#ReadoutLayer-266"><span class="linenos">266</span></a><span class="sd">            reg_loss: torch.Tensor, regularization loss</span>
</span><span id="ReadoutLayer-267"><a href="#ReadoutLayer-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-268"><a href="#ReadoutLayer-268"><span class="linenos">268</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_weights</span><span class="p">()</span>
</span><span id="ReadoutLayer-269"><a href="#ReadoutLayer-269"><span class="linenos">269</span></a>        <span class="n">regloss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">compute_reg_loss</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="ReadoutLayer-270"><a href="#ReadoutLayer-270"><span class="linenos">270</span></a>
</span><span id="ReadoutLayer-271"><a href="#ReadoutLayer-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span><span class="p">:</span>
</span><span id="ReadoutLayer-272"><a href="#ReadoutLayer-272"><span class="linenos">272</span></a>            <span class="n">regloss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaffold_level_weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="p">)</span> 
</span><span id="ReadoutLayer-273"><a href="#ReadoutLayer-273"><span class="linenos">273</span></a>        <span class="k">return</span> <span class="n">regloss</span>
</span><span id="ReadoutLayer-274"><a href="#ReadoutLayer-274"><span class="linenos">274</span></a>        <span class="c1"># ReadoutLayer.compute_reg_loss()</span>
</span><span id="ReadoutLayer-275"><a href="#ReadoutLayer-275"><span class="linenos">275</span></a>
</span><span id="ReadoutLayer-276"><a href="#ReadoutLayer-276"><span class="linenos">276</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer-277"><a href="#ReadoutLayer-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-278"><a href="#ReadoutLayer-278"><span class="linenos">278</span></a><span class="sd">        Propagates the input forwards through the readout.</span>
</span><span id="ReadoutLayer-279"><a href="#ReadoutLayer-279"><span class="linenos">279</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-280"><a href="#ReadoutLayer-280"><span class="linenos">280</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-281"><a href="#ReadoutLayer-281"><span class="linenos">281</span></a><span class="sd">            x: input data</span>
</span><span id="ReadoutLayer-282"><a href="#ReadoutLayer-282"><span class="linenos">282</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="ReadoutLayer-283"><a href="#ReadoutLayer-283"><span class="linenos">283</span></a>
</span><span id="ReadoutLayer-284"><a href="#ReadoutLayer-284"><span class="linenos">284</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-285"><a href="#ReadoutLayer-285"><span class="linenos">285</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="ReadoutLayer-286"><a href="#ReadoutLayer-286"><span class="linenos">286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-287"><a href="#ReadoutLayer-287"><span class="linenos">287</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="ReadoutLayer-288"><a href="#ReadoutLayer-288"><span class="linenos">288</span></a>
</span><span id="ReadoutLayer-289"><a href="#ReadoutLayer-289"><span class="linenos">289</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="ReadoutLayer-290"><a href="#ReadoutLayer-290"><span class="linenos">290</span></a>        <span class="n">c_in</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="n">h_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayer-291"><a href="#ReadoutLayer-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">c_in</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="n">h_in</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span><span id="ReadoutLayer-292"><a href="#ReadoutLayer-292"><span class="linenos">292</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer-293"><a href="#ReadoutLayer-293"><span class="linenos">293</span></a>        
</span><span id="ReadoutLayer-294"><a href="#ReadoutLayer-294"><span class="linenos">294</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>  <span class="c1"># this is the filter weights for each unit</span>
</span><span id="ReadoutLayer-295"><a href="#ReadoutLayer-295"><span class="linenos">295</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="ReadoutLayer-296"><a href="#ReadoutLayer-296"><span class="linenos">296</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="ReadoutLayer-297"><a href="#ReadoutLayer-297"><span class="linenos">297</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayer-298"><a href="#ReadoutLayer-298"><span class="linenos">298</span></a>
</span><span id="ReadoutLayer-299"><a href="#ReadoutLayer-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="ReadoutLayer-300"><a href="#ReadoutLayer-300"><span class="linenos">300</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayer-301"><a href="#ReadoutLayer-301"><span class="linenos">301</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayer-302"><a href="#ReadoutLayer-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-303"><a href="#ReadoutLayer-303"><span class="linenos">303</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayer-304"><a href="#ReadoutLayer-304"><span class="linenos">304</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer-305"><a href="#ReadoutLayer-305"><span class="linenos">305</span></a>        
</span><span id="ReadoutLayer-306"><a href="#ReadoutLayer-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-307"><a href="#ReadoutLayer-307"><span class="linenos">307</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="ReadoutLayer-308"><a href="#ReadoutLayer-308"><span class="linenos">308</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ReadoutLayer-309"><a href="#ReadoutLayer-309"><span class="linenos">309</span></a>
</span><span id="ReadoutLayer-310"><a href="#ReadoutLayer-310"><span class="linenos">310</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer-311"><a href="#ReadoutLayer-311"><span class="linenos">311</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="ReadoutLayer-312"><a href="#ReadoutLayer-312"><span class="linenos">312</span></a>
</span><span id="ReadoutLayer-313"><a href="#ReadoutLayer-313"><span class="linenos">313</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="ReadoutLayer-314"><a href="#ReadoutLayer-314"><span class="linenos">314</span></a>
</span><span id="ReadoutLayer-315"><a href="#ReadoutLayer-315"><span class="linenos">315</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-316"><a href="#ReadoutLayer-316"><span class="linenos">316</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="ReadoutLayer-317"><a href="#ReadoutLayer-317"><span class="linenos">317</span></a>        
</span><span id="ReadoutLayer-318"><a href="#ReadoutLayer-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-319"><a href="#ReadoutLayer-319"><span class="linenos">319</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="ReadoutLayer-320"><a href="#ReadoutLayer-320"><span class="linenos">320</span></a>        
</span><span id="ReadoutLayer-321"><a href="#ReadoutLayer-321"><span class="linenos">321</span></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="ReadoutLayer-322"><a href="#ReadoutLayer-322"><span class="linenos">322</span></a>    <span class="c1"># END ReadoutLayer.forward</span>
</span><span id="ReadoutLayer-323"><a href="#ReadoutLayer-323"><span class="linenos">323</span></a>
</span><span id="ReadoutLayer-324"><a href="#ReadoutLayer-324"><span class="linenos">324</span></a>    <span class="k">def</span> <span class="nf">set_readout_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">):</span>
</span><span id="ReadoutLayer-325"><a href="#ReadoutLayer-325"><span class="linenos">325</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-326"><a href="#ReadoutLayer-326"><span class="linenos">326</span></a><span class="sd">        This hasn&#39;t been tested yet, but should be self-explanatory.</span>
</span><span id="ReadoutLayer-327"><a href="#ReadoutLayer-327"><span class="linenos">327</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-328"><a href="#ReadoutLayer-328"><span class="linenos">328</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-329"><a href="#ReadoutLayer-329"><span class="linenos">329</span></a><span class="sd">            locs: locations of the readout units</span>
</span><span id="ReadoutLayer-330"><a href="#ReadoutLayer-330"><span class="linenos">330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-331"><a href="#ReadoutLayer-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer-332"><a href="#ReadoutLayer-332"><span class="linenos">332</span></a>            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayer-333"><a href="#ReadoutLayer-333"><span class="linenos">333</span></a>        <span class="n">NC</span><span class="p">,</span> <span class="n">num_dim</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ReadoutLayer-334"><a href="#ReadoutLayer-334"><span class="linenos">334</span></a>        <span class="k">assert</span> <span class="n">num_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of spatial dimensions&#39;</span>
</span><span id="ReadoutLayer-335"><a href="#ReadoutLayer-335"><span class="linenos">335</span></a>        <span class="k">assert</span> <span class="n">NC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of neuron positions.&#39;</span>
</span><span id="ReadoutLayer-336"><a href="#ReadoutLayer-336"><span class="linenos">336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
</span><span id="ReadoutLayer-337"><a href="#ReadoutLayer-337"><span class="linenos">337</span></a>
</span><span id="ReadoutLayer-338"><a href="#ReadoutLayer-338"><span class="linenos">338</span></a>    <span class="k">def</span> <span class="nf">get_readout_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer-339"><a href="#ReadoutLayer-339"><span class="linenos">339</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-340"><a href="#ReadoutLayer-340"><span class="linenos">340</span></a><span class="sd">        Currently returns center location and sigmas, as list.</span>
</span><span id="ReadoutLayer-341"><a href="#ReadoutLayer-341"><span class="linenos">341</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-342"><a href="#ReadoutLayer-342"><span class="linenos">342</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-343"><a href="#ReadoutLayer-343"><span class="linenos">343</span></a><span class="sd">            mu: center locations of the readout units</span>
</span><span id="ReadoutLayer-344"><a href="#ReadoutLayer-344"><span class="linenos">344</span></a><span class="sd">            sigma: sigmas of the readout units</span>
</span><span id="ReadoutLayer-345"><a href="#ReadoutLayer-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-346"><a href="#ReadoutLayer-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>    
</span><span id="ReadoutLayer-347"><a href="#ReadoutLayer-347"><span class="linenos">347</span></a>
</span><span id="ReadoutLayer-348"><a href="#ReadoutLayer-348"><span class="linenos">348</span></a>    <span class="k">def</span> <span class="nf">passive_readout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer-349"><a href="#ReadoutLayer-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-350"><a href="#ReadoutLayer-350"><span class="linenos">350</span></a><span class="sd">        This will not fit mu and std, but set them to zero. It will pass identities in,</span>
</span><span id="ReadoutLayer-351"><a href="#ReadoutLayer-351"><span class="linenos">351</span></a><span class="sd">        so number of input filters must equal number of readout units.</span>
</span><span id="ReadoutLayer-352"><a href="#ReadoutLayer-352"><span class="linenos">352</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-353"><a href="#ReadoutLayer-353"><span class="linenos">353</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-354"><a href="#ReadoutLayer-354"><span class="linenos">354</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer-355"><a href="#ReadoutLayer-355"><span class="linenos">355</span></a>
</span><span id="ReadoutLayer-356"><a href="#ReadoutLayer-356"><span class="linenos">356</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-357"><a href="#ReadoutLayer-357"><span class="linenos">357</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer-358"><a href="#ReadoutLayer-358"><span class="linenos">358</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-359"><a href="#ReadoutLayer-359"><span class="linenos">359</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Must have #filters = #output units.&quot;</span>
</span><span id="ReadoutLayer-360"><a href="#ReadoutLayer-360"><span class="linenos">360</span></a>        <span class="c1"># Set parameters for default readout</span>
</span><span id="ReadoutLayer-361"><a href="#ReadoutLayer-361"><span class="linenos">361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer-362"><a href="#ReadoutLayer-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer-363"><a href="#ReadoutLayer-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer-364"><a href="#ReadoutLayer-364"><span class="linenos">364</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">):</span>
</span><span id="ReadoutLayer-365"><a href="#ReadoutLayer-365"><span class="linenos">365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer-366"><a href="#ReadoutLayer-366"><span class="linenos">366</span></a>
</span><span id="ReadoutLayer-367"><a href="#ReadoutLayer-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ReadoutLayer-368"><a href="#ReadoutLayer-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer-369"><a href="#ReadoutLayer-369"><span class="linenos">369</span></a>
</span><span id="ReadoutLayer-370"><a href="#ReadoutLayer-370"><span class="linenos">370</span></a>    <span class="k">def</span> <span class="nf">fit_mus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="ReadoutLayer-371"><a href="#ReadoutLayer-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-372"><a href="#ReadoutLayer-372"><span class="linenos">372</span></a><span class="sd">        Quick function that turns on or off fitting mus/sigmas and toggles sample</span>
</span><span id="ReadoutLayer-373"><a href="#ReadoutLayer-373"><span class="linenos">373</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-374"><a href="#ReadoutLayer-374"><span class="linenos">374</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-375"><a href="#ReadoutLayer-375"><span class="linenos">375</span></a><span class="sd">            val (bool): True or False -- must specify</span>
</span><span id="ReadoutLayer-376"><a href="#ReadoutLayer-376"><span class="linenos">376</span></a><span class="sd">            sigma (float): choose starting sigma value (default no choice)</span>
</span><span id="ReadoutLayer-377"><a href="#ReadoutLayer-377"><span class="linenos">377</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-378"><a href="#ReadoutLayer-378"><span class="linenos">378</span></a>        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fit_mus(): must set val to be True or False&quot;</span>
</span><span id="ReadoutLayer-379"><a href="#ReadoutLayer-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="ReadoutLayer-380"><a href="#ReadoutLayer-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer-381"><a href="#ReadoutLayer-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer-382"><a href="#ReadoutLayer-382"><span class="linenos">382</span></a>        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer-383"><a href="#ReadoutLayer-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="ReadoutLayer-384"><a href="#ReadoutLayer-384"><span class="linenos">384</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ReadoutLayer-385"><a href="#ReadoutLayer-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="ReadoutLayer-386"><a href="#ReadoutLayer-386"><span class="linenos">386</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: fitting mus&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer-387"><a href="#ReadoutLayer-387"><span class="linenos">387</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer-388"><a href="#ReadoutLayer-388"><span class="linenos">388</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: not fitting mus&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer-389"><a href="#ReadoutLayer-389"><span class="linenos">389</span></a>    <span class="c1"># END ReadoutLayer.fit_mus()</span>
</span><span id="ReadoutLayer-390"><a href="#ReadoutLayer-390"><span class="linenos">390</span></a>
</span><span id="ReadoutLayer-391"><a href="#ReadoutLayer-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">enforce_grid</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="ReadoutLayer-392"><a href="#ReadoutLayer-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-393"><a href="#ReadoutLayer-393"><span class="linenos">393</span></a><span class="sd">        Function that adjusts mus to correspond to precise points on pixel grid</span>
</span><span id="ReadoutLayer-394"><a href="#ReadoutLayer-394"><span class="linenos">394</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer-395"><a href="#ReadoutLayer-395"><span class="linenos">395</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-396"><a href="#ReadoutLayer-396"><span class="linenos">396</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer-397"><a href="#ReadoutLayer-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-398"><a href="#ReadoutLayer-398"><span class="linenos">398</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayer-399"><a href="#ReadoutLayer-399"><span class="linenos">399</span></a>
</span><span id="ReadoutLayer-400"><a href="#ReadoutLayer-400"><span class="linenos">400</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="ReadoutLayer-401"><a href="#ReadoutLayer-401"><span class="linenos">401</span></a>        <span class="n">pixels</span><span class="p">[</span><span class="n">pixels</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">1</span>
</span><span id="ReadoutLayer-402"><a href="#ReadoutLayer-402"><span class="linenos">402</span></a>        <span class="n">pixels</span><span class="p">[</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ReadoutLayer-403"><a href="#ReadoutLayer-403"><span class="linenos">403</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="ReadoutLayer-404"><a href="#ReadoutLayer-404"><span class="linenos">404</span></a>
</span><span id="ReadoutLayer-405"><a href="#ReadoutLayer-405"><span class="linenos">405</span></a>        <span class="c1"># Convert back to mu values</span>
</span><span id="ReadoutLayer-406"><a href="#ReadoutLayer-406"><span class="linenos">406</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pixels</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="ReadoutLayer-407"><a href="#ReadoutLayer-407"><span class="linenos">407</span></a>    <span class="c1"># END ReadoutLayer.enforce_grid()</span>
</span><span id="ReadoutLayer-408"><a href="#ReadoutLayer-408"><span class="linenos">408</span></a>
</span><span id="ReadoutLayer-409"><a href="#ReadoutLayer-409"><span class="linenos">409</span></a>    <span class="k">def</span> <span class="nf">_layer_abbrev</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="ReadoutLayer-410"><a href="#ReadoutLayer-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="s2">&quot; readout&quot;</span>
</span><span id="ReadoutLayer-411"><a href="#ReadoutLayer-411"><span class="linenos">411</span></a>
</span><span id="ReadoutLayer-412"><a href="#ReadoutLayer-412"><span class="linenos">412</span></a>    <span class="nd">@classmethod</span>
</span><span id="ReadoutLayer-413"><a href="#ReadoutLayer-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer-414"><a href="#ReadoutLayer-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-415"><a href="#ReadoutLayer-415"><span class="linenos">415</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="ReadoutLayer-416"><a href="#ReadoutLayer-416"><span class="linenos">416</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="ReadoutLayer-417"><a href="#ReadoutLayer-417"><span class="linenos">417</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="ReadoutLayer-418"><a href="#ReadoutLayer-418"><span class="linenos">418</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="ReadoutLayer-419"><a href="#ReadoutLayer-419"><span class="linenos">419</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="ReadoutLayer-420"><a href="#ReadoutLayer-420"><span class="linenos">420</span></a>
</span><span id="ReadoutLayer-421"><a href="#ReadoutLayer-421"><span class="linenos">421</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer-422"><a href="#ReadoutLayer-422"><span class="linenos">422</span></a><span class="sd">            NLtype: str, type of nonlinearity</span>
</span><span id="ReadoutLayer-423"><a href="#ReadoutLayer-423"><span class="linenos">423</span></a>
</span><span id="ReadoutLayer-424"><a href="#ReadoutLayer-424"><span class="linenos">424</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer-425"><a href="#ReadoutLayer-425"><span class="linenos">425</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="ReadoutLayer-426"><a href="#ReadoutLayer-426"><span class="linenos">426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer-427"><a href="#ReadoutLayer-427"><span class="linenos">427</span></a>
</span><span id="ReadoutLayer-428"><a href="#ReadoutLayer-428"><span class="linenos">428</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer-429"><a href="#ReadoutLayer-429"><span class="linenos">429</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readout&#39;</span>
</span><span id="ReadoutLayer-430"><a href="#ReadoutLayer-430"><span class="linenos">430</span></a>        <span class="c1"># Added arguments</span>
</span><span id="ReadoutLayer-431"><a href="#ReadoutLayer-431"><span class="linenos">431</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ReadoutLayer-432"><a href="#ReadoutLayer-432"><span class="linenos">432</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_mu_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="ReadoutLayer-433"><a href="#ReadoutLayer-433"><span class="linenos">433</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="ReadoutLayer-434"><a href="#ReadoutLayer-434"><span class="linenos">434</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;gauss_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span> <span class="c1">#&#39;uncorrelated&#39;</span>
</span><span id="ReadoutLayer-435"><a href="#ReadoutLayer-435"><span class="linenos">435</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;align_corners&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer-436"><a href="#ReadoutLayer-436"><span class="linenos">436</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># also &#39;nearest&#39;</span>
</span><span id="ReadoutLayer-437"><a href="#ReadoutLayer-437"><span class="linenos">437</span></a>        <span class="c1"># Change default -- readouts will usually be softplus</span>
</span><span id="ReadoutLayer-438"><a href="#ReadoutLayer-438"><span class="linenos">438</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;NLtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NLtype</span>
</span><span id="ReadoutLayer-439"><a href="#ReadoutLayer-439"><span class="linenos">439</span></a>
</span><span id="ReadoutLayer-440"><a href="#ReadoutLayer-440"><span class="linenos">440</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="ReadoutLayer-441"><a href="#ReadoutLayer-441"><span class="linenos">441</span></a>    <span class="c1"># END [classmethod] ReadoutLayer.layer_dict</span>
</span></pre></div>


            <div class="docstring"><p>ReadoutLayer for spatial readout.</p>
</div>


                            <div id="ReadoutLayer.__init__" class="classattr">
                                        <input id="ReadoutLayer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ReadoutLayer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_filters</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">batch_sample</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">init_mu_range</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.2</span>,</span><span class="param">	<span class="n">gauss_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span>,</span><span class="param">	<span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ReadoutLayer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.__init__-15"><a href="#ReadoutLayer.__init__-15"><span class="linenos"> 15</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="ReadoutLayer.__init__-16"><a href="#ReadoutLayer.__init__-16"><span class="linenos"> 16</span></a>            <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-17"><a href="#ReadoutLayer.__init__-17"><span class="linenos"> 17</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-18"><a href="#ReadoutLayer.__init__-18"><span class="linenos"> 18</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="ReadoutLayer.__init__-19"><a href="#ReadoutLayer.__init__-19"><span class="linenos"> 19</span></a>            <span class="n">batch_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-20"><a href="#ReadoutLayer.__init__-20"><span class="linenos"> 20</span></a>            <span class="n">init_mu_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-21"><a href="#ReadoutLayer.__init__-21"><span class="linenos"> 21</span></a>            <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-22"><a href="#ReadoutLayer.__init__-22"><span class="linenos"> 22</span></a>            <span class="n">gauss_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;isotropic&#39;</span><span class="p">,</span> <span class="c1"># &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="ReadoutLayer.__init__-23"><a href="#ReadoutLayer.__init__-23"><span class="linenos"> 23</span></a>            <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-24"><a href="#ReadoutLayer.__init__-24"><span class="linenos"> 24</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span>  <span class="c1"># &#39;nearest&#39; is also possible</span>
</span><span id="ReadoutLayer.__init__-25"><a href="#ReadoutLayer.__init__-25"><span class="linenos"> 25</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer.__init__-26"><a href="#ReadoutLayer.__init__-26"><span class="linenos"> 26</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.__init__-27"><a href="#ReadoutLayer.__init__-27"><span class="linenos"> 27</span></a><span class="sd">        ReadoutLayer: Spatial readout layer for NDNs.</span>
</span><span id="ReadoutLayer.__init__-28"><a href="#ReadoutLayer.__init__-28"><span class="linenos"> 28</span></a>
</span><span id="ReadoutLayer.__init__-29"><a href="#ReadoutLayer.__init__-29"><span class="linenos"> 29</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.__init__-30"><a href="#ReadoutLayer.__init__-30"><span class="linenos"> 30</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="ReadoutLayer.__init__-31"><a href="#ReadoutLayer.__init__-31"><span class="linenos"> 31</span></a><span class="sd">            num_filters: number of output filters</span>
</span><span id="ReadoutLayer.__init__-32"><a href="#ReadoutLayer.__init__-32"><span class="linenos"> 32</span></a><span class="sd">            filter_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="ReadoutLayer.__init__-33"><a href="#ReadoutLayer.__init__-33"><span class="linenos"> 33</span></a><span class="sd">            batch_sample: bool, whether to sample grid locations separately per sample per batch</span>
</span><span id="ReadoutLayer.__init__-34"><a href="#ReadoutLayer.__init__-34"><span class="linenos"> 34</span></a><span class="sd">            init_mu_range: float, range for uniform initialization of means</span>
</span><span id="ReadoutLayer.__init__-35"><a href="#ReadoutLayer.__init__-35"><span class="linenos"> 35</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="ReadoutLayer.__init__-36"><a href="#ReadoutLayer.__init__-36"><span class="linenos"> 36</span></a><span class="sd">            gauss_type: str, &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="ReadoutLayer.__init__-37"><a href="#ReadoutLayer.__init__-37"><span class="linenos"> 37</span></a><span class="sd">            align_corners: bool, whether to align corners in grid_sample</span>
</span><span id="ReadoutLayer.__init__-38"><a href="#ReadoutLayer.__init__-38"><span class="linenos"> 38</span></a><span class="sd">            mode: str, &#39;bilinear&#39; or &#39;nearest&#39;</span>
</span><span id="ReadoutLayer.__init__-39"><a href="#ReadoutLayer.__init__-39"><span class="linenos"> 39</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.__init__-40"><a href="#ReadoutLayer.__init__-40"><span class="linenos"> 40</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify input_dims&quot;</span>
</span><span id="ReadoutLayer.__init__-41"><a href="#ReadoutLayer.__init__-41"><span class="linenos"> 41</span></a>        <span class="k">assert</span> <span class="n">num_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify num_filters&quot;</span>
</span><span id="ReadoutLayer.__init__-42"><a href="#ReadoutLayer.__init__-42"><span class="linenos"> 42</span></a>
</span><span id="ReadoutLayer.__init__-43"><a href="#ReadoutLayer.__init__-43"><span class="linenos"> 43</span></a>        <span class="c1"># Make sure filter_dims is filled in, and to single the spatial filter dimensions</span>
</span><span id="ReadoutLayer.__init__-44"><a href="#ReadoutLayer.__init__-44"><span class="linenos"> 44</span></a>        <span class="k">if</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-45"><a href="#ReadoutLayer.__init__-45"><span class="linenos"> 45</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-46"><a href="#ReadoutLayer.__init__-46"><span class="linenos"> 46</span></a>        
</span><span id="ReadoutLayer.__init__-47"><a href="#ReadoutLayer.__init__-47"><span class="linenos"> 47</span></a>        <span class="n">filter_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayer.__init__-48"><a href="#ReadoutLayer.__init__-48"><span class="linenos"> 48</span></a>        
</span><span id="ReadoutLayer.__init__-49"><a href="#ReadoutLayer.__init__-49"><span class="linenos"> 49</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cant handle temporal filter dims here, yet.&#39;</span>
</span><span id="ReadoutLayer.__init__-50"><a href="#ReadoutLayer.__init__-50"><span class="linenos"> 50</span></a>        
</span><span id="ReadoutLayer.__init__-51"><a href="#ReadoutLayer.__init__-51"><span class="linenos"> 51</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-52"><a href="#ReadoutLayer.__init__-52"><span class="linenos"> 52</span></a>            <span class="n">num_filters</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-53"><a href="#ReadoutLayer.__init__-53"><span class="linenos"> 53</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="n">filter_dims</span><span class="p">,</span>
</span><span id="ReadoutLayer.__init__-54"><a href="#ReadoutLayer.__init__-54"><span class="linenos"> 54</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-55"><a href="#ReadoutLayer.__init__-55"><span class="linenos"> 55</span></a>        
</span><span id="ReadoutLayer.__init__-56"><a href="#ReadoutLayer.__init__-56"><span class="linenos"> 56</span></a>        <span class="c1"># Determine whether one- or two-dimensional readout</span>
</span><span id="ReadoutLayer.__init__-57"><a href="#ReadoutLayer.__init__-57"><span class="linenos"> 57</span></a>        <span class="k">if</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-58"><a href="#ReadoutLayer.__init__-58"><span class="linenos"> 58</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer.__init__-59"><a href="#ReadoutLayer.__init__-59"><span class="linenos"> 59</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-60"><a href="#ReadoutLayer.__init__-60"><span class="linenos"> 60</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="ReadoutLayer.__init__-61"><a href="#ReadoutLayer.__init__-61"><span class="linenos"> 61</span></a>
</span><span id="ReadoutLayer.__init__-62"><a href="#ReadoutLayer.__init__-62"><span class="linenos"> 62</span></a>        <span class="c1"># Additional readout parameters (below)</span>
</span><span id="ReadoutLayer.__init__-63"><a href="#ReadoutLayer.__init__-63"><span class="linenos"> 63</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-64"><a href="#ReadoutLayer.__init__-64"><span class="linenos"> 64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;minval&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</span><span id="ReadoutLayer.__init__-65"><a href="#ReadoutLayer.__init__-65"><span class="linenos"> 65</span></a>            <span class="c1"># Does this apply to both weights and biases? Should be separate?</span>
</span><span id="ReadoutLayer.__init__-66"><a href="#ReadoutLayer.__init__-66"><span class="linenos"> 66</span></a>
</span><span id="ReadoutLayer.__init__-67"><a href="#ReadoutLayer.__init__-67"><span class="linenos"> 67</span></a>        <span class="c1"># self.flatten = nn.Flatten()</span>
</span><span id="ReadoutLayer.__init__-68"><a href="#ReadoutLayer.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span> <span class="o">=</span> <span class="n">batch_sample</span>
</span><span id="ReadoutLayer.__init__-69"><a href="#ReadoutLayer.__init__-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span> <span class="o">=</span> <span class="n">mode</span>
</span><span id="ReadoutLayer.__init__-70"><a href="#ReadoutLayer.__init__-70"><span class="linenos"> 70</span></a>
</span><span id="ReadoutLayer.__init__-71"><a href="#ReadoutLayer.__init__-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">=</span> <span class="n">init_mu_range</span>
</span><span id="ReadoutLayer.__init__-72"><a href="#ReadoutLayer.__init__-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="ReadoutLayer.__init__-73"><a href="#ReadoutLayer.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="ReadoutLayer.__init__-74"><a href="#ReadoutLayer.__init__-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-75"><a href="#ReadoutLayer.__init__-75"><span class="linenos"> 75</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;either init_mu_range doesn&#39;t belong to [0.0, 1.0] or init_sigma_range is non-positive&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-76"><a href="#ReadoutLayer.__init__-76"><span class="linenos"> 76</span></a>        
</span><span id="ReadoutLayer.__init__-77"><a href="#ReadoutLayer.__init__-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-78"><a href="#ReadoutLayer.__init__-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span>  <span class="c1"># only 1-d to sample sigma in</span>
</span><span id="ReadoutLayer.__init__-79"><a href="#ReadoutLayer.__init__-79"><span class="linenos"> 79</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-80"><a href="#ReadoutLayer.__init__-80"><span class="linenos"> 80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">=</span> <span class="n">gauss_type</span>
</span><span id="ReadoutLayer.__init__-81"><a href="#ReadoutLayer.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span> <span class="o">=</span> <span class="n">align_corners</span>
</span><span id="ReadoutLayer.__init__-82"><a href="#ReadoutLayer.__init__-82"><span class="linenos"> 82</span></a>
</span><span id="ReadoutLayer.__init__-83"><a href="#ReadoutLayer.__init__-83"><span class="linenos"> 83</span></a>        <span class="c1"># position grid shape</span>
</span><span id="ReadoutLayer.__init__-84"><a href="#ReadoutLayer.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-85"><a href="#ReadoutLayer.__init__-85"><span class="linenos"> 85</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-86"><a href="#ReadoutLayer.__init__-86"><span class="linenos"> 86</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 2, 2)</span>
</span><span id="ReadoutLayer.__init__-87"><a href="#ReadoutLayer.__init__-87"><span class="linenos"> 87</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-88"><a href="#ReadoutLayer.__init__-88"><span class="linenos"> 88</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;uncorrelated&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-89"><a href="#ReadoutLayer.__init__-89"><span class="linenos"> 89</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 1, 2)</span>
</span><span id="ReadoutLayer.__init__-90"><a href="#ReadoutLayer.__init__-90"><span class="linenos"> 90</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-91"><a href="#ReadoutLayer.__init__-91"><span class="linenos"> 91</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">==</span> <span class="s1">&#39;isotropic&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-92"><a href="#ReadoutLayer.__init__-92"><span class="linenos"> 92</span></a>            <span class="c1">#self.sigma_shape = (1, self.num_filters, 1, 1)</span>
</span><span id="ReadoutLayer.__init__-93"><a href="#ReadoutLayer.__init__-93"><span class="linenos"> 93</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-94"><a href="#ReadoutLayer.__init__-94"><span class="linenos"> 94</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.__init__-95"><a href="#ReadoutLayer.__init__-95"><span class="linenos"> 95</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gauss_type &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span><span class="si">}</span><span class="s1">&quot; not known&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-96"><a href="#ReadoutLayer.__init__-96"><span class="linenos"> 96</span></a>
</span><span id="ReadoutLayer.__init__-97"><a href="#ReadoutLayer.__init__-97"><span class="linenos"> 97</span></a>        <span class="c1"># initialize means and spreads</span>
</span><span id="ReadoutLayer.__init__-98"><a href="#ReadoutLayer.__init__-98"><span class="linenos"> 98</span></a>        <span class="n">map_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer.__init__-99"><a href="#ReadoutLayer.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">*</span><span class="n">map_size</span><span class="p">))</span>
</span><span id="ReadoutLayer.__init__-100"><a href="#ReadoutLayer.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_shape</span><span class="p">))</span>
</span><span id="ReadoutLayer.__init__-101"><a href="#ReadoutLayer.__init__-101"><span class="linenos">101</span></a>
</span><span id="ReadoutLayer.__init__-102"><a href="#ReadoutLayer.__init__-102"><span class="linenos">102</span></a>        <span class="c1"># For use with scaffold_level_regularization</span>
</span><span id="ReadoutLayer.__init__-103"><a href="#ReadoutLayer.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer.__init__-104"><a href="#ReadoutLayer.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_level_reg_val</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># just so info is available</span>
</span><span id="ReadoutLayer.__init__-105"><a href="#ReadoutLayer.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_scaffold_level_weights&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span><span id="ReadoutLayer.__init__-106"><a href="#ReadoutLayer.__init__-106"><span class="linenos">106</span></a>
</span><span id="ReadoutLayer.__init__-107"><a href="#ReadoutLayer.__init__-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_spatial_mapping</span><span class="p">()</span>
</span><span id="ReadoutLayer.__init__-108"><a href="#ReadoutLayer.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>ReadoutLayer: Spatial readout layer for NDNs.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>input_dims:</strong>  tuple or list of ints, (num_channels, height, width, lags)</li>
<li><strong>num_filters:</strong>  number of output filters</li>
<li><strong>filter_dims:</strong>  tuple or list of ints, (num_channels, height, width, lags)</li>
<li><strong>batch_sample:</strong>  bool, whether to sample grid locations separately per sample per batch</li>
<li><strong>init_mu_range:</strong>  float, range for uniform initialization of means</li>
<li><strong>init_sigma:</strong>  float, standard deviation for uniform initialization of sigmas</li>
<li><strong>gauss_type:</strong>  str, 'isotropic', 'uncorrelated', or 'full'</li>
<li><strong>align_corners:</strong>  bool, whether to align corners in grid_sample</li>
<li><strong>mode:</strong>  str, 'bilinear' or 'nearest'</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer.batch_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_sample</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.batch_sample"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.sample_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">sample_mode</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.sample_mode"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.init_mu_range" class="classattr">
                                <div class="attr variable">
            <span class="name">init_mu_range</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.init_mu_range"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.init_sigma" class="classattr">
                                <div class="attr variable">
            <span class="name">init_sigma</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.init_sigma"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.align_corners" class="classattr">
                                <div class="attr variable">
            <span class="name">align_corners</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.align_corners"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.grid_shape" class="classattr">
                                <div class="attr variable">
            <span class="name">grid_shape</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.grid_shape"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.mu" class="classattr">
                                <div class="attr variable">
            <span class="name">mu</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.mu"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.sigma" class="classattr">
                                <div class="attr variable">
            <span class="name">sigma</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.sigma"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.level_reg" class="classattr">
                                <div class="attr variable">
            <span class="name">level_reg</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.level_reg"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.sample" class="classattr">
                                <div class="attr variable">
            <span class="name">sample</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer.sample"></a>
    
    

                            </div>
                            <div id="ReadoutLayer.features" class="classattr">
                                        <input id="ReadoutLayer.features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">features</span>

                <label class="view-source-button" for="ReadoutLayer.features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.features-112"><a href="#ReadoutLayer.features-112"><span class="linenos">112</span></a>    <span class="nd">@property</span>
</span><span id="ReadoutLayer.features-113"><a href="#ReadoutLayer.features-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer.features-114"><a href="#ReadoutLayer.features-114"><span class="linenos">114</span></a>
</span><span id="ReadoutLayer.features-115"><a href="#ReadoutLayer.features-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="ReadoutLayer.features-116"><a href="#ReadoutLayer.features-116"><span class="linenos">116</span></a>            <span class="c1">#feat = F.relu(self.weight)</span>
</span><span id="ReadoutLayer.features-117"><a href="#ReadoutLayer.features-117"><span class="linenos">117</span></a>            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">**</span><span class="mi">2</span>
</span><span id="ReadoutLayer.features-118"><a href="#ReadoutLayer.features-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.features-119"><a href="#ReadoutLayer.features-119"><span class="linenos">119</span></a>            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
</span><span id="ReadoutLayer.features-120"><a href="#ReadoutLayer.features-120"><span class="linenos">120</span></a>        
</span><span id="ReadoutLayer.features-121"><a href="#ReadoutLayer.features-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="n">feat</span>
</span></pre></div>


    

                            </div>
                            <div id="ReadoutLayer.grid" class="classattr">
                                        <input id="ReadoutLayer.grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">grid</span>

                <label class="view-source-button" for="ReadoutLayer.grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.grid-123"><a href="#ReadoutLayer.grid-123"><span class="linenos">123</span></a>    <span class="nd">@property</span>
</span><span id="ReadoutLayer.grid-124"><a href="#ReadoutLayer.grid-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer.grid-125"><a href="#ReadoutLayer.grid-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ReadoutLayer.initialize_spatial_mapping" class="classattr">
                                        <input id="ReadoutLayer.initialize_spatial_mapping-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize_spatial_mapping</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.initialize_spatial_mapping-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.initialize_spatial_mapping"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.initialize_spatial_mapping-131"><a href="#ReadoutLayer.initialize_spatial_mapping-131"><span class="linenos">131</span></a>    <span class="k">def</span> <span class="nf">initialize_spatial_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-132"><a href="#ReadoutLayer.initialize_spatial_mapping-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-133"><a href="#ReadoutLayer.initialize_spatial_mapping-133"><span class="linenos">133</span></a><span class="sd">        Initializes the mean, and sigma of the Gaussian readout.</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-134"><a href="#ReadoutLayer.initialize_spatial_mapping-134"><span class="linenos">134</span></a>
</span><span id="ReadoutLayer.initialize_spatial_mapping-135"><a href="#ReadoutLayer.initialize_spatial_mapping-135"><span class="linenos">135</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-136"><a href="#ReadoutLayer.initialize_spatial_mapping-136"><span class="linenos">136</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-137"><a href="#ReadoutLayer.initialize_spatial_mapping-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-138"><a href="#ReadoutLayer.initialize_spatial_mapping-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mu_range</span><span class="p">)</span>  <span class="c1"># random initializations uniformly spread....</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-139"><a href="#ReadoutLayer.initialize_spatial_mapping-139"><span class="linenos">139</span></a>        <span class="c1"># if self.gauss_type != &#39;full&#39;:</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-140"><a href="#ReadoutLayer.initialize_spatial_mapping-140"><span class="linenos">140</span></a>        <span class="c1">#     self.sigma.data.fill_(self.init_sigma)</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-141"><a href="#ReadoutLayer.initialize_spatial_mapping-141"><span class="linenos">141</span></a>        <span class="c1"># else:</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-142"><a href="#ReadoutLayer.initialize_spatial_mapping-142"><span class="linenos">142</span></a>        <span class="c1">#self.sigma.data.uniform_(0, self.init_sigma)</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-143"><a href="#ReadoutLayer.initialize_spatial_mapping-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span><span class="p">)</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-144"><a href="#ReadoutLayer.initialize_spatial_mapping-144"><span class="linenos">144</span></a>        
</span><span id="ReadoutLayer.initialize_spatial_mapping-145"><a href="#ReadoutLayer.initialize_spatial_mapping-145"><span class="linenos">145</span></a>        <span class="c1">#self.weight.data.fill_(1 / self.input_dims[0])</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-146"><a href="#ReadoutLayer.initialize_spatial_mapping-146"><span class="linenos">146</span></a>
</span><span id="ReadoutLayer.initialize_spatial_mapping-147"><a href="#ReadoutLayer.initialize_spatial_mapping-147"><span class="linenos">147</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer.initialize_spatial_mapping-148"><a href="#ReadoutLayer.initialize_spatial_mapping-148"><span class="linenos">148</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the mean, and sigma of the Gaussian readout.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer.sample_grid" class="classattr">
                                        <input id="ReadoutLayer.sample_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_grid</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch_size</span>, </span><span class="param"><span class="n">sample</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.sample_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.sample_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.sample_grid-150"><a href="#ReadoutLayer.sample_grid-150"><span class="linenos">150</span></a>    <span class="k">def</span> <span class="nf">sample_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer.sample_grid-151"><a href="#ReadoutLayer.sample_grid-151"><span class="linenos">151</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.sample_grid-152"><a href="#ReadoutLayer.sample_grid-152"><span class="linenos">152</span></a><span class="sd">        Returns the grid locations from the core by sampling from a Gaussian distribution</span>
</span><span id="ReadoutLayer.sample_grid-153"><a href="#ReadoutLayer.sample_grid-153"><span class="linenos">153</span></a><span class="sd">        More specifically, it returns sampled positions for each batch over all elements, given mus and sigmas</span>
</span><span id="ReadoutLayer.sample_grid-154"><a href="#ReadoutLayer.sample_grid-154"><span class="linenos">154</span></a><span class="sd">        If &#39;sample&#39; is false, it just gives mu back (so testing has no randomness)</span>
</span><span id="ReadoutLayer.sample_grid-155"><a href="#ReadoutLayer.sample_grid-155"><span class="linenos">155</span></a><span class="sd">        This code is inherited and then modified, so different style than most other</span>
</span><span id="ReadoutLayer.sample_grid-156"><a href="#ReadoutLayer.sample_grid-156"><span class="linenos">156</span></a>
</span><span id="ReadoutLayer.sample_grid-157"><a href="#ReadoutLayer.sample_grid-157"><span class="linenos">157</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.sample_grid-158"><a href="#ReadoutLayer.sample_grid-158"><span class="linenos">158</span></a><span class="sd">            batch_size (int): size of the batch</span>
</span><span id="ReadoutLayer.sample_grid-159"><a href="#ReadoutLayer.sample_grid-159"><span class="linenos">159</span></a><span class="sd">            sample (bool/None): sample determines whether we draw a sample from Gaussian distribution, N(mu,sigma), defined per neuron</span>
</span><span id="ReadoutLayer.sample_grid-160"><a href="#ReadoutLayer.sample_grid-160"><span class="linenos">160</span></a><span class="sd">                            or use the mean, mu, of the Gaussian distribution without sampling.</span>
</span><span id="ReadoutLayer.sample_grid-161"><a href="#ReadoutLayer.sample_grid-161"><span class="linenos">161</span></a><span class="sd">                           if sample is None (default), samples from the N(mu,sigma) during training phase and</span>
</span><span id="ReadoutLayer.sample_grid-162"><a href="#ReadoutLayer.sample_grid-162"><span class="linenos">162</span></a><span class="sd">                             fixes to the mean, mu, during evaluation phase.</span>
</span><span id="ReadoutLayer.sample_grid-163"><a href="#ReadoutLayer.sample_grid-163"><span class="linenos">163</span></a><span class="sd">                           if sample is True/False, overrides the model_state (i.e training or eval) and does as instructed</span>
</span><span id="ReadoutLayer.sample_grid-164"><a href="#ReadoutLayer.sample_grid-164"><span class="linenos">164</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.sample_grid-165"><a href="#ReadoutLayer.sample_grid-165"><span class="linenos">165</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="ReadoutLayer.sample_grid-166"><a href="#ReadoutLayer.sample_grid-166"><span class="linenos">166</span></a>            <span class="c1">#self.mu.clamp(min=-1, max=1)  # at eval time, only self.mu is used so it must belong to [-1,1]</span>
</span><span id="ReadoutLayer.sample_grid-167"><a href="#ReadoutLayer.sample_grid-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">!=</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-168"><a href="#ReadoutLayer.sample_grid-168"><span class="linenos">168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sigma/variance is always a positive quantity</span>
</span><span id="ReadoutLayer.sample_grid-169"><a href="#ReadoutLayer.sample_grid-169"><span class="linenos">169</span></a>
</span><span id="ReadoutLayer.sample_grid-170"><a href="#ReadoutLayer.sample_grid-170"><span class="linenos">170</span></a>        <span class="n">grid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayer.sample_grid-171"><a href="#ReadoutLayer.sample_grid-171"><span class="linenos">171</span></a>                
</span><span id="ReadoutLayer.sample_grid-172"><a href="#ReadoutLayer.sample_grid-172"><span class="linenos">172</span></a>        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sample</span>
</span><span id="ReadoutLayer.sample_grid-173"><a href="#ReadoutLayer.sample_grid-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-174"><a href="#ReadoutLayer.sample_grid-174"><span class="linenos">174</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">grid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="ReadoutLayer.sample_grid-175"><a href="#ReadoutLayer.sample_grid-175"><span class="linenos">175</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-176"><a href="#ReadoutLayer.sample_grid-176"><span class="linenos">176</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">grid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayer.sample_grid-177"><a href="#ReadoutLayer.sample_grid-177"><span class="linenos">177</span></a>        
</span><span id="ReadoutLayer.sample_grid-178"><a href="#ReadoutLayer.sample_grid-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-179"><a href="#ReadoutLayer.sample_grid-179"><span class="linenos">179</span></a>            <span class="c1"># this is dan&#39;s 1-d kluge code -- necessary because grid_sampler has to have last dimension of 2. maybe problem....</span>
</span><span id="ReadoutLayer.sample_grid-180"><a href="#ReadoutLayer.sample_grid-180"><span class="linenos">180</span></a>            <span class="n">grid2d</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayer.sample_grid-181"><a href="#ReadoutLayer.sample_grid-181"><span class="linenos">181</span></a>            <span class="c1">#grid2d[:,:,:,0] = (norm * self.sigma + self.mu).clamp(-1,1).squeeze(-1)</span>
</span><span id="ReadoutLayer.sample_grid-182"><a href="#ReadoutLayer.sample_grid-182"><span class="linenos">182</span></a>            <span class="c1">## SEEMS dim-4 HAS TO BE IN THE SECOND DIMENSION (RATHER THAN FIRST)</span>
</span><span id="ReadoutLayer.sample_grid-183"><a href="#ReadoutLayer.sample_grid-183"><span class="linenos">183</span></a>            <span class="n">grid2d</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayer.sample_grid-184"><a href="#ReadoutLayer.sample_grid-184"><span class="linenos">184</span></a>            <span class="k">return</span> <span class="n">grid2d</span>
</span><span id="ReadoutLayer.sample_grid-185"><a href="#ReadoutLayer.sample_grid-185"><span class="linenos">185</span></a>            <span class="c1">#return (norm * self.sigma + self.mu).clamp(-1,1) # this needs second dimension</span>
</span><span id="ReadoutLayer.sample_grid-186"><a href="#ReadoutLayer.sample_grid-186"><span class="linenos">186</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-187"><a href="#ReadoutLayer.sample_grid-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_type</span> <span class="o">!=</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-188"><a href="#ReadoutLayer.sample_grid-188"><span class="linenos">188</span></a>                <span class="c1"># grid locations in feature space sampled randomly around the mean self.mu</span>
</span><span id="ReadoutLayer.sample_grid-189"><a href="#ReadoutLayer.sample_grid-189"><span class="linenos">189</span></a>                <span class="c1">#return (norm * self.sigma + self.mu).clamp(-1,1)</span>
</span><span id="ReadoutLayer.sample_grid-190"><a href="#ReadoutLayer.sample_grid-190"><span class="linenos">190</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">norm</span><span class="p">[:,:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="ReadoutLayer.sample_grid-191"><a href="#ReadoutLayer.sample_grid-191"><span class="linenos">191</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.sample_grid-192"><a href="#ReadoutLayer.sample_grid-192"><span class="linenos">192</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ancd,bnid-&gt;bnic&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># grid locations in feature space sampled randomly around the mean self.mu</span>
</span></pre></div>


            <div class="docstring"><p>Returns the grid locations from the core by sampling from a Gaussian distribution
More specifically, it returns sampled positions for each batch over all elements, given mus and sigmas
If 'sample' is false, it just gives mu back (so testing has no randomness)
This code is inherited and then modified, so different style than most other</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>batch_size (int):</strong>  size of the batch</li>
<li><strong>sample (bool/None):</strong>  sample determines whether we draw a sample from Gaussian distribution, N(mu,sigma), defined per neuron
 or use the mean, mu, of the Gaussian distribution without sampling.
if sample is None (default), samples from the N(mu,sigma) during training phase and
  fixes to the mean, mu, during evaluation phase.
if sample is True/False, overrides the model_state (i.e training or eval) and does as instructed</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer.get_weights" class="classattr">
                                        <input id="ReadoutLayer.get_weights-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_weights</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">to_reshape</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">time_reverse</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">num_inh</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.get_weights-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.get_weights"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.get_weights-195"><a href="#ReadoutLayer.get_weights-195"><span class="linenos">195</span></a>    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_reshape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_reverse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_inh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer.get_weights-196"><a href="#ReadoutLayer.get_weights-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.get_weights-197"><a href="#ReadoutLayer.get_weights-197"><span class="linenos">197</span></a><span class="sd">        Overloaded to read not use preprocess weights but instead use layer property features.</span>
</span><span id="ReadoutLayer.get_weights-198"><a href="#ReadoutLayer.get_weights-198"><span class="linenos">198</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.get_weights-199"><a href="#ReadoutLayer.get_weights-199"><span class="linenos">199</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.get_weights-200"><a href="#ReadoutLayer.get_weights-200"><span class="linenos">200</span></a><span class="sd">            to_reshape (bool): whether to reshape the weights to the filter_dims</span>
</span><span id="ReadoutLayer.get_weights-201"><a href="#ReadoutLayer.get_weights-201"><span class="linenos">201</span></a><span class="sd">            time_reverse (bool): whether to reverse the time dimension</span>
</span><span id="ReadoutLayer.get_weights-202"><a href="#ReadoutLayer.get_weights-202"><span class="linenos">202</span></a><span class="sd">            num_inh (int): number of inhibitory units</span>
</span><span id="ReadoutLayer.get_weights-203"><a href="#ReadoutLayer.get_weights-203"><span class="linenos">203</span></a>
</span><span id="ReadoutLayer.get_weights-204"><a href="#ReadoutLayer.get_weights-204"><span class="linenos">204</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer.get_weights-205"><a href="#ReadoutLayer.get_weights-205"><span class="linenos">205</span></a><span class="sd">            ws: weights of the readout layer</span>
</span><span id="ReadoutLayer.get_weights-206"><a href="#ReadoutLayer.get_weights-206"><span class="linenos">206</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.get_weights-207"><a href="#ReadoutLayer.get_weights-207"><span class="linenos">207</span></a>
</span><span id="ReadoutLayer.get_weights-208"><a href="#ReadoutLayer.get_weights-208"><span class="linenos">208</span></a>        <span class="k">assert</span> <span class="n">time_reverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  READOUT: time_reverse will not work here.&quot;</span>
</span><span id="ReadoutLayer.get_weights-209"><a href="#ReadoutLayer.get_weights-209"><span class="linenos">209</span></a>        <span class="k">assert</span> <span class="n">num_inh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  READOUT: num_inh will not work here.&quot;</span>
</span><span id="ReadoutLayer.get_weights-210"><a href="#ReadoutLayer.get_weights-210"><span class="linenos">210</span></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
</span><span id="ReadoutLayer.get_weights-211"><a href="#ReadoutLayer.get_weights-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">to_reshape</span><span class="p">:</span>
</span><span id="ReadoutLayer.get_weights-212"><a href="#ReadoutLayer.get_weights-212"><span class="linenos">212</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="ReadoutLayer.get_weights-213"><a href="#ReadoutLayer.get_weights-213"><span class="linenos">213</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.get_weights-214"><a href="#ReadoutLayer.get_weights-214"><span class="linenos">214</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="ReadoutLayer.get_weights-215"><a href="#ReadoutLayer.get_weights-215"><span class="linenos">215</span></a>
</span><span id="ReadoutLayer.get_weights-216"><a href="#ReadoutLayer.get_weights-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer.get_weights-217"><a href="#ReadoutLayer.get_weights-217"><span class="linenos">217</span></a>            <span class="c1"># Add singleton dimension corresponding to number of filters</span>
</span><span id="ReadoutLayer.get_weights-218"><a href="#ReadoutLayer.get_weights-218"><span class="linenos">218</span></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ReadoutLayer.get_weights-219"><a href="#ReadoutLayer.get_weights-219"><span class="linenos">219</span></a>    
</span><span id="ReadoutLayer.get_weights-220"><a href="#ReadoutLayer.get_weights-220"><span class="linenos">220</span></a>        <span class="k">return</span> <span class="n">ws</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Overloaded to read not use preprocess weights but instead use layer property features.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>to_reshape (bool):</strong>  whether to reshape the weights to the filter_dims</li>
<li><strong>time_reverse (bool):</strong>  whether to reverse the time dimension</li>
<li><strong>num_inh (int):</strong>  number of inhibitory units</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>ws: weights of the readout layer</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayer.compute_reg_loss" class="classattr">
                                        <input id="ReadoutLayer.compute_reg_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.compute_reg_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.compute_reg_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.compute_reg_loss-257"><a href="#ReadoutLayer.compute_reg_loss-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="nf">compute_reg_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer.compute_reg_loss-258"><a href="#ReadoutLayer.compute_reg_loss-258"><span class="linenos">258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.compute_reg_loss-259"><a href="#ReadoutLayer.compute_reg_loss-259"><span class="linenos">259</span></a><span class="sd">        Compute the regularization loss for the layer: superceding super, by calling reg_module to do</span>
</span><span id="ReadoutLayer.compute_reg_loss-260"><a href="#ReadoutLayer.compute_reg_loss-260"><span class="linenos">260</span></a><span class="sd">        this and then adding scaffold weight regularization if needed.</span>
</span><span id="ReadoutLayer.compute_reg_loss-261"><a href="#ReadoutLayer.compute_reg_loss-261"><span class="linenos">261</span></a>
</span><span id="ReadoutLayer.compute_reg_loss-262"><a href="#ReadoutLayer.compute_reg_loss-262"><span class="linenos">262</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.compute_reg_loss-263"><a href="#ReadoutLayer.compute_reg_loss-263"><span class="linenos">263</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer.compute_reg_loss-264"><a href="#ReadoutLayer.compute_reg_loss-264"><span class="linenos">264</span></a>
</span><span id="ReadoutLayer.compute_reg_loss-265"><a href="#ReadoutLayer.compute_reg_loss-265"><span class="linenos">265</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer.compute_reg_loss-266"><a href="#ReadoutLayer.compute_reg_loss-266"><span class="linenos">266</span></a><span class="sd">            reg_loss: torch.Tensor, regularization loss</span>
</span><span id="ReadoutLayer.compute_reg_loss-267"><a href="#ReadoutLayer.compute_reg_loss-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.compute_reg_loss-268"><a href="#ReadoutLayer.compute_reg_loss-268"><span class="linenos">268</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_weights</span><span class="p">()</span>
</span><span id="ReadoutLayer.compute_reg_loss-269"><a href="#ReadoutLayer.compute_reg_loss-269"><span class="linenos">269</span></a>        <span class="n">regloss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">compute_reg_loss</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="ReadoutLayer.compute_reg_loss-270"><a href="#ReadoutLayer.compute_reg_loss-270"><span class="linenos">270</span></a>
</span><span id="ReadoutLayer.compute_reg_loss-271"><a href="#ReadoutLayer.compute_reg_loss-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_reg</span><span class="p">:</span>
</span><span id="ReadoutLayer.compute_reg_loss-272"><a href="#ReadoutLayer.compute_reg_loss-272"><span class="linenos">272</span></a>            <span class="n">regloss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">w</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaffold_level_weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="p">)</span> 
</span><span id="ReadoutLayer.compute_reg_loss-273"><a href="#ReadoutLayer.compute_reg_loss-273"><span class="linenos">273</span></a>        <span class="k">return</span> <span class="n">regloss</span>
</span><span id="ReadoutLayer.compute_reg_loss-274"><a href="#ReadoutLayer.compute_reg_loss-274"><span class="linenos">274</span></a>        <span class="c1"># ReadoutLayer.compute_reg_loss()</span>
</span></pre></div>


            <div class="docstring"><p>Compute the regularization loss for the layer: superceding super, by calling reg_module to do
this and then adding scaffold weight regularization if needed.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>reg_loss: torch.Tensor, regularization loss</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayer.forward" class="classattr">
                                        <input id="ReadoutLayer.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">shift</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.forward-276"><a href="#ReadoutLayer.forward-276"><span class="linenos">276</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer.forward-277"><a href="#ReadoutLayer.forward-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.forward-278"><a href="#ReadoutLayer.forward-278"><span class="linenos">278</span></a><span class="sd">        Propagates the input forwards through the readout.</span>
</span><span id="ReadoutLayer.forward-279"><a href="#ReadoutLayer.forward-279"><span class="linenos">279</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.forward-280"><a href="#ReadoutLayer.forward-280"><span class="linenos">280</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.forward-281"><a href="#ReadoutLayer.forward-281"><span class="linenos">281</span></a><span class="sd">            x: input data</span>
</span><span id="ReadoutLayer.forward-282"><a href="#ReadoutLayer.forward-282"><span class="linenos">282</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="ReadoutLayer.forward-283"><a href="#ReadoutLayer.forward-283"><span class="linenos">283</span></a>
</span><span id="ReadoutLayer.forward-284"><a href="#ReadoutLayer.forward-284"><span class="linenos">284</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer.forward-285"><a href="#ReadoutLayer.forward-285"><span class="linenos">285</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="ReadoutLayer.forward-286"><a href="#ReadoutLayer.forward-286"><span class="linenos">286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.forward-287"><a href="#ReadoutLayer.forward-287"><span class="linenos">287</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="ReadoutLayer.forward-288"><a href="#ReadoutLayer.forward-288"><span class="linenos">288</span></a>
</span><span id="ReadoutLayer.forward-289"><a href="#ReadoutLayer.forward-289"><span class="linenos">289</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="ReadoutLayer.forward-290"><a href="#ReadoutLayer.forward-290"><span class="linenos">290</span></a>        <span class="n">c_in</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="n">h_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayer.forward-291"><a href="#ReadoutLayer.forward-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">c_in</span><span class="p">,</span> <span class="n">w_in</span><span class="p">,</span> <span class="n">h_in</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span><span id="ReadoutLayer.forward-292"><a href="#ReadoutLayer.forward-292"><span class="linenos">292</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer.forward-293"><a href="#ReadoutLayer.forward-293"><span class="linenos">293</span></a>        
</span><span id="ReadoutLayer.forward-294"><a href="#ReadoutLayer.forward-294"><span class="linenos">294</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>  <span class="c1"># this is the filter weights for each unit</span>
</span><span id="ReadoutLayer.forward-295"><a href="#ReadoutLayer.forward-295"><span class="linenos">295</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="ReadoutLayer.forward-296"><a href="#ReadoutLayer.forward-296"><span class="linenos">296</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="ReadoutLayer.forward-297"><a href="#ReadoutLayer.forward-297"><span class="linenos">297</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayer.forward-298"><a href="#ReadoutLayer.forward-298"><span class="linenos">298</span></a>
</span><span id="ReadoutLayer.forward-299"><a href="#ReadoutLayer.forward-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="ReadoutLayer.forward-300"><a href="#ReadoutLayer.forward-300"><span class="linenos">300</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayer.forward-301"><a href="#ReadoutLayer.forward-301"><span class="linenos">301</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayer.forward-302"><a href="#ReadoutLayer.forward-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.forward-303"><a href="#ReadoutLayer.forward-303"><span class="linenos">303</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayer.forward-304"><a href="#ReadoutLayer.forward-304"><span class="linenos">304</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer.forward-305"><a href="#ReadoutLayer.forward-305"><span class="linenos">305</span></a>        
</span><span id="ReadoutLayer.forward-306"><a href="#ReadoutLayer.forward-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer.forward-307"><a href="#ReadoutLayer.forward-307"><span class="linenos">307</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="ReadoutLayer.forward-308"><a href="#ReadoutLayer.forward-308"><span class="linenos">308</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ReadoutLayer.forward-309"><a href="#ReadoutLayer.forward-309"><span class="linenos">309</span></a>
</span><span id="ReadoutLayer.forward-310"><a href="#ReadoutLayer.forward-310"><span class="linenos">310</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer.forward-311"><a href="#ReadoutLayer.forward-311"><span class="linenos">311</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="ReadoutLayer.forward-312"><a href="#ReadoutLayer.forward-312"><span class="linenos">312</span></a>
</span><span id="ReadoutLayer.forward-313"><a href="#ReadoutLayer.forward-313"><span class="linenos">313</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="ReadoutLayer.forward-314"><a href="#ReadoutLayer.forward-314"><span class="linenos">314</span></a>
</span><span id="ReadoutLayer.forward-315"><a href="#ReadoutLayer.forward-315"><span class="linenos">315</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer.forward-316"><a href="#ReadoutLayer.forward-316"><span class="linenos">316</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="ReadoutLayer.forward-317"><a href="#ReadoutLayer.forward-317"><span class="linenos">317</span></a>        
</span><span id="ReadoutLayer.forward-318"><a href="#ReadoutLayer.forward-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer.forward-319"><a href="#ReadoutLayer.forward-319"><span class="linenos">319</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="ReadoutLayer.forward-320"><a href="#ReadoutLayer.forward-320"><span class="linenos">320</span></a>        
</span><span id="ReadoutLayer.forward-321"><a href="#ReadoutLayer.forward-321"><span class="linenos">321</span></a>        <span class="k">return</span> <span class="n">y</span>
</span></pre></div>


            <div class="docstring"><p>Propagates the input forwards through the readout.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>x:</strong>  input data</li>
<li><strong>shift (bool):</strong>  shifts the location of the grid (from eye-tracking data)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>y: neuronal activity</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayer.set_readout_locations" class="classattr">
                                        <input id="ReadoutLayer.set_readout_locations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_readout_locations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">locs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.set_readout_locations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.set_readout_locations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.set_readout_locations-324"><a href="#ReadoutLayer.set_readout_locations-324"><span class="linenos">324</span></a>    <span class="k">def</span> <span class="nf">set_readout_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">):</span>
</span><span id="ReadoutLayer.set_readout_locations-325"><a href="#ReadoutLayer.set_readout_locations-325"><span class="linenos">325</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.set_readout_locations-326"><a href="#ReadoutLayer.set_readout_locations-326"><span class="linenos">326</span></a><span class="sd">        This hasn&#39;t been tested yet, but should be self-explanatory.</span>
</span><span id="ReadoutLayer.set_readout_locations-327"><a href="#ReadoutLayer.set_readout_locations-327"><span class="linenos">327</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.set_readout_locations-328"><a href="#ReadoutLayer.set_readout_locations-328"><span class="linenos">328</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.set_readout_locations-329"><a href="#ReadoutLayer.set_readout_locations-329"><span class="linenos">329</span></a><span class="sd">            locs: locations of the readout units</span>
</span><span id="ReadoutLayer.set_readout_locations-330"><a href="#ReadoutLayer.set_readout_locations-330"><span class="linenos">330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.set_readout_locations-331"><a href="#ReadoutLayer.set_readout_locations-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ReadoutLayer.set_readout_locations-332"><a href="#ReadoutLayer.set_readout_locations-332"><span class="linenos">332</span></a>            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayer.set_readout_locations-333"><a href="#ReadoutLayer.set_readout_locations-333"><span class="linenos">333</span></a>        <span class="n">NC</span><span class="p">,</span> <span class="n">num_dim</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ReadoutLayer.set_readout_locations-334"><a href="#ReadoutLayer.set_readout_locations-334"><span class="linenos">334</span></a>        <span class="k">assert</span> <span class="n">num_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of spatial dimensions&#39;</span>
</span><span id="ReadoutLayer.set_readout_locations-335"><a href="#ReadoutLayer.set_readout_locations-335"><span class="linenos">335</span></a>        <span class="k">assert</span> <span class="n">NC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of neuron positions.&#39;</span>
</span><span id="ReadoutLayer.set_readout_locations-336"><a href="#ReadoutLayer.set_readout_locations-336"><span class="linenos">336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This hasn't been tested yet, but should be self-explanatory.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>locs:</strong>  locations of the readout units</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer.get_readout_locations" class="classattr">
                                        <input id="ReadoutLayer.get_readout_locations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_readout_locations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.get_readout_locations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.get_readout_locations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.get_readout_locations-338"><a href="#ReadoutLayer.get_readout_locations-338"><span class="linenos">338</span></a>    <span class="k">def</span> <span class="nf">get_readout_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer.get_readout_locations-339"><a href="#ReadoutLayer.get_readout_locations-339"><span class="linenos">339</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.get_readout_locations-340"><a href="#ReadoutLayer.get_readout_locations-340"><span class="linenos">340</span></a><span class="sd">        Currently returns center location and sigmas, as list.</span>
</span><span id="ReadoutLayer.get_readout_locations-341"><a href="#ReadoutLayer.get_readout_locations-341"><span class="linenos">341</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.get_readout_locations-342"><a href="#ReadoutLayer.get_readout_locations-342"><span class="linenos">342</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer.get_readout_locations-343"><a href="#ReadoutLayer.get_readout_locations-343"><span class="linenos">343</span></a><span class="sd">            mu: center locations of the readout units</span>
</span><span id="ReadoutLayer.get_readout_locations-344"><a href="#ReadoutLayer.get_readout_locations-344"><span class="linenos">344</span></a><span class="sd">            sigma: sigmas of the readout units</span>
</span><span id="ReadoutLayer.get_readout_locations-345"><a href="#ReadoutLayer.get_readout_locations-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.get_readout_locations-346"><a href="#ReadoutLayer.get_readout_locations-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>    
</span></pre></div>


            <div class="docstring"><p>Currently returns center location and sigmas, as list.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>mu: center locations of the readout units
  sigma: sigmas of the readout units</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayer.passive_readout" class="classattr">
                                        <input id="ReadoutLayer.passive_readout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">passive_readout</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.passive_readout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.passive_readout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.passive_readout-348"><a href="#ReadoutLayer.passive_readout-348"><span class="linenos">348</span></a>    <span class="k">def</span> <span class="nf">passive_readout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer.passive_readout-349"><a href="#ReadoutLayer.passive_readout-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.passive_readout-350"><a href="#ReadoutLayer.passive_readout-350"><span class="linenos">350</span></a><span class="sd">        This will not fit mu and std, but set them to zero. It will pass identities in,</span>
</span><span id="ReadoutLayer.passive_readout-351"><a href="#ReadoutLayer.passive_readout-351"><span class="linenos">351</span></a><span class="sd">        so number of input filters must equal number of readout units.</span>
</span><span id="ReadoutLayer.passive_readout-352"><a href="#ReadoutLayer.passive_readout-352"><span class="linenos">352</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.passive_readout-353"><a href="#ReadoutLayer.passive_readout-353"><span class="linenos">353</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.passive_readout-354"><a href="#ReadoutLayer.passive_readout-354"><span class="linenos">354</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer.passive_readout-355"><a href="#ReadoutLayer.passive_readout-355"><span class="linenos">355</span></a>
</span><span id="ReadoutLayer.passive_readout-356"><a href="#ReadoutLayer.passive_readout-356"><span class="linenos">356</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer.passive_readout-357"><a href="#ReadoutLayer.passive_readout-357"><span class="linenos">357</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer.passive_readout-358"><a href="#ReadoutLayer.passive_readout-358"><span class="linenos">358</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.passive_readout-359"><a href="#ReadoutLayer.passive_readout-359"><span class="linenos">359</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Must have #filters = #output units.&quot;</span>
</span><span id="ReadoutLayer.passive_readout-360"><a href="#ReadoutLayer.passive_readout-360"><span class="linenos">360</span></a>        <span class="c1"># Set parameters for default readout</span>
</span><span id="ReadoutLayer.passive_readout-361"><a href="#ReadoutLayer.passive_readout-361"><span class="linenos">361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer.passive_readout-362"><a href="#ReadoutLayer.passive_readout-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer.passive_readout-363"><a href="#ReadoutLayer.passive_readout-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer.passive_readout-364"><a href="#ReadoutLayer.passive_readout-364"><span class="linenos">364</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">):</span>
</span><span id="ReadoutLayer.passive_readout-365"><a href="#ReadoutLayer.passive_readout-365"><span class="linenos">365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer.passive_readout-366"><a href="#ReadoutLayer.passive_readout-366"><span class="linenos">366</span></a>
</span><span id="ReadoutLayer.passive_readout-367"><a href="#ReadoutLayer.passive_readout-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ReadoutLayer.passive_readout-368"><a href="#ReadoutLayer.passive_readout-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>This will not fit mu and std, but set them to zero. It will pass identities in,
so number of input filters must equal number of readout units.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayer.fit_mus" class="classattr">
                                        <input id="ReadoutLayer.fit_mus-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_mus</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">sigma</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.fit_mus-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.fit_mus"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.fit_mus-370"><a href="#ReadoutLayer.fit_mus-370"><span class="linenos">370</span></a>    <span class="k">def</span> <span class="nf">fit_mus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="ReadoutLayer.fit_mus-371"><a href="#ReadoutLayer.fit_mus-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.fit_mus-372"><a href="#ReadoutLayer.fit_mus-372"><span class="linenos">372</span></a><span class="sd">        Quick function that turns on or off fitting mus/sigmas and toggles sample</span>
</span><span id="ReadoutLayer.fit_mus-373"><a href="#ReadoutLayer.fit_mus-373"><span class="linenos">373</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.fit_mus-374"><a href="#ReadoutLayer.fit_mus-374"><span class="linenos">374</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.fit_mus-375"><a href="#ReadoutLayer.fit_mus-375"><span class="linenos">375</span></a><span class="sd">            val (bool): True or False -- must specify</span>
</span><span id="ReadoutLayer.fit_mus-376"><a href="#ReadoutLayer.fit_mus-376"><span class="linenos">376</span></a><span class="sd">            sigma (float): choose starting sigma value (default no choice)</span>
</span><span id="ReadoutLayer.fit_mus-377"><a href="#ReadoutLayer.fit_mus-377"><span class="linenos">377</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.fit_mus-378"><a href="#ReadoutLayer.fit_mus-378"><span class="linenos">378</span></a>        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fit_mus(): must set val to be True or False&quot;</span>
</span><span id="ReadoutLayer.fit_mus-379"><a href="#ReadoutLayer.fit_mus-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="ReadoutLayer.fit_mus-380"><a href="#ReadoutLayer.fit_mus-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer.fit_mus-381"><a href="#ReadoutLayer.fit_mus-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer.fit_mus-382"><a href="#ReadoutLayer.fit_mus-382"><span class="linenos">382</span></a>        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer.fit_mus-383"><a href="#ReadoutLayer.fit_mus-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="ReadoutLayer.fit_mus-384"><a href="#ReadoutLayer.fit_mus-384"><span class="linenos">384</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ReadoutLayer.fit_mus-385"><a href="#ReadoutLayer.fit_mus-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="ReadoutLayer.fit_mus-386"><a href="#ReadoutLayer.fit_mus-386"><span class="linenos">386</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: fitting mus&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer.fit_mus-387"><a href="#ReadoutLayer.fit_mus-387"><span class="linenos">387</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer.fit_mus-388"><a href="#ReadoutLayer.fit_mus-388"><span class="linenos">388</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: not fitting mus&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Quick function that turns on or off fitting mus/sigmas and toggles sample</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>val (bool):</strong>  True or False -- must specify</li>
<li><strong>sigma (float):</strong>  choose starting sigma value (default no choice)</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer.enforce_grid" class="classattr">
                                        <input id="ReadoutLayer.enforce_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">enforce_grid</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.enforce_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.enforce_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.enforce_grid-391"><a href="#ReadoutLayer.enforce_grid-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">enforce_grid</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="ReadoutLayer.enforce_grid-392"><a href="#ReadoutLayer.enforce_grid-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.enforce_grid-393"><a href="#ReadoutLayer.enforce_grid-393"><span class="linenos">393</span></a><span class="sd">        Function that adjusts mus to correspond to precise points on pixel grid</span>
</span><span id="ReadoutLayer.enforce_grid-394"><a href="#ReadoutLayer.enforce_grid-394"><span class="linenos">394</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer.enforce_grid-395"><a href="#ReadoutLayer.enforce_grid-395"><span class="linenos">395</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.enforce_grid-396"><a href="#ReadoutLayer.enforce_grid-396"><span class="linenos">396</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer.enforce_grid-397"><a href="#ReadoutLayer.enforce_grid-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.enforce_grid-398"><a href="#ReadoutLayer.enforce_grid-398"><span class="linenos">398</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayer.enforce_grid-399"><a href="#ReadoutLayer.enforce_grid-399"><span class="linenos">399</span></a>
</span><span id="ReadoutLayer.enforce_grid-400"><a href="#ReadoutLayer.enforce_grid-400"><span class="linenos">400</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="ReadoutLayer.enforce_grid-401"><a href="#ReadoutLayer.enforce_grid-401"><span class="linenos">401</span></a>        <span class="n">pixels</span><span class="p">[</span><span class="n">pixels</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">1</span>
</span><span id="ReadoutLayer.enforce_grid-402"><a href="#ReadoutLayer.enforce_grid-402"><span class="linenos">402</span></a>        <span class="n">pixels</span><span class="p">[</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ReadoutLayer.enforce_grid-403"><a href="#ReadoutLayer.enforce_grid-403"><span class="linenos">403</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="ReadoutLayer.enforce_grid-404"><a href="#ReadoutLayer.enforce_grid-404"><span class="linenos">404</span></a>
</span><span id="ReadoutLayer.enforce_grid-405"><a href="#ReadoutLayer.enforce_grid-405"><span class="linenos">405</span></a>        <span class="c1"># Convert back to mu values</span>
</span><span id="ReadoutLayer.enforce_grid-406"><a href="#ReadoutLayer.enforce_grid-406"><span class="linenos">406</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pixels</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Function that adjusts mus to correspond to precise points on pixel grid</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer.layer_dict" class="classattr">
                                        <input id="ReadoutLayer.layer_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">layer_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer.layer_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer.layer_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer.layer_dict-412"><a href="#ReadoutLayer.layer_dict-412"><span class="linenos">412</span></a>    <span class="nd">@classmethod</span>
</span><span id="ReadoutLayer.layer_dict-413"><a href="#ReadoutLayer.layer_dict-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer.layer_dict-414"><a href="#ReadoutLayer.layer_dict-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.layer_dict-415"><a href="#ReadoutLayer.layer_dict-415"><span class="linenos">415</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="ReadoutLayer.layer_dict-416"><a href="#ReadoutLayer.layer_dict-416"><span class="linenos">416</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="ReadoutLayer.layer_dict-417"><a href="#ReadoutLayer.layer_dict-417"><span class="linenos">417</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="ReadoutLayer.layer_dict-418"><a href="#ReadoutLayer.layer_dict-418"><span class="linenos">418</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="ReadoutLayer.layer_dict-419"><a href="#ReadoutLayer.layer_dict-419"><span class="linenos">419</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="ReadoutLayer.layer_dict-420"><a href="#ReadoutLayer.layer_dict-420"><span class="linenos">420</span></a>
</span><span id="ReadoutLayer.layer_dict-421"><a href="#ReadoutLayer.layer_dict-421"><span class="linenos">421</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer.layer_dict-422"><a href="#ReadoutLayer.layer_dict-422"><span class="linenos">422</span></a><span class="sd">            NLtype: str, type of nonlinearity</span>
</span><span id="ReadoutLayer.layer_dict-423"><a href="#ReadoutLayer.layer_dict-423"><span class="linenos">423</span></a>
</span><span id="ReadoutLayer.layer_dict-424"><a href="#ReadoutLayer.layer_dict-424"><span class="linenos">424</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer.layer_dict-425"><a href="#ReadoutLayer.layer_dict-425"><span class="linenos">425</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="ReadoutLayer.layer_dict-426"><a href="#ReadoutLayer.layer_dict-426"><span class="linenos">426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer.layer_dict-427"><a href="#ReadoutLayer.layer_dict-427"><span class="linenos">427</span></a>
</span><span id="ReadoutLayer.layer_dict-428"><a href="#ReadoutLayer.layer_dict-428"><span class="linenos">428</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer.layer_dict-429"><a href="#ReadoutLayer.layer_dict-429"><span class="linenos">429</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readout&#39;</span>
</span><span id="ReadoutLayer.layer_dict-430"><a href="#ReadoutLayer.layer_dict-430"><span class="linenos">430</span></a>        <span class="c1"># Added arguments</span>
</span><span id="ReadoutLayer.layer_dict-431"><a href="#ReadoutLayer.layer_dict-431"><span class="linenos">431</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ReadoutLayer.layer_dict-432"><a href="#ReadoutLayer.layer_dict-432"><span class="linenos">432</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_mu_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="ReadoutLayer.layer_dict-433"><a href="#ReadoutLayer.layer_dict-433"><span class="linenos">433</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="ReadoutLayer.layer_dict-434"><a href="#ReadoutLayer.layer_dict-434"><span class="linenos">434</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;gauss_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;isotropic&#39;</span> <span class="c1">#&#39;uncorrelated&#39;</span>
</span><span id="ReadoutLayer.layer_dict-435"><a href="#ReadoutLayer.layer_dict-435"><span class="linenos">435</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;align_corners&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayer.layer_dict-436"><a href="#ReadoutLayer.layer_dict-436"><span class="linenos">436</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># also &#39;nearest&#39;</span>
</span><span id="ReadoutLayer.layer_dict-437"><a href="#ReadoutLayer.layer_dict-437"><span class="linenos">437</span></a>        <span class="c1"># Change default -- readouts will usually be softplus</span>
</span><span id="ReadoutLayer.layer_dict-438"><a href="#ReadoutLayer.layer_dict-438"><span class="linenos">438</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;NLtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NLtype</span>
</span><span id="ReadoutLayer.layer_dict-439"><a href="#ReadoutLayer.layer_dict-439"><span class="linenos">439</span></a>
</span><span id="ReadoutLayer.layer_dict-440"><a href="#ReadoutLayer.layer_dict-440"><span class="linenos">440</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span></pre></div>


            <div class="docstring"><p>This outputs a dictionary of parameters that need to input into the layer to completely specify.
Output is a dictionary with these keywords. 
-- All layer-specific inputs are included in the returned dict
-- Values that must be set are set to empty lists
-- Other values will be given their defaults</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>NLtype:</strong>  str, type of nonlinearity</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Ldict: dictionary of layer parameters</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="ndnlayer.html#NDNLayer">NDNT.modules.layers.ndnlayer.NDNLayer</a></dt>
                                <dd id="ReadoutLayer.input_dims" class="variable"><a href="ndnlayer.html#NDNLayer.input_dims">input_dims</a></dd>
                <dd id="ReadoutLayer.num_filters" class="variable"><a href="ndnlayer.html#NDNLayer.num_filters">num_filters</a></dd>
                <dd id="ReadoutLayer.output_dims" class="variable"><a href="ndnlayer.html#NDNLayer.output_dims">output_dims</a></dd>
                <dd id="ReadoutLayer.norm_type" class="variable"><a href="ndnlayer.html#NDNLayer.norm_type">norm_type</a></dd>
                <dd id="ReadoutLayer.pos_constraint" class="variable"><a href="ndnlayer.html#NDNLayer.pos_constraint">pos_constraint</a></dd>
                <dd id="ReadoutLayer.conv" class="variable"><a href="ndnlayer.html#NDNLayer.conv">conv</a></dd>
                <dd id="ReadoutLayer.NL" class="variable"><a href="ndnlayer.html#NDNLayer.NL">NL</a></dd>
                <dd id="ReadoutLayer.shape" class="variable"><a href="ndnlayer.html#NDNLayer.shape">shape</a></dd>
                <dd id="ReadoutLayer.weight_scale" class="variable"><a href="ndnlayer.html#NDNLayer.weight_scale">weight_scale</a></dd>
                <dd id="ReadoutLayer.weight" class="variable"><a href="ndnlayer.html#NDNLayer.weight">weight</a></dd>
                <dd id="ReadoutLayer.reg" class="variable"><a href="ndnlayer.html#NDNLayer.reg">reg</a></dd>
                <dd id="ReadoutLayer.num_inh" class="variable"><a href="ndnlayer.html#NDNLayer.num_inh">num_inh</a></dd>
                <dd id="ReadoutLayer.reset_parameters" class="function"><a href="ndnlayer.html#NDNLayer.reset_parameters">reset_parameters</a></dd>
                <dd id="ReadoutLayer.initialize_gaussian_envelope" class="function"><a href="ndnlayer.html#NDNLayer.initialize_gaussian_envelope">initialize_gaussian_envelope</a></dd>
                <dd id="ReadoutLayer.preprocess_weights" class="function"><a href="ndnlayer.html#NDNLayer.preprocess_weights">preprocess_weights</a></dd>
                <dd id="ReadoutLayer.list_parameters" class="function"><a href="ndnlayer.html#NDNLayer.list_parameters">list_parameters</a></dd>
                <dd id="ReadoutLayer.set_parameters" class="function"><a href="ndnlayer.html#NDNLayer.set_parameters">set_parameters</a></dd>
                <dd id="ReadoutLayer.set_reg_val" class="function"><a href="ndnlayer.html#NDNLayer.set_reg_val">set_reg_val</a></dd>
                <dd id="ReadoutLayer.plot_filters" class="function"><a href="ndnlayer.html#NDNLayer.plot_filters">plot_filters</a></dd>
                <dd id="ReadoutLayer.info" class="function"><a href="ndnlayer.html#NDNLayer.info">info</a></dd>
                <dd id="ReadoutLayer.dim_info" class="function"><a href="ndnlayer.html#NDNLayer.dim_info">dim_info</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ReadoutLayer.dump_patches" class="variable">dump_patches</dd>
                <dd id="ReadoutLayer.training" class="variable">training</dd>
                <dd id="ReadoutLayer.call_super_init" class="variable">call_super_init</dd>
                <dd id="ReadoutLayer.register_buffer" class="function">register_buffer</dd>
                <dd id="ReadoutLayer.register_parameter" class="function">register_parameter</dd>
                <dd id="ReadoutLayer.add_module" class="function">add_module</dd>
                <dd id="ReadoutLayer.register_module" class="function">register_module</dd>
                <dd id="ReadoutLayer.get_submodule" class="function">get_submodule</dd>
                <dd id="ReadoutLayer.get_parameter" class="function">get_parameter</dd>
                <dd id="ReadoutLayer.get_buffer" class="function">get_buffer</dd>
                <dd id="ReadoutLayer.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ReadoutLayer.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ReadoutLayer.apply" class="function">apply</dd>
                <dd id="ReadoutLayer.cuda" class="function">cuda</dd>
                <dd id="ReadoutLayer.ipu" class="function">ipu</dd>
                <dd id="ReadoutLayer.xpu" class="function">xpu</dd>
                <dd id="ReadoutLayer.cpu" class="function">cpu</dd>
                <dd id="ReadoutLayer.type" class="function">type</dd>
                <dd id="ReadoutLayer.float" class="function">float</dd>
                <dd id="ReadoutLayer.double" class="function">double</dd>
                <dd id="ReadoutLayer.half" class="function">half</dd>
                <dd id="ReadoutLayer.bfloat16" class="function">bfloat16</dd>
                <dd id="ReadoutLayer.to_empty" class="function">to_empty</dd>
                <dd id="ReadoutLayer.to" class="function">to</dd>
                <dd id="ReadoutLayer.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ReadoutLayer.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ReadoutLayer.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ReadoutLayer.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ReadoutLayer.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ReadoutLayer.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ReadoutLayer.state_dict" class="function">state_dict</dd>
                <dd id="ReadoutLayer.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ReadoutLayer.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ReadoutLayer.parameters" class="function">parameters</dd>
                <dd id="ReadoutLayer.named_parameters" class="function">named_parameters</dd>
                <dd id="ReadoutLayer.buffers" class="function">buffers</dd>
                <dd id="ReadoutLayer.named_buffers" class="function">named_buffers</dd>
                <dd id="ReadoutLayer.children" class="function">children</dd>
                <dd id="ReadoutLayer.named_children" class="function">named_children</dd>
                <dd id="ReadoutLayer.modules" class="function">modules</dd>
                <dd id="ReadoutLayer.named_modules" class="function">named_modules</dd>
                <dd id="ReadoutLayer.train" class="function">train</dd>
                <dd id="ReadoutLayer.eval" class="function">eval</dd>
                <dd id="ReadoutLayer.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ReadoutLayer.zero_grad" class="function">zero_grad</dd>
                <dd id="ReadoutLayer.share_memory" class="function">share_memory</dd>
                <dd id="ReadoutLayer.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ReadoutLayer3d">
                            <input id="ReadoutLayer3d-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ReadoutLayer3d</span><wbr>(<span class="base"><a href="#ReadoutLayer">ReadoutLayer</a></span>):

                <label class="view-source-button" for="ReadoutLayer3d-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer3d"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer3d-444"><a href="#ReadoutLayer3d-444"><span class="linenos">444</span></a><span class="k">class</span> <span class="nc">ReadoutLayer3d</span><span class="p">(</span><span class="n">ReadoutLayer</span><span class="p">):</span>
</span><span id="ReadoutLayer3d-445"><a href="#ReadoutLayer3d-445"><span class="linenos">445</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-446"><a href="#ReadoutLayer3d-446"><span class="linenos">446</span></a><span class="sd">    ReadoutLayer3d for 3d readout.</span>
</span><span id="ReadoutLayer3d-447"><a href="#ReadoutLayer3d-447"><span class="linenos">447</span></a><span class="sd">    This is a subclass of ReadoutLayer, but with the added dimension of time.</span>
</span><span id="ReadoutLayer3d-448"><a href="#ReadoutLayer3d-448"><span class="linenos">448</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-449"><a href="#ReadoutLayer3d-449"><span class="linenos">449</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="ReadoutLayer3d-450"><a href="#ReadoutLayer3d-450"><span class="linenos">450</span></a>            <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ReadoutLayer3d-451"><a href="#ReadoutLayer3d-451"><span class="linenos">451</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer3d-452"><a href="#ReadoutLayer3d-452"><span class="linenos">452</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-453"><a href="#ReadoutLayer3d-453"><span class="linenos">453</span></a><span class="sd">        ReadoutLayer3d: 3d readout layer for NDNs.</span>
</span><span id="ReadoutLayer3d-454"><a href="#ReadoutLayer3d-454"><span class="linenos">454</span></a>
</span><span id="ReadoutLayer3d-455"><a href="#ReadoutLayer3d-455"><span class="linenos">455</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d-456"><a href="#ReadoutLayer3d-456"><span class="linenos">456</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, depth, lags)</span>
</span><span id="ReadoutLayer3d-457"><a href="#ReadoutLayer3d-457"><span class="linenos">457</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-458"><a href="#ReadoutLayer3d-458"><span class="linenos">458</span></a>        <span class="k">assert</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer3d: should not be using this layer if no 3rd dimension of input&quot;</span>
</span><span id="ReadoutLayer3d-459"><a href="#ReadoutLayer3d-459"><span class="linenos">459</span></a>
</span><span id="ReadoutLayer3d-460"><a href="#ReadoutLayer3d-460"><span class="linenos">460</span></a>        <span class="c1"># Need to tuck lag dimension into channel-dims so parent constructor makes the right filter shape</span>
</span><span id="ReadoutLayer3d-461"><a href="#ReadoutLayer3d-461"><span class="linenos">461</span></a>        <span class="n">input_dims_mod</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-462"><a href="#ReadoutLayer3d-462"><span class="linenos">462</span></a>        <span class="n">input_dims_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayer3d-463"><a href="#ReadoutLayer3d-463"><span class="linenos">463</span></a>        <span class="n">input_dims_mod</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer3d-464"><a href="#ReadoutLayer3d-464"><span class="linenos">464</span></a>                
</span><span id="ReadoutLayer3d-465"><a href="#ReadoutLayer3d-465"><span class="linenos">465</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims_mod</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-466"><a href="#ReadoutLayer3d-466"><span class="linenos">466</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="ReadoutLayer3d-467"><a href="#ReadoutLayer3d-467"><span class="linenos">467</span></a>        <span class="c1">#print(&#39;OLD FILTER DIMS&#39;, self.filter_dims)</span>
</span><span id="ReadoutLayer3d-468"><a href="#ReadoutLayer3d-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="ReadoutLayer3d-469"><a href="#ReadoutLayer3d-469"><span class="linenos">469</span></a>        <span class="c1">#self.filter_dims = [input_dims[0], input_dims[3], 1, 1]  # making spatial so max_space can be used</span>
</span><span id="ReadoutLayer3d-470"><a href="#ReadoutLayer3d-470"><span class="linenos">470</span></a>        <span class="c1">#print(&#39;NEW FILTER DIMS&#39;, self.filter_dims)</span>
</span><span id="ReadoutLayer3d-471"><a href="#ReadoutLayer3d-471"><span class="linenos">471</span></a>        <span class="c1"># Redo regularization with new filter_dims</span>
</span><span id="ReadoutLayer3d-472"><a href="#ReadoutLayer3d-472"><span class="linenos">472</span></a>      
</span><span id="ReadoutLayer3d-473"><a href="#ReadoutLayer3d-473"><span class="linenos">473</span></a>        <span class="kn">from</span> <span class="nn">...modules.regularization</span> <span class="kn">import</span> <span class="n">Regularization</span>
</span><span id="ReadoutLayer3d-474"><a href="#ReadoutLayer3d-474"><span class="linenos">474</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span>
</span><span id="ReadoutLayer3d-475"><a href="#ReadoutLayer3d-475"><span class="linenos">475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">Regularization</span><span class="p">(</span>
</span><span id="ReadoutLayer3d-476"><a href="#ReadoutLayer3d-476"><span class="linenos">476</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="n">reg_vals</span><span class="p">,</span> 
</span><span id="ReadoutLayer3d-477"><a href="#ReadoutLayer3d-477"><span class="linenos">477</span></a>            <span class="n">num_outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span> <span class="p">)</span>
</span><span id="ReadoutLayer3d-478"><a href="#ReadoutLayer3d-478"><span class="linenos">478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
</span><span id="ReadoutLayer3d-479"><a href="#ReadoutLayer3d-479"><span class="linenos">479</span></a>            <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span><span id="ReadoutLayer3d-480"><a href="#ReadoutLayer3d-480"><span class="linenos">480</span></a>    <span class="c1"># END ReadoutLayer3d.__init__</span>
</span><span id="ReadoutLayer3d-481"><a href="#ReadoutLayer3d-481"><span class="linenos">481</span></a>
</span><span id="ReadoutLayer3d-482"><a href="#ReadoutLayer3d-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">set_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ReadoutLayer3d-483"><a href="#ReadoutLayer3d-483"><span class="linenos">483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-484"><a href="#ReadoutLayer3d-484"><span class="linenos">484</span></a><span class="sd">        Sets mask -- instead of plugging in by hand. Registers mask as being set, and checks dimensions.</span>
</span><span id="ReadoutLayer3d-485"><a href="#ReadoutLayer3d-485"><span class="linenos">485</span></a><span class="sd">        Can also use to rest to have trivial mask (all 1s)</span>
</span><span id="ReadoutLayer3d-486"><a href="#ReadoutLayer3d-486"><span class="linenos">486</span></a><span class="sd">        Mask will be numpy, leave mask blank if want to set to default mask (all ones)</span>
</span><span id="ReadoutLayer3d-487"><a href="#ReadoutLayer3d-487"><span class="linenos">487</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer3d-488"><a href="#ReadoutLayer3d-488"><span class="linenos">488</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d-489"><a href="#ReadoutLayer3d-489"><span class="linenos">489</span></a><span class="sd">            mask: numpy array of size of filters (filter_dims x num_filters)</span>
</span><span id="ReadoutLayer3d-490"><a href="#ReadoutLayer3d-490"><span class="linenos">490</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-491"><a href="#ReadoutLayer3d-491"><span class="linenos">491</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-492"><a href="#ReadoutLayer3d-492"><span class="linenos">492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ReadoutLayer3d-493"><a href="#ReadoutLayer3d-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-494"><a href="#ReadoutLayer3d-494"><span class="linenos">494</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayer3d-495"><a href="#ReadoutLayer3d-495"><span class="linenos">495</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-496"><a href="#ReadoutLayer3d-496"><span class="linenos">496</span></a>    <span class="c1"># END MaskLayer.set_mask()</span>
</span><span id="ReadoutLayer3d-497"><a href="#ReadoutLayer3d-497"><span class="linenos">497</span></a>    
</span><span id="ReadoutLayer3d-498"><a href="#ReadoutLayer3d-498"><span class="linenos">498</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer3d-499"><a href="#ReadoutLayer3d-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-500"><a href="#ReadoutLayer3d-500"><span class="linenos">500</span></a><span class="sd">        Propagates the input forwards through the readout</span>
</span><span id="ReadoutLayer3d-501"><a href="#ReadoutLayer3d-501"><span class="linenos">501</span></a>
</span><span id="ReadoutLayer3d-502"><a href="#ReadoutLayer3d-502"><span class="linenos">502</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d-503"><a href="#ReadoutLayer3d-503"><span class="linenos">503</span></a><span class="sd">            x: input data</span>
</span><span id="ReadoutLayer3d-504"><a href="#ReadoutLayer3d-504"><span class="linenos">504</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="ReadoutLayer3d-505"><a href="#ReadoutLayer3d-505"><span class="linenos">505</span></a>
</span><span id="ReadoutLayer3d-506"><a href="#ReadoutLayer3d-506"><span class="linenos">506</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer3d-507"><a href="#ReadoutLayer3d-507"><span class="linenos">507</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="ReadoutLayer3d-508"><a href="#ReadoutLayer3d-508"><span class="linenos">508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-509"><a href="#ReadoutLayer3d-509"><span class="linenos">509</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>  <span class="c1"># 3d change -- has extra dimension at end</span>
</span><span id="ReadoutLayer3d-510"><a href="#ReadoutLayer3d-510"><span class="linenos">510</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="ReadoutLayer3d-511"><a href="#ReadoutLayer3d-511"><span class="linenos">511</span></a>        <span class="n">c</span> <span class="o">*=</span> <span class="n">T</span>
</span><span id="ReadoutLayer3d-512"><a href="#ReadoutLayer3d-512"><span class="linenos">512</span></a>        <span class="c1"># get those last filter dims up before spatial</span>
</span><span id="ReadoutLayer3d-513"><a href="#ReadoutLayer3d-513"><span class="linenos">513</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span> 
</span><span id="ReadoutLayer3d-514"><a href="#ReadoutLayer3d-514"><span class="linenos">514</span></a>
</span><span id="ReadoutLayer3d-515"><a href="#ReadoutLayer3d-515"><span class="linenos">515</span></a>        <span class="c1">#c_in, w_in, h_in = self.input_dims[:3]</span>
</span><span id="ReadoutLayer3d-516"><a href="#ReadoutLayer3d-516"><span class="linenos">516</span></a>        <span class="c1">#if (c_in, w_in, h_in) != (c, w, h):</span>
</span><span id="ReadoutLayer3d-517"><a href="#ReadoutLayer3d-517"><span class="linenos">517</span></a>        <span class="c1">#    raise ValueError(&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;)</span>
</span><span id="ReadoutLayer3d-518"><a href="#ReadoutLayer3d-518"><span class="linenos">518</span></a>        
</span><span id="ReadoutLayer3d-519"><a href="#ReadoutLayer3d-519"><span class="linenos">519</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="c1"># this is the filter weights for each unit</span>
</span><span id="ReadoutLayer3d-520"><a href="#ReadoutLayer3d-520"><span class="linenos">520</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>  <span class="c1"># 3d change -- this is num_chan x num_angles now</span>
</span><span id="ReadoutLayer3d-521"><a href="#ReadoutLayer3d-521"><span class="linenos">521</span></a>
</span><span id="ReadoutLayer3d-522"><a href="#ReadoutLayer3d-522"><span class="linenos">522</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="ReadoutLayer3d-523"><a href="#ReadoutLayer3d-523"><span class="linenos">523</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayer3d-524"><a href="#ReadoutLayer3d-524"><span class="linenos">524</span></a>
</span><span id="ReadoutLayer3d-525"><a href="#ReadoutLayer3d-525"><span class="linenos">525</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-526"><a href="#ReadoutLayer3d-526"><span class="linenos">526</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayer3d-527"><a href="#ReadoutLayer3d-527"><span class="linenos">527</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayer3d-528"><a href="#ReadoutLayer3d-528"><span class="linenos">528</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-529"><a href="#ReadoutLayer3d-529"><span class="linenos">529</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayer3d-530"><a href="#ReadoutLayer3d-530"><span class="linenos">530</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-531"><a href="#ReadoutLayer3d-531"><span class="linenos">531</span></a>        
</span><span id="ReadoutLayer3d-532"><a href="#ReadoutLayer3d-532"><span class="linenos">532</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-533"><a href="#ReadoutLayer3d-533"><span class="linenos">533</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="ReadoutLayer3d-534"><a href="#ReadoutLayer3d-534"><span class="linenos">534</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ReadoutLayer3d-535"><a href="#ReadoutLayer3d-535"><span class="linenos">535</span></a>
</span><span id="ReadoutLayer3d-536"><a href="#ReadoutLayer3d-536"><span class="linenos">536</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-537"><a href="#ReadoutLayer3d-537"><span class="linenos">537</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="ReadoutLayer3d-538"><a href="#ReadoutLayer3d-538"><span class="linenos">538</span></a>
</span><span id="ReadoutLayer3d-539"><a href="#ReadoutLayer3d-539"><span class="linenos">539</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-540"><a href="#ReadoutLayer3d-540"><span class="linenos">540</span></a>
</span><span id="ReadoutLayer3d-541"><a href="#ReadoutLayer3d-541"><span class="linenos">541</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-542"><a href="#ReadoutLayer3d-542"><span class="linenos">542</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="ReadoutLayer3d-543"><a href="#ReadoutLayer3d-543"><span class="linenos">543</span></a>        
</span><span id="ReadoutLayer3d-544"><a href="#ReadoutLayer3d-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d-545"><a href="#ReadoutLayer3d-545"><span class="linenos">545</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-546"><a href="#ReadoutLayer3d-546"><span class="linenos">546</span></a>        
</span><span id="ReadoutLayer3d-547"><a href="#ReadoutLayer3d-547"><span class="linenos">547</span></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="ReadoutLayer3d-548"><a href="#ReadoutLayer3d-548"><span class="linenos">548</span></a>    <span class="c1"># END ReadoutLayer3d.forward</span>
</span><span id="ReadoutLayer3d-549"><a href="#ReadoutLayer3d-549"><span class="linenos">549</span></a>
</span><span id="ReadoutLayer3d-550"><a href="#ReadoutLayer3d-550"><span class="linenos">550</span></a>    <span class="k">def</span> <span class="nf">passive_readout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer3d-551"><a href="#ReadoutLayer3d-551"><span class="linenos">551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-552"><a href="#ReadoutLayer3d-552"><span class="linenos">552</span></a><span class="sd">        This might have to be redone for readout3d to take into account extra filter dim.</span>
</span><span id="ReadoutLayer3d-553"><a href="#ReadoutLayer3d-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-554"><a href="#ReadoutLayer3d-554"><span class="linenos">554</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: SCAF3d: this function is not vetted and likely will clunk&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-555"><a href="#ReadoutLayer3d-555"><span class="linenos">555</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Must have #filters = #output units.&quot;</span>
</span><span id="ReadoutLayer3d-556"><a href="#ReadoutLayer3d-556"><span class="linenos">556</span></a>        <span class="c1"># Set parameters for default readout</span>
</span><span id="ReadoutLayer3d-557"><a href="#ReadoutLayer3d-557"><span class="linenos">557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-558"><a href="#ReadoutLayer3d-558"><span class="linenos">558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-559"><a href="#ReadoutLayer3d-559"><span class="linenos">559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-560"><a href="#ReadoutLayer3d-560"><span class="linenos">560</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">):</span>
</span><span id="ReadoutLayer3d-561"><a href="#ReadoutLayer3d-561"><span class="linenos">561</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer3d-562"><a href="#ReadoutLayer3d-562"><span class="linenos">562</span></a>
</span><span id="ReadoutLayer3d-563"><a href="#ReadoutLayer3d-563"><span class="linenos">563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-564"><a href="#ReadoutLayer3d-564"><span class="linenos">564</span></a>
</span><span id="ReadoutLayer3d-565"><a href="#ReadoutLayer3d-565"><span class="linenos">565</span></a>    <span class="k">def</span> <span class="nf">_layer_abbrev</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="ReadoutLayer3d-566"><a href="#ReadoutLayer3d-566"><span class="linenos">566</span></a>        <span class="k">return</span> <span class="s2">&quot;readout3&quot;</span>
</span><span id="ReadoutLayer3d-567"><a href="#ReadoutLayer3d-567"><span class="linenos">567</span></a>
</span><span id="ReadoutLayer3d-568"><a href="#ReadoutLayer3d-568"><span class="linenos">568</span></a>    <span class="nd">@classmethod</span>
</span><span id="ReadoutLayer3d-569"><a href="#ReadoutLayer3d-569"><span class="linenos">569</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer3d-570"><a href="#ReadoutLayer3d-570"><span class="linenos">570</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-571"><a href="#ReadoutLayer3d-571"><span class="linenos">571</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="ReadoutLayer3d-572"><a href="#ReadoutLayer3d-572"><span class="linenos">572</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="ReadoutLayer3d-573"><a href="#ReadoutLayer3d-573"><span class="linenos">573</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="ReadoutLayer3d-574"><a href="#ReadoutLayer3d-574"><span class="linenos">574</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="ReadoutLayer3d-575"><a href="#ReadoutLayer3d-575"><span class="linenos">575</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="ReadoutLayer3d-576"><a href="#ReadoutLayer3d-576"><span class="linenos">576</span></a>
</span><span id="ReadoutLayer3d-577"><a href="#ReadoutLayer3d-577"><span class="linenos">577</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d-578"><a href="#ReadoutLayer3d-578"><span class="linenos">578</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer3d-579"><a href="#ReadoutLayer3d-579"><span class="linenos">579</span></a>
</span><span id="ReadoutLayer3d-580"><a href="#ReadoutLayer3d-580"><span class="linenos">580</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer3d-581"><a href="#ReadoutLayer3d-581"><span class="linenos">581</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="ReadoutLayer3d-582"><a href="#ReadoutLayer3d-582"><span class="linenos">582</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d-583"><a href="#ReadoutLayer3d-583"><span class="linenos">583</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer3d-584"><a href="#ReadoutLayer3d-584"><span class="linenos">584</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readout3d&#39;</span>
</span><span id="ReadoutLayer3d-585"><a href="#ReadoutLayer3d-585"><span class="linenos">585</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="ReadoutLayer3d-586"><a href="#ReadoutLayer3d-586"><span class="linenos">586</span></a>    <span class="c1"># END [classmethod] ReadoutLayer3d.layer_dict</span>
</span></pre></div>


            <div class="docstring"><p>ReadoutLayer3d for 3d readout.
This is a subclass of ReadoutLayer, but with the added dimension of time.</p>
</div>


                            <div id="ReadoutLayer3d.__init__" class="classattr">
                                        <input id="ReadoutLayer3d.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ReadoutLayer3d</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ReadoutLayer3d.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer3d.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer3d.__init__-449"><a href="#ReadoutLayer3d.__init__-449"><span class="linenos">449</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="ReadoutLayer3d.__init__-450"><a href="#ReadoutLayer3d.__init__-450"><span class="linenos">450</span></a>            <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ReadoutLayer3d.__init__-451"><a href="#ReadoutLayer3d.__init__-451"><span class="linenos">451</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer3d.__init__-452"><a href="#ReadoutLayer3d.__init__-452"><span class="linenos">452</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.__init__-453"><a href="#ReadoutLayer3d.__init__-453"><span class="linenos">453</span></a><span class="sd">        ReadoutLayer3d: 3d readout layer for NDNs.</span>
</span><span id="ReadoutLayer3d.__init__-454"><a href="#ReadoutLayer3d.__init__-454"><span class="linenos">454</span></a>
</span><span id="ReadoutLayer3d.__init__-455"><a href="#ReadoutLayer3d.__init__-455"><span class="linenos">455</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d.__init__-456"><a href="#ReadoutLayer3d.__init__-456"><span class="linenos">456</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, depth, lags)</span>
</span><span id="ReadoutLayer3d.__init__-457"><a href="#ReadoutLayer3d.__init__-457"><span class="linenos">457</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.__init__-458"><a href="#ReadoutLayer3d.__init__-458"><span class="linenos">458</span></a>        <span class="k">assert</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer3d: should not be using this layer if no 3rd dimension of input&quot;</span>
</span><span id="ReadoutLayer3d.__init__-459"><a href="#ReadoutLayer3d.__init__-459"><span class="linenos">459</span></a>
</span><span id="ReadoutLayer3d.__init__-460"><a href="#ReadoutLayer3d.__init__-460"><span class="linenos">460</span></a>        <span class="c1"># Need to tuck lag dimension into channel-dims so parent constructor makes the right filter shape</span>
</span><span id="ReadoutLayer3d.__init__-461"><a href="#ReadoutLayer3d.__init__-461"><span class="linenos">461</span></a>        <span class="n">input_dims_mod</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.__init__-462"><a href="#ReadoutLayer3d.__init__-462"><span class="linenos">462</span></a>        <span class="n">input_dims_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayer3d.__init__-463"><a href="#ReadoutLayer3d.__init__-463"><span class="linenos">463</span></a>        <span class="n">input_dims_mod</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer3d.__init__-464"><a href="#ReadoutLayer3d.__init__-464"><span class="linenos">464</span></a>                
</span><span id="ReadoutLayer3d.__init__-465"><a href="#ReadoutLayer3d.__init__-465"><span class="linenos">465</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims_mod</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.__init__-466"><a href="#ReadoutLayer3d.__init__-466"><span class="linenos">466</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="ReadoutLayer3d.__init__-467"><a href="#ReadoutLayer3d.__init__-467"><span class="linenos">467</span></a>        <span class="c1">#print(&#39;OLD FILTER DIMS&#39;, self.filter_dims)</span>
</span><span id="ReadoutLayer3d.__init__-468"><a href="#ReadoutLayer3d.__init__-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="ReadoutLayer3d.__init__-469"><a href="#ReadoutLayer3d.__init__-469"><span class="linenos">469</span></a>        <span class="c1">#self.filter_dims = [input_dims[0], input_dims[3], 1, 1]  # making spatial so max_space can be used</span>
</span><span id="ReadoutLayer3d.__init__-470"><a href="#ReadoutLayer3d.__init__-470"><span class="linenos">470</span></a>        <span class="c1">#print(&#39;NEW FILTER DIMS&#39;, self.filter_dims)</span>
</span><span id="ReadoutLayer3d.__init__-471"><a href="#ReadoutLayer3d.__init__-471"><span class="linenos">471</span></a>        <span class="c1"># Redo regularization with new filter_dims</span>
</span><span id="ReadoutLayer3d.__init__-472"><a href="#ReadoutLayer3d.__init__-472"><span class="linenos">472</span></a>      
</span><span id="ReadoutLayer3d.__init__-473"><a href="#ReadoutLayer3d.__init__-473"><span class="linenos">473</span></a>        <span class="kn">from</span> <span class="nn">...modules.regularization</span> <span class="kn">import</span> <span class="n">Regularization</span>
</span><span id="ReadoutLayer3d.__init__-474"><a href="#ReadoutLayer3d.__init__-474"><span class="linenos">474</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span>
</span><span id="ReadoutLayer3d.__init__-475"><a href="#ReadoutLayer3d.__init__-475"><span class="linenos">475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">Regularization</span><span class="p">(</span>
</span><span id="ReadoutLayer3d.__init__-476"><a href="#ReadoutLayer3d.__init__-476"><span class="linenos">476</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="n">reg_vals</span><span class="p">,</span> 
</span><span id="ReadoutLayer3d.__init__-477"><a href="#ReadoutLayer3d.__init__-477"><span class="linenos">477</span></a>            <span class="n">num_outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span> <span class="p">)</span>
</span><span id="ReadoutLayer3d.__init__-478"><a href="#ReadoutLayer3d.__init__-478"><span class="linenos">478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
</span><span id="ReadoutLayer3d.__init__-479"><a href="#ReadoutLayer3d.__init__-479"><span class="linenos">479</span></a>            <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>ReadoutLayer3d: 3d readout layer for NDNs.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>input_dims:</strong>  tuple or list of ints, (num_channels, height, width, depth, lags)</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer3d.input_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">input_dims</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer3d.input_dims"></a>
    
    

                            </div>
                            <div id="ReadoutLayer3d.filter_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">filter_dims</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer3d.filter_dims"></a>
    
    

                            </div>
                            <div id="ReadoutLayer3d.reg" class="classattr">
                                <div class="attr variable">
            <span class="name">reg</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayer3d.reg"></a>
    
    

                            </div>
                            <div id="ReadoutLayer3d.set_mask" class="classattr">
                                        <input id="ReadoutLayer3d.set_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer3d.set_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer3d.set_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer3d.set_mask-482"><a href="#ReadoutLayer3d.set_mask-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">set_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ReadoutLayer3d.set_mask-483"><a href="#ReadoutLayer3d.set_mask-483"><span class="linenos">483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.set_mask-484"><a href="#ReadoutLayer3d.set_mask-484"><span class="linenos">484</span></a><span class="sd">        Sets mask -- instead of plugging in by hand. Registers mask as being set, and checks dimensions.</span>
</span><span id="ReadoutLayer3d.set_mask-485"><a href="#ReadoutLayer3d.set_mask-485"><span class="linenos">485</span></a><span class="sd">        Can also use to rest to have trivial mask (all 1s)</span>
</span><span id="ReadoutLayer3d.set_mask-486"><a href="#ReadoutLayer3d.set_mask-486"><span class="linenos">486</span></a><span class="sd">        Mask will be numpy, leave mask blank if want to set to default mask (all ones)</span>
</span><span id="ReadoutLayer3d.set_mask-487"><a href="#ReadoutLayer3d.set_mask-487"><span class="linenos">487</span></a><span class="sd">        </span>
</span><span id="ReadoutLayer3d.set_mask-488"><a href="#ReadoutLayer3d.set_mask-488"><span class="linenos">488</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d.set_mask-489"><a href="#ReadoutLayer3d.set_mask-489"><span class="linenos">489</span></a><span class="sd">            mask: numpy array of size of filters (filter_dims x num_filters)</span>
</span><span id="ReadoutLayer3d.set_mask-490"><a href="#ReadoutLayer3d.set_mask-490"><span class="linenos">490</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.set_mask-491"><a href="#ReadoutLayer3d.set_mask-491"><span class="linenos">491</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.set_mask-492"><a href="#ReadoutLayer3d.set_mask-492"><span class="linenos">492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ReadoutLayer3d.set_mask-493"><a href="#ReadoutLayer3d.set_mask-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.set_mask-494"><a href="#ReadoutLayer3d.set_mask-494"><span class="linenos">494</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayer3d.set_mask-495"><a href="#ReadoutLayer3d.set_mask-495"><span class="linenos">495</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sets mask -- instead of plugging in by hand. Registers mask as being set, and checks dimensions.
Can also use to rest to have trivial mask (all 1s)
Mask will be numpy, leave mask blank if want to set to default mask (all ones)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  numpy array of size of filters (filter_dims x num_filters)</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayer3d.forward" class="classattr">
                                        <input id="ReadoutLayer3d.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">shift</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer3d.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer3d.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer3d.forward-498"><a href="#ReadoutLayer3d.forward-498"><span class="linenos">498</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayer3d.forward-499"><a href="#ReadoutLayer3d.forward-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.forward-500"><a href="#ReadoutLayer3d.forward-500"><span class="linenos">500</span></a><span class="sd">        Propagates the input forwards through the readout</span>
</span><span id="ReadoutLayer3d.forward-501"><a href="#ReadoutLayer3d.forward-501"><span class="linenos">501</span></a>
</span><span id="ReadoutLayer3d.forward-502"><a href="#ReadoutLayer3d.forward-502"><span class="linenos">502</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d.forward-503"><a href="#ReadoutLayer3d.forward-503"><span class="linenos">503</span></a><span class="sd">            x: input data</span>
</span><span id="ReadoutLayer3d.forward-504"><a href="#ReadoutLayer3d.forward-504"><span class="linenos">504</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="ReadoutLayer3d.forward-505"><a href="#ReadoutLayer3d.forward-505"><span class="linenos">505</span></a>
</span><span id="ReadoutLayer3d.forward-506"><a href="#ReadoutLayer3d.forward-506"><span class="linenos">506</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer3d.forward-507"><a href="#ReadoutLayer3d.forward-507"><span class="linenos">507</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="ReadoutLayer3d.forward-508"><a href="#ReadoutLayer3d.forward-508"><span class="linenos">508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.forward-509"><a href="#ReadoutLayer3d.forward-509"><span class="linenos">509</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>  <span class="c1"># 3d change -- has extra dimension at end</span>
</span><span id="ReadoutLayer3d.forward-510"><a href="#ReadoutLayer3d.forward-510"><span class="linenos">510</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="ReadoutLayer3d.forward-511"><a href="#ReadoutLayer3d.forward-511"><span class="linenos">511</span></a>        <span class="n">c</span> <span class="o">*=</span> <span class="n">T</span>
</span><span id="ReadoutLayer3d.forward-512"><a href="#ReadoutLayer3d.forward-512"><span class="linenos">512</span></a>        <span class="c1"># get those last filter dims up before spatial</span>
</span><span id="ReadoutLayer3d.forward-513"><a href="#ReadoutLayer3d.forward-513"><span class="linenos">513</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span> 
</span><span id="ReadoutLayer3d.forward-514"><a href="#ReadoutLayer3d.forward-514"><span class="linenos">514</span></a>
</span><span id="ReadoutLayer3d.forward-515"><a href="#ReadoutLayer3d.forward-515"><span class="linenos">515</span></a>        <span class="c1">#c_in, w_in, h_in = self.input_dims[:3]</span>
</span><span id="ReadoutLayer3d.forward-516"><a href="#ReadoutLayer3d.forward-516"><span class="linenos">516</span></a>        <span class="c1">#if (c_in, w_in, h_in) != (c, w, h):</span>
</span><span id="ReadoutLayer3d.forward-517"><a href="#ReadoutLayer3d.forward-517"><span class="linenos">517</span></a>        <span class="c1">#    raise ValueError(&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;)</span>
</span><span id="ReadoutLayer3d.forward-518"><a href="#ReadoutLayer3d.forward-518"><span class="linenos">518</span></a>        
</span><span id="ReadoutLayer3d.forward-519"><a href="#ReadoutLayer3d.forward-519"><span class="linenos">519</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="c1"># this is the filter weights for each unit</span>
</span><span id="ReadoutLayer3d.forward-520"><a href="#ReadoutLayer3d.forward-520"><span class="linenos">520</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>  <span class="c1"># 3d change -- this is num_chan x num_angles now</span>
</span><span id="ReadoutLayer3d.forward-521"><a href="#ReadoutLayer3d.forward-521"><span class="linenos">521</span></a>
</span><span id="ReadoutLayer3d.forward-522"><a href="#ReadoutLayer3d.forward-522"><span class="linenos">522</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="ReadoutLayer3d.forward-523"><a href="#ReadoutLayer3d.forward-523"><span class="linenos">523</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayer3d.forward-524"><a href="#ReadoutLayer3d.forward-524"><span class="linenos">524</span></a>
</span><span id="ReadoutLayer3d.forward-525"><a href="#ReadoutLayer3d.forward-525"><span class="linenos">525</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.forward-526"><a href="#ReadoutLayer3d.forward-526"><span class="linenos">526</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayer3d.forward-527"><a href="#ReadoutLayer3d.forward-527"><span class="linenos">527</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayer3d.forward-528"><a href="#ReadoutLayer3d.forward-528"><span class="linenos">528</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.forward-529"><a href="#ReadoutLayer3d.forward-529"><span class="linenos">529</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayer3d.forward-530"><a href="#ReadoutLayer3d.forward-530"><span class="linenos">530</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.forward-531"><a href="#ReadoutLayer3d.forward-531"><span class="linenos">531</span></a>        
</span><span id="ReadoutLayer3d.forward-532"><a href="#ReadoutLayer3d.forward-532"><span class="linenos">532</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.forward-533"><a href="#ReadoutLayer3d.forward-533"><span class="linenos">533</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="ReadoutLayer3d.forward-534"><a href="#ReadoutLayer3d.forward-534"><span class="linenos">534</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ReadoutLayer3d.forward-535"><a href="#ReadoutLayer3d.forward-535"><span class="linenos">535</span></a>
</span><span id="ReadoutLayer3d.forward-536"><a href="#ReadoutLayer3d.forward-536"><span class="linenos">536</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.forward-537"><a href="#ReadoutLayer3d.forward-537"><span class="linenos">537</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="ReadoutLayer3d.forward-538"><a href="#ReadoutLayer3d.forward-538"><span class="linenos">538</span></a>
</span><span id="ReadoutLayer3d.forward-539"><a href="#ReadoutLayer3d.forward-539"><span class="linenos">539</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.forward-540"><a href="#ReadoutLayer3d.forward-540"><span class="linenos">540</span></a>
</span><span id="ReadoutLayer3d.forward-541"><a href="#ReadoutLayer3d.forward-541"><span class="linenos">541</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.forward-542"><a href="#ReadoutLayer3d.forward-542"><span class="linenos">542</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="ReadoutLayer3d.forward-543"><a href="#ReadoutLayer3d.forward-543"><span class="linenos">543</span></a>        
</span><span id="ReadoutLayer3d.forward-544"><a href="#ReadoutLayer3d.forward-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayer3d.forward-545"><a href="#ReadoutLayer3d.forward-545"><span class="linenos">545</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.forward-546"><a href="#ReadoutLayer3d.forward-546"><span class="linenos">546</span></a>        
</span><span id="ReadoutLayer3d.forward-547"><a href="#ReadoutLayer3d.forward-547"><span class="linenos">547</span></a>        <span class="k">return</span> <span class="n">y</span>
</span></pre></div>


            <div class="docstring"><p>Propagates the input forwards through the readout</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>x:</strong>  input data</li>
<li><strong>shift (bool):</strong>  shifts the location of the grid (from eye-tracking data)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>y: neuronal activity</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayer3d.passive_readout" class="classattr">
                                        <input id="ReadoutLayer3d.passive_readout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">passive_readout</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer3d.passive_readout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer3d.passive_readout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer3d.passive_readout-550"><a href="#ReadoutLayer3d.passive_readout-550"><span class="linenos">550</span></a>    <span class="k">def</span> <span class="nf">passive_readout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReadoutLayer3d.passive_readout-551"><a href="#ReadoutLayer3d.passive_readout-551"><span class="linenos">551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.passive_readout-552"><a href="#ReadoutLayer3d.passive_readout-552"><span class="linenos">552</span></a><span class="sd">        This might have to be redone for readout3d to take into account extra filter dim.</span>
</span><span id="ReadoutLayer3d.passive_readout-553"><a href="#ReadoutLayer3d.passive_readout-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.passive_readout-554"><a href="#ReadoutLayer3d.passive_readout-554"><span class="linenos">554</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: SCAF3d: this function is not vetted and likely will clunk&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.passive_readout-555"><a href="#ReadoutLayer3d.passive_readout-555"><span class="linenos">555</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Must have #filters = #output units.&quot;</span>
</span><span id="ReadoutLayer3d.passive_readout-556"><a href="#ReadoutLayer3d.passive_readout-556"><span class="linenos">556</span></a>        <span class="c1"># Set parameters for default readout</span>
</span><span id="ReadoutLayer3d.passive_readout-557"><a href="#ReadoutLayer3d.passive_readout-557"><span class="linenos">557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.passive_readout-558"><a href="#ReadoutLayer3d.passive_readout-558"><span class="linenos">558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.passive_readout-559"><a href="#ReadoutLayer3d.passive_readout-559"><span class="linenos">559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.passive_readout-560"><a href="#ReadoutLayer3d.passive_readout-560"><span class="linenos">560</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">):</span>
</span><span id="ReadoutLayer3d.passive_readout-561"><a href="#ReadoutLayer3d.passive_readout-561"><span class="linenos">561</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayer3d.passive_readout-562"><a href="#ReadoutLayer3d.passive_readout-562"><span class="linenos">562</span></a>
</span><span id="ReadoutLayer3d.passive_readout-563"><a href="#ReadoutLayer3d.passive_readout-563"><span class="linenos">563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This might have to be redone for readout3d to take into account extra filter dim.</p>
</div>


                            </div>
                            <div id="ReadoutLayer3d.layer_dict" class="classattr">
                                        <input id="ReadoutLayer3d.layer_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">layer_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayer3d.layer_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayer3d.layer_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayer3d.layer_dict-568"><a href="#ReadoutLayer3d.layer_dict-568"><span class="linenos">568</span></a>    <span class="nd">@classmethod</span>
</span><span id="ReadoutLayer3d.layer_dict-569"><a href="#ReadoutLayer3d.layer_dict-569"><span class="linenos">569</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayer3d.layer_dict-570"><a href="#ReadoutLayer3d.layer_dict-570"><span class="linenos">570</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.layer_dict-571"><a href="#ReadoutLayer3d.layer_dict-571"><span class="linenos">571</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="ReadoutLayer3d.layer_dict-572"><a href="#ReadoutLayer3d.layer_dict-572"><span class="linenos">572</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="ReadoutLayer3d.layer_dict-573"><a href="#ReadoutLayer3d.layer_dict-573"><span class="linenos">573</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="ReadoutLayer3d.layer_dict-574"><a href="#ReadoutLayer3d.layer_dict-574"><span class="linenos">574</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="ReadoutLayer3d.layer_dict-575"><a href="#ReadoutLayer3d.layer_dict-575"><span class="linenos">575</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="ReadoutLayer3d.layer_dict-576"><a href="#ReadoutLayer3d.layer_dict-576"><span class="linenos">576</span></a>
</span><span id="ReadoutLayer3d.layer_dict-577"><a href="#ReadoutLayer3d.layer_dict-577"><span class="linenos">577</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayer3d.layer_dict-578"><a href="#ReadoutLayer3d.layer_dict-578"><span class="linenos">578</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayer3d.layer_dict-579"><a href="#ReadoutLayer3d.layer_dict-579"><span class="linenos">579</span></a>
</span><span id="ReadoutLayer3d.layer_dict-580"><a href="#ReadoutLayer3d.layer_dict-580"><span class="linenos">580</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayer3d.layer_dict-581"><a href="#ReadoutLayer3d.layer_dict-581"><span class="linenos">581</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="ReadoutLayer3d.layer_dict-582"><a href="#ReadoutLayer3d.layer_dict-582"><span class="linenos">582</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayer3d.layer_dict-583"><a href="#ReadoutLayer3d.layer_dict-583"><span class="linenos">583</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayer3d.layer_dict-584"><a href="#ReadoutLayer3d.layer_dict-584"><span class="linenos">584</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readout3d&#39;</span>
</span><span id="ReadoutLayer3d.layer_dict-585"><a href="#ReadoutLayer3d.layer_dict-585"><span class="linenos">585</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span></pre></div>


            <div class="docstring"><p>This outputs a dictionary of parameters that need to input into the layer to completely specify.
Output is a dictionary with these keywords. 
-- All layer-specific inputs are included in the returned dict
-- Values that must be set are set to empty lists
-- Other values will be given their defaults</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Ldict: dictionary of layer parameters</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ReadoutLayer">ReadoutLayer</a></dt>
                                <dd id="ReadoutLayer3d.batch_sample" class="variable"><a href="#ReadoutLayer.batch_sample">batch_sample</a></dd>
                <dd id="ReadoutLayer3d.sample_mode" class="variable"><a href="#ReadoutLayer.sample_mode">sample_mode</a></dd>
                <dd id="ReadoutLayer3d.init_mu_range" class="variable"><a href="#ReadoutLayer.init_mu_range">init_mu_range</a></dd>
                <dd id="ReadoutLayer3d.init_sigma" class="variable"><a href="#ReadoutLayer.init_sigma">init_sigma</a></dd>
                <dd id="ReadoutLayer3d.align_corners" class="variable"><a href="#ReadoutLayer.align_corners">align_corners</a></dd>
                <dd id="ReadoutLayer3d.grid_shape" class="variable"><a href="#ReadoutLayer.grid_shape">grid_shape</a></dd>
                <dd id="ReadoutLayer3d.mu" class="variable"><a href="#ReadoutLayer.mu">mu</a></dd>
                <dd id="ReadoutLayer3d.sigma" class="variable"><a href="#ReadoutLayer.sigma">sigma</a></dd>
                <dd id="ReadoutLayer3d.level_reg" class="variable"><a href="#ReadoutLayer.level_reg">level_reg</a></dd>
                <dd id="ReadoutLayer3d.sample" class="variable"><a href="#ReadoutLayer.sample">sample</a></dd>
                <dd id="ReadoutLayer3d.features" class="variable"><a href="#ReadoutLayer.features">features</a></dd>
                <dd id="ReadoutLayer3d.grid" class="variable"><a href="#ReadoutLayer.grid">grid</a></dd>
                <dd id="ReadoutLayer3d.initialize_spatial_mapping" class="function"><a href="#ReadoutLayer.initialize_spatial_mapping">initialize_spatial_mapping</a></dd>
                <dd id="ReadoutLayer3d.sample_grid" class="function"><a href="#ReadoutLayer.sample_grid">sample_grid</a></dd>
                <dd id="ReadoutLayer3d.get_weights" class="function"><a href="#ReadoutLayer.get_weights">get_weights</a></dd>
                <dd id="ReadoutLayer3d.compute_reg_loss" class="function"><a href="#ReadoutLayer.compute_reg_loss">compute_reg_loss</a></dd>
                <dd id="ReadoutLayer3d.set_readout_locations" class="function"><a href="#ReadoutLayer.set_readout_locations">set_readout_locations</a></dd>
                <dd id="ReadoutLayer3d.get_readout_locations" class="function"><a href="#ReadoutLayer.get_readout_locations">get_readout_locations</a></dd>
                <dd id="ReadoutLayer3d.fit_mus" class="function"><a href="#ReadoutLayer.fit_mus">fit_mus</a></dd>
                <dd id="ReadoutLayer3d.enforce_grid" class="function"><a href="#ReadoutLayer.enforce_grid">enforce_grid</a></dd>

            </div>
            <div><dt><a href="ndnlayer.html#NDNLayer">NDNT.modules.layers.ndnlayer.NDNLayer</a></dt>
                                <dd id="ReadoutLayer3d.num_filters" class="variable"><a href="ndnlayer.html#NDNLayer.num_filters">num_filters</a></dd>
                <dd id="ReadoutLayer3d.output_dims" class="variable"><a href="ndnlayer.html#NDNLayer.output_dims">output_dims</a></dd>
                <dd id="ReadoutLayer3d.norm_type" class="variable"><a href="ndnlayer.html#NDNLayer.norm_type">norm_type</a></dd>
                <dd id="ReadoutLayer3d.pos_constraint" class="variable"><a href="ndnlayer.html#NDNLayer.pos_constraint">pos_constraint</a></dd>
                <dd id="ReadoutLayer3d.conv" class="variable"><a href="ndnlayer.html#NDNLayer.conv">conv</a></dd>
                <dd id="ReadoutLayer3d.NL" class="variable"><a href="ndnlayer.html#NDNLayer.NL">NL</a></dd>
                <dd id="ReadoutLayer3d.shape" class="variable"><a href="ndnlayer.html#NDNLayer.shape">shape</a></dd>
                <dd id="ReadoutLayer3d.weight_scale" class="variable"><a href="ndnlayer.html#NDNLayer.weight_scale">weight_scale</a></dd>
                <dd id="ReadoutLayer3d.weight" class="variable"><a href="ndnlayer.html#NDNLayer.weight">weight</a></dd>
                <dd id="ReadoutLayer3d.num_inh" class="variable"><a href="ndnlayer.html#NDNLayer.num_inh">num_inh</a></dd>
                <dd id="ReadoutLayer3d.reset_parameters" class="function"><a href="ndnlayer.html#NDNLayer.reset_parameters">reset_parameters</a></dd>
                <dd id="ReadoutLayer3d.initialize_gaussian_envelope" class="function"><a href="ndnlayer.html#NDNLayer.initialize_gaussian_envelope">initialize_gaussian_envelope</a></dd>
                <dd id="ReadoutLayer3d.preprocess_weights" class="function"><a href="ndnlayer.html#NDNLayer.preprocess_weights">preprocess_weights</a></dd>
                <dd id="ReadoutLayer3d.list_parameters" class="function"><a href="ndnlayer.html#NDNLayer.list_parameters">list_parameters</a></dd>
                <dd id="ReadoutLayer3d.set_parameters" class="function"><a href="ndnlayer.html#NDNLayer.set_parameters">set_parameters</a></dd>
                <dd id="ReadoutLayer3d.set_reg_val" class="function"><a href="ndnlayer.html#NDNLayer.set_reg_val">set_reg_val</a></dd>
                <dd id="ReadoutLayer3d.plot_filters" class="function"><a href="ndnlayer.html#NDNLayer.plot_filters">plot_filters</a></dd>
                <dd id="ReadoutLayer3d.info" class="function"><a href="ndnlayer.html#NDNLayer.info">info</a></dd>
                <dd id="ReadoutLayer3d.dim_info" class="function"><a href="ndnlayer.html#NDNLayer.dim_info">dim_info</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ReadoutLayer3d.dump_patches" class="variable">dump_patches</dd>
                <dd id="ReadoutLayer3d.training" class="variable">training</dd>
                <dd id="ReadoutLayer3d.call_super_init" class="variable">call_super_init</dd>
                <dd id="ReadoutLayer3d.register_buffer" class="function">register_buffer</dd>
                <dd id="ReadoutLayer3d.register_parameter" class="function">register_parameter</dd>
                <dd id="ReadoutLayer3d.add_module" class="function">add_module</dd>
                <dd id="ReadoutLayer3d.register_module" class="function">register_module</dd>
                <dd id="ReadoutLayer3d.get_submodule" class="function">get_submodule</dd>
                <dd id="ReadoutLayer3d.get_parameter" class="function">get_parameter</dd>
                <dd id="ReadoutLayer3d.get_buffer" class="function">get_buffer</dd>
                <dd id="ReadoutLayer3d.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ReadoutLayer3d.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ReadoutLayer3d.apply" class="function">apply</dd>
                <dd id="ReadoutLayer3d.cuda" class="function">cuda</dd>
                <dd id="ReadoutLayer3d.ipu" class="function">ipu</dd>
                <dd id="ReadoutLayer3d.xpu" class="function">xpu</dd>
                <dd id="ReadoutLayer3d.cpu" class="function">cpu</dd>
                <dd id="ReadoutLayer3d.type" class="function">type</dd>
                <dd id="ReadoutLayer3d.float" class="function">float</dd>
                <dd id="ReadoutLayer3d.double" class="function">double</dd>
                <dd id="ReadoutLayer3d.half" class="function">half</dd>
                <dd id="ReadoutLayer3d.bfloat16" class="function">bfloat16</dd>
                <dd id="ReadoutLayer3d.to_empty" class="function">to_empty</dd>
                <dd id="ReadoutLayer3d.to" class="function">to</dd>
                <dd id="ReadoutLayer3d.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ReadoutLayer3d.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ReadoutLayer3d.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ReadoutLayer3d.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ReadoutLayer3d.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ReadoutLayer3d.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ReadoutLayer3d.state_dict" class="function">state_dict</dd>
                <dd id="ReadoutLayer3d.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ReadoutLayer3d.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ReadoutLayer3d.parameters" class="function">parameters</dd>
                <dd id="ReadoutLayer3d.named_parameters" class="function">named_parameters</dd>
                <dd id="ReadoutLayer3d.buffers" class="function">buffers</dd>
                <dd id="ReadoutLayer3d.named_buffers" class="function">named_buffers</dd>
                <dd id="ReadoutLayer3d.children" class="function">children</dd>
                <dd id="ReadoutLayer3d.named_children" class="function">named_children</dd>
                <dd id="ReadoutLayer3d.modules" class="function">modules</dd>
                <dd id="ReadoutLayer3d.named_modules" class="function">named_modules</dd>
                <dd id="ReadoutLayer3d.train" class="function">train</dd>
                <dd id="ReadoutLayer3d.eval" class="function">eval</dd>
                <dd id="ReadoutLayer3d.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ReadoutLayer3d.zero_grad" class="function">zero_grad</dd>
                <dd id="ReadoutLayer3d.share_memory" class="function">share_memory</dd>
                <dd id="ReadoutLayer3d.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FixationLayer">
                            <input id="FixationLayer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FixationLayer</span><wbr>(<span class="base"><a href="ndnlayer.html#NDNLayer">NDNT.modules.layers.ndnlayer.NDNLayer</a></span>):

                <label class="view-source-button" for="FixationLayer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FixationLayer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FixationLayer-589"><a href="#FixationLayer-589"><span class="linenos">589</span></a><span class="k">class</span> <span class="nc">FixationLayer</span><span class="p">(</span><span class="n">NDNLayer</span><span class="p">):</span>
</span><span id="FixationLayer-590"><a href="#FixationLayer-590"><span class="linenos">590</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer-591"><a href="#FixationLayer-591"><span class="linenos">591</span></a><span class="sd">    FixationLayer for fixation.</span>
</span><span id="FixationLayer-592"><a href="#FixationLayer-592"><span class="linenos">592</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FixationLayer-593"><a href="#FixationLayer-593"><span class="linenos">593</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="FixationLayer-594"><a href="#FixationLayer-594"><span class="linenos">594</span></a>            <span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="FixationLayer-595"><a href="#FixationLayer-595"><span class="linenos">595</span></a>            <span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="FixationLayer-596"><a href="#FixationLayer-596"><span class="linenos">596</span></a>            <span class="c1">#input_dims=None,  # this has to be set to [1,1,1,1] by default</span>
</span><span id="FixationLayer-597"><a href="#FixationLayer-597"><span class="linenos">597</span></a>            <span class="n">batch_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer-598"><a href="#FixationLayer-598"><span class="linenos">598</span></a>            <span class="n">fix_n_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer-599"><a href="#FixationLayer-599"><span class="linenos">599</span></a>            <span class="c1">#init_mu_range=0.1,</span>
</span><span id="FixationLayer-600"><a href="#FixationLayer-600"><span class="linenos">600</span></a>            <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FixationLayer-601"><a href="#FixationLayer-601"><span class="linenos">601</span></a>            <span class="n">single_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer-602"><a href="#FixationLayer-602"><span class="linenos">602</span></a>            <span class="c1">#gauss_type: str=&#39;uncorrelated&#39;, # &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="FixationLayer-603"><a href="#FixationLayer-603"><span class="linenos">603</span></a>            <span class="c1">#align_corners=False,</span>
</span><span id="FixationLayer-604"><a href="#FixationLayer-604"><span class="linenos">604</span></a>            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer-605"><a href="#FixationLayer-605"><span class="linenos">605</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span>
</span><span id="FixationLayer-606"><a href="#FixationLayer-606"><span class="linenos">606</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="FixationLayer-607"><a href="#FixationLayer-607"><span class="linenos">607</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer-608"><a href="#FixationLayer-608"><span class="linenos">608</span></a><span class="sd">        Layer weights become the shift for each fixation, sigma is constant over each dimension.</span>
</span><span id="FixationLayer-609"><a href="#FixationLayer-609"><span class="linenos">609</span></a><span class="sd">        </span>
</span><span id="FixationLayer-610"><a href="#FixationLayer-610"><span class="linenos">610</span></a><span class="sd">        Args:</span>
</span><span id="FixationLayer-611"><a href="#FixationLayer-611"><span class="linenos">611</span></a><span class="sd">            num_fixations: int, number of fixations</span>
</span><span id="FixationLayer-612"><a href="#FixationLayer-612"><span class="linenos">612</span></a><span class="sd">            num_spatial_dims: int, number of spatial dimensions</span>
</span><span id="FixationLayer-613"><a href="#FixationLayer-613"><span class="linenos">613</span></a><span class="sd">            batch_sample: bool, whether to sample grid locations separately per sample per batch</span>
</span><span id="FixationLayer-614"><a href="#FixationLayer-614"><span class="linenos">614</span></a><span class="sd">            fix_n_index: bool, whether to index fixations starting at 1</span>
</span><span id="FixationLayer-615"><a href="#FixationLayer-615"><span class="linenos">615</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="FixationLayer-616"><a href="#FixationLayer-616"><span class="linenos">616</span></a><span class="sd">            single_sigma: bool, whether to use a single sigma for all fixations</span>
</span><span id="FixationLayer-617"><a href="#FixationLayer-617"><span class="linenos">617</span></a><span class="sd">            bias: bool, whether to include bias term</span>
</span><span id="FixationLayer-618"><a href="#FixationLayer-618"><span class="linenos">618</span></a><span class="sd">            NLtype: str, type of nonlinearity</span>
</span><span id="FixationLayer-619"><a href="#FixationLayer-619"><span class="linenos">619</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer-620"><a href="#FixationLayer-620"><span class="linenos">620</span></a>        <span class="c1">#self.num_fixations = layer_params[&#39;input_dims&#39;][0]</span>
</span><span id="FixationLayer-621"><a href="#FixationLayer-621"><span class="linenos">621</span></a>        <span class="c1">#assert np.prod(input_dims[1:]) == 1, &#39;something wrong with fix-layer input_dims&#39;</span>
</span><span id="FixationLayer-622"><a href="#FixationLayer-622"><span class="linenos">622</span></a>        <span class="k">assert</span> <span class="n">num_fixations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;FIX LAYER: Must set number of fixations&quot;</span>
</span><span id="FixationLayer-623"><a href="#FixationLayer-623"><span class="linenos">623</span></a>        <span class="k">assert</span> <span class="n">num_spatial_dims</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;FIX LAYER: num_space must be set to spatial dimensionality (1 or 2)&quot;</span>
</span><span id="FixationLayer-624"><a href="#FixationLayer-624"><span class="linenos">624</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">bias</span><span class="p">,</span> <span class="s2">&quot;FIX LAYER: cannot have bias term&quot;</span>
</span><span id="FixationLayer-625"><a href="#FixationLayer-625"><span class="linenos">625</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer-626"><a href="#FixationLayer-626"><span class="linenos">626</span></a>
</span><span id="FixationLayer-627"><a href="#FixationLayer-627"><span class="linenos">627</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="FixationLayer-628"><a href="#FixationLayer-628"><span class="linenos">628</span></a>            <span class="n">num_filters</span> <span class="o">=</span> <span class="n">num_spatial_dims</span><span class="p">,</span>
</span><span id="FixationLayer-629"><a href="#FixationLayer-629"><span class="linenos">629</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_fixations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="FixationLayer-630"><a href="#FixationLayer-630"><span class="linenos">630</span></a>            <span class="n">NLtype</span> <span class="o">=</span> <span class="n">NLtype</span><span class="p">,</span>
</span><span id="FixationLayer-631"><a href="#FixationLayer-631"><span class="linenos">631</span></a>            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
</span><span id="FixationLayer-632"><a href="#FixationLayer-632"><span class="linenos">632</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="FixationLayer-633"><a href="#FixationLayer-633"><span class="linenos">633</span></a>
</span><span id="FixationLayer-634"><a href="#FixationLayer-634"><span class="linenos">634</span></a>        <span class="c1"># Determine whether one- or two-dimensional readout</span>
</span><span id="FixationLayer-635"><a href="#FixationLayer-635"><span class="linenos">635</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span> <span class="o">=</span> <span class="n">num_spatial_dims</span>
</span><span id="FixationLayer-636"><a href="#FixationLayer-636"><span class="linenos">636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span> <span class="o">=</span> <span class="n">num_fixations</span>
</span><span id="FixationLayer-637"><a href="#FixationLayer-637"><span class="linenos">637</span></a>
</span><span id="FixationLayer-638"><a href="#FixationLayer-638"><span class="linenos">638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span> <span class="o">=</span> <span class="n">batch_sample</span>
</span><span id="FixationLayer-639"><a href="#FixationLayer-639"><span class="linenos">639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="FixationLayer-640"><a href="#FixationLayer-640"><span class="linenos">640</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span> <span class="o">=</span> <span class="n">single_sigma</span>
</span><span id="FixationLayer-641"><a href="#FixationLayer-641"><span class="linenos">641</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n_index</span> <span class="o">=</span> <span class="n">fix_n_index</span>
</span><span id="FixationLayer-642"><a href="#FixationLayer-642"><span class="linenos">642</span></a>
</span><span id="FixationLayer-643"><a href="#FixationLayer-643"><span class="linenos">643</span></a>        <span class="c1"># shared sigmas across all fixations</span>
</span><span id="FixationLayer-644"><a href="#FixationLayer-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span><span class="p">:</span>
</span><span id="FixationLayer-645"><a href="#FixationLayer-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">))</span> 
</span><span id="FixationLayer-646"><a href="#FixationLayer-646"><span class="linenos">646</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FixationLayer-647"><a href="#FixationLayer-647"><span class="linenos">647</span></a>            <span class="c1"># individual sigmas for each fixation </span>
</span><span id="FixationLayer-648"><a href="#FixationLayer-648"><span class="linenos">648</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="FixationLayer-649"><a href="#FixationLayer-649"><span class="linenos">649</span></a>        
</span><span id="FixationLayer-650"><a href="#FixationLayer-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span><span class="p">)</span>
</span><span id="FixationLayer-651"><a href="#FixationLayer-651"><span class="linenos">651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="FixationLayer-652"><a href="#FixationLayer-652"><span class="linenos">652</span></a>        
</span><span id="FixationLayer-653"><a href="#FixationLayer-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer-654"><a href="#FixationLayer-654"><span class="linenos">654</span></a>    <span class="c1"># END FixationLayer.__init__</span>
</span><span id="FixationLayer-655"><a href="#FixationLayer-655"><span class="linenos">655</span></a>
</span><span id="FixationLayer-656"><a href="#FixationLayer-656"><span class="linenos">656</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="FixationLayer-657"><a href="#FixationLayer-657"><span class="linenos">657</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer-658"><a href="#FixationLayer-658"><span class="linenos">658</span></a><span class="sd">        The input is the sampled fixation-stim</span>
</span><span id="FixationLayer-659"><a href="#FixationLayer-659"><span class="linenos">659</span></a><span class="sd">        </span>
</span><span id="FixationLayer-660"><a href="#FixationLayer-660"><span class="linenos">660</span></a><span class="sd">        Args:</span>
</span><span id="FixationLayer-661"><a href="#FixationLayer-661"><span class="linenos">661</span></a><span class="sd">            x: input data</span>
</span><span id="FixationLayer-662"><a href="#FixationLayer-662"><span class="linenos">662</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="FixationLayer-663"><a href="#FixationLayer-663"><span class="linenos">663</span></a>
</span><span id="FixationLayer-664"><a href="#FixationLayer-664"><span class="linenos">664</span></a><span class="sd">        Returns:</span>
</span><span id="FixationLayer-665"><a href="#FixationLayer-665"><span class="linenos">665</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="FixationLayer-666"><a href="#FixationLayer-666"><span class="linenos">666</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer-667"><a href="#FixationLayer-667"><span class="linenos">667</span></a>        <span class="c1"># with torch.no_grad():</span>
</span><span id="FixationLayer-668"><a href="#FixationLayer-668"><span class="linenos">668</span></a>        <span class="c1"># self.weight.clamp(min=-1, max=1)  # at eval time, only self.mu is used so it must belong to [-1,1]</span>
</span><span id="FixationLayer-669"><a href="#FixationLayer-669"><span class="linenos">669</span></a>        <span class="c1"># self.sigmas.clamp(min=0)  # sigma/variance is always a positive quantity</span>
</span><span id="FixationLayer-670"><a href="#FixationLayer-670"><span class="linenos">670</span></a>        
</span><span id="FixationLayer-671"><a href="#FixationLayer-671"><span class="linenos">671</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># batch size</span>
</span><span id="FixationLayer-672"><a href="#FixationLayer-672"><span class="linenos">672</span></a>        <span class="c1"># If using X-matrix to extract relevant weights</span>
</span><span id="FixationLayer-673"><a href="#FixationLayer-673"><span class="linenos">673</span></a>        <span class="c1"># y = (x@self.weight) </span>
</span><span id="FixationLayer-674"><a href="#FixationLayer-674"><span class="linenos">674</span></a>        <span class="c1"># use indexing: x is just a list of weight indices</span>
</span><span id="FixationLayer-675"><a href="#FixationLayer-675"><span class="linenos">675</span></a>        
</span><span id="FixationLayer-676"><a href="#FixationLayer-676"><span class="linenos">676</span></a>        <span class="c1"># In case x gets passed in with trivial second dim (squeeze)</span>
</span><span id="FixationLayer-677"><a href="#FixationLayer-677"><span class="linenos">677</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FixationLayer-678"><a href="#FixationLayer-678"><span class="linenos">678</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  WARNING: fixations should not have second dimension -- squeeze it&#39;</span><span class="p">)</span>
</span><span id="FixationLayer-679"><a href="#FixationLayer-679"><span class="linenos">679</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
</span><span id="FixationLayer-680"><a href="#FixationLayer-680"><span class="linenos">680</span></a>
</span><span id="FixationLayer-681"><a href="#FixationLayer-681"><span class="linenos">681</span></a>        <span class="c1"># Actual fixations labeled 1-NFIX</span>
</span><span id="FixationLayer-682"><a href="#FixationLayer-682"><span class="linenos">682</span></a>        <span class="c1"># Will make by default fixation label &#39;0&#39; lead to no shift</span>
</span><span id="FixationLayer-683"><a href="#FixationLayer-683"><span class="linenos">683</span></a>        <span class="n">shift_array</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span><span id="FixationLayer-684"><a href="#FixationLayer-684"><span class="linenos">684</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">shift_array</span><span class="p">[</span><span class="n">x</span><span class="p">,:])</span>   <span class="c1"># fix_n</span>
</span><span id="FixationLayer-685"><a href="#FixationLayer-685"><span class="linenos">685</span></a>
</span><span id="FixationLayer-686"><a href="#FixationLayer-686"><span class="linenos">686</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span><span class="p">:</span>
</span><span id="FixationLayer-687"><a href="#FixationLayer-687"><span class="linenos">687</span></a>            <span class="c1">#s = self.sigmas**2</span>
</span><span id="FixationLayer-688"><a href="#FixationLayer-688"><span class="linenos">688</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> 
</span><span id="FixationLayer-689"><a href="#FixationLayer-689"><span class="linenos">689</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FixationLayer-690"><a href="#FixationLayer-690"><span class="linenos">690</span></a>            <span class="c1">#s = self.sigmas[x]**2</span>
</span><span id="FixationLayer-691"><a href="#FixationLayer-691"><span class="linenos">691</span></a>            <span class="n">sigma_array</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span><span id="FixationLayer-692"><a href="#FixationLayer-692"><span class="linenos">692</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">sigma_array</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span id="FixationLayer-693"><a href="#FixationLayer-693"><span class="linenos">693</span></a>
</span><span id="FixationLayer-694"><a href="#FixationLayer-694"><span class="linenos">694</span></a>        <span class="c1"># this will be batch-size x num_spatial dims (corresponding to mean loc)        </span>
</span><span id="FixationLayer-695"><a href="#FixationLayer-695"><span class="linenos">695</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>  <span class="c1"># can turn off sampling, even with training</span>
</span><span id="FixationLayer-696"><a href="#FixationLayer-696"><span class="linenos">696</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="FixationLayer-697"><a href="#FixationLayer-697"><span class="linenos">697</span></a>                <span class="c1"># add sigma-like noise around mean locations</span>
</span><span id="FixationLayer-698"><a href="#FixationLayer-698"><span class="linenos">698</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="FixationLayer-699"><a href="#FixationLayer-699"><span class="linenos">699</span></a>                    <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">,)</span>
</span><span id="FixationLayer-700"><a href="#FixationLayer-700"><span class="linenos">700</span></a>                    <span class="n">gaus_sample</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">sample_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="FixationLayer-701"><a href="#FixationLayer-701"><span class="linenos">701</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FixationLayer-702"><a href="#FixationLayer-702"><span class="linenos">702</span></a>                    <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">,)</span>
</span><span id="FixationLayer-703"><a href="#FixationLayer-703"><span class="linenos">703</span></a>                    <span class="n">gaus_sample</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">sample_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="FixationLayer-704"><a href="#FixationLayer-704"><span class="linenos">704</span></a>                
</span><span id="FixationLayer-705"><a href="#FixationLayer-705"><span class="linenos">705</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaus_sample</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="FixationLayer-706"><a href="#FixationLayer-706"><span class="linenos">706</span></a>
</span><span id="FixationLayer-707"><a href="#FixationLayer-707"><span class="linenos">707</span></a>        <span class="k">return</span> <span class="n">y</span>
</span><span id="FixationLayer-708"><a href="#FixationLayer-708"><span class="linenos">708</span></a>    <span class="c1"># END FixationLayer.forward</span>
</span><span id="FixationLayer-709"><a href="#FixationLayer-709"><span class="linenos">709</span></a>    
</span><span id="FixationLayer-710"><a href="#FixationLayer-710"><span class="linenos">710</span></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="FixationLayer-711"><a href="#FixationLayer-711"><span class="linenos">711</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer-712"><a href="#FixationLayer-712"><span class="linenos">712</span></a><span class="sd">        This will initialize the layer parameters.</span>
</span><span id="FixationLayer-713"><a href="#FixationLayer-713"><span class="linenos">713</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer-714"><a href="#FixationLayer-714"><span class="linenos">714</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;initialize is not implemented for &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="FixationLayer-715"><a href="#FixationLayer-715"><span class="linenos">715</span></a>
</span><span id="FixationLayer-716"><a href="#FixationLayer-716"><span class="linenos">716</span></a>    <span class="nd">@classmethod</span>
</span><span id="FixationLayer-717"><a href="#FixationLayer-717"><span class="linenos">717</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="FixationLayer-718"><a href="#FixationLayer-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer-719"><a href="#FixationLayer-719"><span class="linenos">719</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="FixationLayer-720"><a href="#FixationLayer-720"><span class="linenos">720</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="FixationLayer-721"><a href="#FixationLayer-721"><span class="linenos">721</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="FixationLayer-722"><a href="#FixationLayer-722"><span class="linenos">722</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="FixationLayer-723"><a href="#FixationLayer-723"><span class="linenos">723</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="FixationLayer-724"><a href="#FixationLayer-724"><span class="linenos">724</span></a>
</span><span id="FixationLayer-725"><a href="#FixationLayer-725"><span class="linenos">725</span></a><span class="sd">        Args:</span>
</span><span id="FixationLayer-726"><a href="#FixationLayer-726"><span class="linenos">726</span></a><span class="sd">            num_fixations: int, number of fixations</span>
</span><span id="FixationLayer-727"><a href="#FixationLayer-727"><span class="linenos">727</span></a><span class="sd">            num_spatial_dims: int, number of spatial dimensions</span>
</span><span id="FixationLayer-728"><a href="#FixationLayer-728"><span class="linenos">728</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="FixationLayer-729"><a href="#FixationLayer-729"><span class="linenos">729</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="FixationLayer-730"><a href="#FixationLayer-730"><span class="linenos">730</span></a>
</span><span id="FixationLayer-731"><a href="#FixationLayer-731"><span class="linenos">731</span></a><span class="sd">        Returns:</span>
</span><span id="FixationLayer-732"><a href="#FixationLayer-732"><span class="linenos">732</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="FixationLayer-733"><a href="#FixationLayer-733"><span class="linenos">733</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer-734"><a href="#FixationLayer-734"><span class="linenos">734</span></a>        <span class="k">if</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FixationLayer-735"><a href="#FixationLayer-735"><span class="linenos">735</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;FIX DICT: Set filter_dims to #fixations and leave input_dims alone&quot;</span>
</span><span id="FixationLayer-736"><a href="#FixationLayer-736"><span class="linenos">736</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="FixationLayer-737"><a href="#FixationLayer-737"><span class="linenos">737</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixation&#39;</span>
</span><span id="FixationLayer-738"><a href="#FixationLayer-738"><span class="linenos">738</span></a>        <span class="c1"># delete standard layer info for purposes of constructor</span>
</span><span id="FixationLayer-739"><a href="#FixationLayer-739"><span class="linenos">739</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">]</span>
</span><span id="FixationLayer-740"><a href="#FixationLayer-740"><span class="linenos">740</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span>
</span><span id="FixationLayer-741"><a href="#FixationLayer-741"><span class="linenos">741</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
</span><span id="FixationLayer-742"><a href="#FixationLayer-742"><span class="linenos">742</span></a>        <span class="c1"># Added arguments</span>
</span><span id="FixationLayer-743"><a href="#FixationLayer-743"><span class="linenos">743</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FixationLayer-744"><a href="#FixationLayer-744"><span class="linenos">744</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;fix_n_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer-745"><a href="#FixationLayer-745"><span class="linenos">745</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_mu_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="FixationLayer-746"><a href="#FixationLayer-746"><span class="linenos">746</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="FixationLayer-747"><a href="#FixationLayer-747"><span class="linenos">747</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;single_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer-748"><a href="#FixationLayer-748"><span class="linenos">748</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;gauss_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;uncorrelated&#39;</span>
</span><span id="FixationLayer-749"><a href="#FixationLayer-749"><span class="linenos">749</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;align_corners&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer-750"><a href="#FixationLayer-750"><span class="linenos">750</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_fixations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_fixations</span>
</span><span id="FixationLayer-751"><a href="#FixationLayer-751"><span class="linenos">751</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_spatial_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="FixationLayer-752"><a href="#FixationLayer-752"><span class="linenos">752</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="FixationLayer-753"><a href="#FixationLayer-753"><span class="linenos">753</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="FixationLayer-754"><a href="#FixationLayer-754"><span class="linenos">754</span></a>    <span class="c1"># END [classmethod] FixatonLayer.layer_dict</span>
</span></pre></div>


            <div class="docstring"><p>FixationLayer for fixation.</p>
</div>


                            <div id="FixationLayer.__init__" class="classattr">
                                        <input id="FixationLayer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FixationLayer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">batch_sample</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">fix_n_index</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.3</span>,</span><span class="param">	<span class="n">single_sigma</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">bias</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="FixationLayer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FixationLayer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FixationLayer.__init__-593"><a href="#FixationLayer.__init__-593"><span class="linenos">593</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-594"><a href="#FixationLayer.__init__-594"><span class="linenos">594</span></a>            <span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="FixationLayer.__init__-595"><a href="#FixationLayer.__init__-595"><span class="linenos">595</span></a>            <span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-596"><a href="#FixationLayer.__init__-596"><span class="linenos">596</span></a>            <span class="c1">#input_dims=None,  # this has to be set to [1,1,1,1] by default</span>
</span><span id="FixationLayer.__init__-597"><a href="#FixationLayer.__init__-597"><span class="linenos">597</span></a>            <span class="n">batch_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-598"><a href="#FixationLayer.__init__-598"><span class="linenos">598</span></a>            <span class="n">fix_n_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-599"><a href="#FixationLayer.__init__-599"><span class="linenos">599</span></a>            <span class="c1">#init_mu_range=0.1,</span>
</span><span id="FixationLayer.__init__-600"><a href="#FixationLayer.__init__-600"><span class="linenos">600</span></a>            <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-601"><a href="#FixationLayer.__init__-601"><span class="linenos">601</span></a>            <span class="n">single_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-602"><a href="#FixationLayer.__init__-602"><span class="linenos">602</span></a>            <span class="c1">#gauss_type: str=&#39;uncorrelated&#39;, # &#39;isotropic&#39;, &#39;uncorrelated&#39;, or &#39;full&#39;</span>
</span><span id="FixationLayer.__init__-603"><a href="#FixationLayer.__init__-603"><span class="linenos">603</span></a>            <span class="c1">#align_corners=False,</span>
</span><span id="FixationLayer.__init__-604"><a href="#FixationLayer.__init__-604"><span class="linenos">604</span></a>            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-605"><a href="#FixationLayer.__init__-605"><span class="linenos">605</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-606"><a href="#FixationLayer.__init__-606"><span class="linenos">606</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="FixationLayer.__init__-607"><a href="#FixationLayer.__init__-607"><span class="linenos">607</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer.__init__-608"><a href="#FixationLayer.__init__-608"><span class="linenos">608</span></a><span class="sd">        Layer weights become the shift for each fixation, sigma is constant over each dimension.</span>
</span><span id="FixationLayer.__init__-609"><a href="#FixationLayer.__init__-609"><span class="linenos">609</span></a><span class="sd">        </span>
</span><span id="FixationLayer.__init__-610"><a href="#FixationLayer.__init__-610"><span class="linenos">610</span></a><span class="sd">        Args:</span>
</span><span id="FixationLayer.__init__-611"><a href="#FixationLayer.__init__-611"><span class="linenos">611</span></a><span class="sd">            num_fixations: int, number of fixations</span>
</span><span id="FixationLayer.__init__-612"><a href="#FixationLayer.__init__-612"><span class="linenos">612</span></a><span class="sd">            num_spatial_dims: int, number of spatial dimensions</span>
</span><span id="FixationLayer.__init__-613"><a href="#FixationLayer.__init__-613"><span class="linenos">613</span></a><span class="sd">            batch_sample: bool, whether to sample grid locations separately per sample per batch</span>
</span><span id="FixationLayer.__init__-614"><a href="#FixationLayer.__init__-614"><span class="linenos">614</span></a><span class="sd">            fix_n_index: bool, whether to index fixations starting at 1</span>
</span><span id="FixationLayer.__init__-615"><a href="#FixationLayer.__init__-615"><span class="linenos">615</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="FixationLayer.__init__-616"><a href="#FixationLayer.__init__-616"><span class="linenos">616</span></a><span class="sd">            single_sigma: bool, whether to use a single sigma for all fixations</span>
</span><span id="FixationLayer.__init__-617"><a href="#FixationLayer.__init__-617"><span class="linenos">617</span></a><span class="sd">            bias: bool, whether to include bias term</span>
</span><span id="FixationLayer.__init__-618"><a href="#FixationLayer.__init__-618"><span class="linenos">618</span></a><span class="sd">            NLtype: str, type of nonlinearity</span>
</span><span id="FixationLayer.__init__-619"><a href="#FixationLayer.__init__-619"><span class="linenos">619</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer.__init__-620"><a href="#FixationLayer.__init__-620"><span class="linenos">620</span></a>        <span class="c1">#self.num_fixations = layer_params[&#39;input_dims&#39;][0]</span>
</span><span id="FixationLayer.__init__-621"><a href="#FixationLayer.__init__-621"><span class="linenos">621</span></a>        <span class="c1">#assert np.prod(input_dims[1:]) == 1, &#39;something wrong with fix-layer input_dims&#39;</span>
</span><span id="FixationLayer.__init__-622"><a href="#FixationLayer.__init__-622"><span class="linenos">622</span></a>        <span class="k">assert</span> <span class="n">num_fixations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;FIX LAYER: Must set number of fixations&quot;</span>
</span><span id="FixationLayer.__init__-623"><a href="#FixationLayer.__init__-623"><span class="linenos">623</span></a>        <span class="k">assert</span> <span class="n">num_spatial_dims</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;FIX LAYER: num_space must be set to spatial dimensionality (1 or 2)&quot;</span>
</span><span id="FixationLayer.__init__-624"><a href="#FixationLayer.__init__-624"><span class="linenos">624</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">bias</span><span class="p">,</span> <span class="s2">&quot;FIX LAYER: cannot have bias term&quot;</span>
</span><span id="FixationLayer.__init__-625"><a href="#FixationLayer.__init__-625"><span class="linenos">625</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer.__init__-626"><a href="#FixationLayer.__init__-626"><span class="linenos">626</span></a>
</span><span id="FixationLayer.__init__-627"><a href="#FixationLayer.__init__-627"><span class="linenos">627</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="FixationLayer.__init__-628"><a href="#FixationLayer.__init__-628"><span class="linenos">628</span></a>            <span class="n">num_filters</span> <span class="o">=</span> <span class="n">num_spatial_dims</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-629"><a href="#FixationLayer.__init__-629"><span class="linenos">629</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_fixations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="FixationLayer.__init__-630"><a href="#FixationLayer.__init__-630"><span class="linenos">630</span></a>            <span class="n">NLtype</span> <span class="o">=</span> <span class="n">NLtype</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-631"><a href="#FixationLayer.__init__-631"><span class="linenos">631</span></a>            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
</span><span id="FixationLayer.__init__-632"><a href="#FixationLayer.__init__-632"><span class="linenos">632</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="FixationLayer.__init__-633"><a href="#FixationLayer.__init__-633"><span class="linenos">633</span></a>
</span><span id="FixationLayer.__init__-634"><a href="#FixationLayer.__init__-634"><span class="linenos">634</span></a>        <span class="c1"># Determine whether one- or two-dimensional readout</span>
</span><span id="FixationLayer.__init__-635"><a href="#FixationLayer.__init__-635"><span class="linenos">635</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span> <span class="o">=</span> <span class="n">num_spatial_dims</span>
</span><span id="FixationLayer.__init__-636"><a href="#FixationLayer.__init__-636"><span class="linenos">636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span> <span class="o">=</span> <span class="n">num_fixations</span>
</span><span id="FixationLayer.__init__-637"><a href="#FixationLayer.__init__-637"><span class="linenos">637</span></a>
</span><span id="FixationLayer.__init__-638"><a href="#FixationLayer.__init__-638"><span class="linenos">638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span> <span class="o">=</span> <span class="n">batch_sample</span>
</span><span id="FixationLayer.__init__-639"><a href="#FixationLayer.__init__-639"><span class="linenos">639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="FixationLayer.__init__-640"><a href="#FixationLayer.__init__-640"><span class="linenos">640</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span> <span class="o">=</span> <span class="n">single_sigma</span>
</span><span id="FixationLayer.__init__-641"><a href="#FixationLayer.__init__-641"><span class="linenos">641</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n_index</span> <span class="o">=</span> <span class="n">fix_n_index</span>
</span><span id="FixationLayer.__init__-642"><a href="#FixationLayer.__init__-642"><span class="linenos">642</span></a>
</span><span id="FixationLayer.__init__-643"><a href="#FixationLayer.__init__-643"><span class="linenos">643</span></a>        <span class="c1"># shared sigmas across all fixations</span>
</span><span id="FixationLayer.__init__-644"><a href="#FixationLayer.__init__-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span><span class="p">:</span>
</span><span id="FixationLayer.__init__-645"><a href="#FixationLayer.__init__-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">))</span> 
</span><span id="FixationLayer.__init__-646"><a href="#FixationLayer.__init__-646"><span class="linenos">646</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FixationLayer.__init__-647"><a href="#FixationLayer.__init__-647"><span class="linenos">647</span></a>            <span class="c1"># individual sigmas for each fixation </span>
</span><span id="FixationLayer.__init__-648"><a href="#FixationLayer.__init__-648"><span class="linenos">648</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="FixationLayer.__init__-649"><a href="#FixationLayer.__init__-649"><span class="linenos">649</span></a>        
</span><span id="FixationLayer.__init__-650"><a href="#FixationLayer.__init__-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_sigma</span><span class="p">)</span>
</span><span id="FixationLayer.__init__-651"><a href="#FixationLayer.__init__-651"><span class="linenos">651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="FixationLayer.__init__-652"><a href="#FixationLayer.__init__-652"><span class="linenos">652</span></a>        
</span><span id="FixationLayer.__init__-653"><a href="#FixationLayer.__init__-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Layer weights become the shift for each fixation, sigma is constant over each dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_fixations:</strong>  int, number of fixations</li>
<li><strong>num_spatial_dims:</strong>  int, number of spatial dimensions</li>
<li><strong>batch_sample:</strong>  bool, whether to sample grid locations separately per sample per batch</li>
<li><strong>fix_n_index:</strong>  bool, whether to index fixations starting at 1</li>
<li><strong>init_sigma:</strong>  float, standard deviation for uniform initialization of sigmas</li>
<li><strong>single_sigma:</strong>  bool, whether to use a single sigma for all fixations</li>
<li><strong>bias:</strong>  bool, whether to include bias term</li>
<li><strong>NLtype:</strong>  str, type of nonlinearity</li>
</ul>
</div>


                            </div>
                            <div id="FixationLayer.num_spatial_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">num_spatial_dims</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.num_spatial_dims"></a>
    
    

                            </div>
                            <div id="FixationLayer.num_fixations" class="classattr">
                                <div class="attr variable">
            <span class="name">num_fixations</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.num_fixations"></a>
    
    

                            </div>
                            <div id="FixationLayer.batch_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_sample</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.batch_sample"></a>
    
    

                            </div>
                            <div id="FixationLayer.init_sigma" class="classattr">
                                <div class="attr variable">
            <span class="name">init_sigma</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.init_sigma"></a>
    
    

                            </div>
                            <div id="FixationLayer.single_sigma" class="classattr">
                                <div class="attr variable">
            <span class="name">single_sigma</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.single_sigma"></a>
    
    

                            </div>
                            <div id="FixationLayer.fix_n_index" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_n_index</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.fix_n_index"></a>
    
    

                            </div>
                            <div id="FixationLayer.sample" class="classattr">
                                <div class="attr variable">
            <span class="name">sample</span>

        
    </div>
    <a class="headerlink" href="#FixationLayer.sample"></a>
    
    

                            </div>
                            <div id="FixationLayer.forward" class="classattr">
                                        <input id="FixationLayer.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">shift</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FixationLayer.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FixationLayer.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FixationLayer.forward-656"><a href="#FixationLayer.forward-656"><span class="linenos">656</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="FixationLayer.forward-657"><a href="#FixationLayer.forward-657"><span class="linenos">657</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer.forward-658"><a href="#FixationLayer.forward-658"><span class="linenos">658</span></a><span class="sd">        The input is the sampled fixation-stim</span>
</span><span id="FixationLayer.forward-659"><a href="#FixationLayer.forward-659"><span class="linenos">659</span></a><span class="sd">        </span>
</span><span id="FixationLayer.forward-660"><a href="#FixationLayer.forward-660"><span class="linenos">660</span></a><span class="sd">        Args:</span>
</span><span id="FixationLayer.forward-661"><a href="#FixationLayer.forward-661"><span class="linenos">661</span></a><span class="sd">            x: input data</span>
</span><span id="FixationLayer.forward-662"><a href="#FixationLayer.forward-662"><span class="linenos">662</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="FixationLayer.forward-663"><a href="#FixationLayer.forward-663"><span class="linenos">663</span></a>
</span><span id="FixationLayer.forward-664"><a href="#FixationLayer.forward-664"><span class="linenos">664</span></a><span class="sd">        Returns:</span>
</span><span id="FixationLayer.forward-665"><a href="#FixationLayer.forward-665"><span class="linenos">665</span></a><span class="sd">            y: neuronal activity</span>
</span><span id="FixationLayer.forward-666"><a href="#FixationLayer.forward-666"><span class="linenos">666</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer.forward-667"><a href="#FixationLayer.forward-667"><span class="linenos">667</span></a>        <span class="c1"># with torch.no_grad():</span>
</span><span id="FixationLayer.forward-668"><a href="#FixationLayer.forward-668"><span class="linenos">668</span></a>        <span class="c1"># self.weight.clamp(min=-1, max=1)  # at eval time, only self.mu is used so it must belong to [-1,1]</span>
</span><span id="FixationLayer.forward-669"><a href="#FixationLayer.forward-669"><span class="linenos">669</span></a>        <span class="c1"># self.sigmas.clamp(min=0)  # sigma/variance is always a positive quantity</span>
</span><span id="FixationLayer.forward-670"><a href="#FixationLayer.forward-670"><span class="linenos">670</span></a>        
</span><span id="FixationLayer.forward-671"><a href="#FixationLayer.forward-671"><span class="linenos">671</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># batch size</span>
</span><span id="FixationLayer.forward-672"><a href="#FixationLayer.forward-672"><span class="linenos">672</span></a>        <span class="c1"># If using X-matrix to extract relevant weights</span>
</span><span id="FixationLayer.forward-673"><a href="#FixationLayer.forward-673"><span class="linenos">673</span></a>        <span class="c1"># y = (x@self.weight) </span>
</span><span id="FixationLayer.forward-674"><a href="#FixationLayer.forward-674"><span class="linenos">674</span></a>        <span class="c1"># use indexing: x is just a list of weight indices</span>
</span><span id="FixationLayer.forward-675"><a href="#FixationLayer.forward-675"><span class="linenos">675</span></a>        
</span><span id="FixationLayer.forward-676"><a href="#FixationLayer.forward-676"><span class="linenos">676</span></a>        <span class="c1"># In case x gets passed in with trivial second dim (squeeze)</span>
</span><span id="FixationLayer.forward-677"><a href="#FixationLayer.forward-677"><span class="linenos">677</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FixationLayer.forward-678"><a href="#FixationLayer.forward-678"><span class="linenos">678</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  WARNING: fixations should not have second dimension -- squeeze it&#39;</span><span class="p">)</span>
</span><span id="FixationLayer.forward-679"><a href="#FixationLayer.forward-679"><span class="linenos">679</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
</span><span id="FixationLayer.forward-680"><a href="#FixationLayer.forward-680"><span class="linenos">680</span></a>
</span><span id="FixationLayer.forward-681"><a href="#FixationLayer.forward-681"><span class="linenos">681</span></a>        <span class="c1"># Actual fixations labeled 1-NFIX</span>
</span><span id="FixationLayer.forward-682"><a href="#FixationLayer.forward-682"><span class="linenos">682</span></a>        <span class="c1"># Will make by default fixation label &#39;0&#39; lead to no shift</span>
</span><span id="FixationLayer.forward-683"><a href="#FixationLayer.forward-683"><span class="linenos">683</span></a>        <span class="n">shift_array</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span><span id="FixationLayer.forward-684"><a href="#FixationLayer.forward-684"><span class="linenos">684</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">shift_array</span><span class="p">[</span><span class="n">x</span><span class="p">,:])</span>   <span class="c1"># fix_n</span>
</span><span id="FixationLayer.forward-685"><a href="#FixationLayer.forward-685"><span class="linenos">685</span></a>
</span><span id="FixationLayer.forward-686"><a href="#FixationLayer.forward-686"><span class="linenos">686</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_sigma</span><span class="p">:</span>
</span><span id="FixationLayer.forward-687"><a href="#FixationLayer.forward-687"><span class="linenos">687</span></a>            <span class="c1">#s = self.sigmas**2</span>
</span><span id="FixationLayer.forward-688"><a href="#FixationLayer.forward-688"><span class="linenos">688</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span> 
</span><span id="FixationLayer.forward-689"><a href="#FixationLayer.forward-689"><span class="linenos">689</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FixationLayer.forward-690"><a href="#FixationLayer.forward-690"><span class="linenos">690</span></a>            <span class="c1">#s = self.sigmas[x]**2</span>
</span><span id="FixationLayer.forward-691"><a href="#FixationLayer.forward-691"><span class="linenos">691</span></a>            <span class="n">sigma_array</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</span><span id="FixationLayer.forward-692"><a href="#FixationLayer.forward-692"><span class="linenos">692</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">sigma_array</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span id="FixationLayer.forward-693"><a href="#FixationLayer.forward-693"><span class="linenos">693</span></a>
</span><span id="FixationLayer.forward-694"><a href="#FixationLayer.forward-694"><span class="linenos">694</span></a>        <span class="c1"># this will be batch-size x num_spatial dims (corresponding to mean loc)        </span>
</span><span id="FixationLayer.forward-695"><a href="#FixationLayer.forward-695"><span class="linenos">695</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>  <span class="c1"># can turn off sampling, even with training</span>
</span><span id="FixationLayer.forward-696"><a href="#FixationLayer.forward-696"><span class="linenos">696</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="FixationLayer.forward-697"><a href="#FixationLayer.forward-697"><span class="linenos">697</span></a>                <span class="c1"># add sigma-like noise around mean locations</span>
</span><span id="FixationLayer.forward-698"><a href="#FixationLayer.forward-698"><span class="linenos">698</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="FixationLayer.forward-699"><a href="#FixationLayer.forward-699"><span class="linenos">699</span></a>                    <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">,)</span>
</span><span id="FixationLayer.forward-700"><a href="#FixationLayer.forward-700"><span class="linenos">700</span></a>                    <span class="n">gaus_sample</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">sample_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="FixationLayer.forward-701"><a href="#FixationLayer.forward-701"><span class="linenos">701</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FixationLayer.forward-702"><a href="#FixationLayer.forward-702"><span class="linenos">702</span></a>                    <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_spatial_dims</span><span class="p">,)</span>
</span><span id="FixationLayer.forward-703"><a href="#FixationLayer.forward-703"><span class="linenos">703</span></a>                    <span class="n">gaus_sample</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">sample_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="FixationLayer.forward-704"><a href="#FixationLayer.forward-704"><span class="linenos">704</span></a>                
</span><span id="FixationLayer.forward-705"><a href="#FixationLayer.forward-705"><span class="linenos">705</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaus_sample</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="FixationLayer.forward-706"><a href="#FixationLayer.forward-706"><span class="linenos">706</span></a>
</span><span id="FixationLayer.forward-707"><a href="#FixationLayer.forward-707"><span class="linenos">707</span></a>        <span class="k">return</span> <span class="n">y</span>
</span></pre></div>


            <div class="docstring"><p>The input is the sampled fixation-stim</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>x:</strong>  input data</li>
<li><strong>shift (bool):</strong>  shifts the location of the grid (from eye-tracking data)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>y: neuronal activity</p>
</blockquote>
</div>


                            </div>
                            <div id="FixationLayer.initialize" class="classattr">
                                        <input id="FixationLayer.initialize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FixationLayer.initialize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FixationLayer.initialize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FixationLayer.initialize-710"><a href="#FixationLayer.initialize-710"><span class="linenos">710</span></a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="FixationLayer.initialize-711"><a href="#FixationLayer.initialize-711"><span class="linenos">711</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer.initialize-712"><a href="#FixationLayer.initialize-712"><span class="linenos">712</span></a><span class="sd">        This will initialize the layer parameters.</span>
</span><span id="FixationLayer.initialize-713"><a href="#FixationLayer.initialize-713"><span class="linenos">713</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer.initialize-714"><a href="#FixationLayer.initialize-714"><span class="linenos">714</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;initialize is not implemented for &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This will initialize the layer parameters.</p>
</div>


                            </div>
                            <div id="FixationLayer.layer_dict" class="classattr">
                                        <input id="FixationLayer.layer_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">layer_dict</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.25</span>,</span><span class="param">	<span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FixationLayer.layer_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FixationLayer.layer_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FixationLayer.layer_dict-716"><a href="#FixationLayer.layer_dict-716"><span class="linenos">716</span></a>    <span class="nd">@classmethod</span>
</span><span id="FixationLayer.layer_dict-717"><a href="#FixationLayer.layer_dict-717"><span class="linenos">717</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">num_fixations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">init_sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="FixationLayer.layer_dict-718"><a href="#FixationLayer.layer_dict-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FixationLayer.layer_dict-719"><a href="#FixationLayer.layer_dict-719"><span class="linenos">719</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="FixationLayer.layer_dict-720"><a href="#FixationLayer.layer_dict-720"><span class="linenos">720</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="FixationLayer.layer_dict-721"><a href="#FixationLayer.layer_dict-721"><span class="linenos">721</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="FixationLayer.layer_dict-722"><a href="#FixationLayer.layer_dict-722"><span class="linenos">722</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="FixationLayer.layer_dict-723"><a href="#FixationLayer.layer_dict-723"><span class="linenos">723</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="FixationLayer.layer_dict-724"><a href="#FixationLayer.layer_dict-724"><span class="linenos">724</span></a>
</span><span id="FixationLayer.layer_dict-725"><a href="#FixationLayer.layer_dict-725"><span class="linenos">725</span></a><span class="sd">        Args:</span>
</span><span id="FixationLayer.layer_dict-726"><a href="#FixationLayer.layer_dict-726"><span class="linenos">726</span></a><span class="sd">            num_fixations: int, number of fixations</span>
</span><span id="FixationLayer.layer_dict-727"><a href="#FixationLayer.layer_dict-727"><span class="linenos">727</span></a><span class="sd">            num_spatial_dims: int, number of spatial dimensions</span>
</span><span id="FixationLayer.layer_dict-728"><a href="#FixationLayer.layer_dict-728"><span class="linenos">728</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="FixationLayer.layer_dict-729"><a href="#FixationLayer.layer_dict-729"><span class="linenos">729</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="FixationLayer.layer_dict-730"><a href="#FixationLayer.layer_dict-730"><span class="linenos">730</span></a>
</span><span id="FixationLayer.layer_dict-731"><a href="#FixationLayer.layer_dict-731"><span class="linenos">731</span></a><span class="sd">        Returns:</span>
</span><span id="FixationLayer.layer_dict-732"><a href="#FixationLayer.layer_dict-732"><span class="linenos">732</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="FixationLayer.layer_dict-733"><a href="#FixationLayer.layer_dict-733"><span class="linenos">733</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FixationLayer.layer_dict-734"><a href="#FixationLayer.layer_dict-734"><span class="linenos">734</span></a>        <span class="k">if</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FixationLayer.layer_dict-735"><a href="#FixationLayer.layer_dict-735"><span class="linenos">735</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;FIX DICT: Set filter_dims to #fixations and leave input_dims alone&quot;</span>
</span><span id="FixationLayer.layer_dict-736"><a href="#FixationLayer.layer_dict-736"><span class="linenos">736</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="FixationLayer.layer_dict-737"><a href="#FixationLayer.layer_dict-737"><span class="linenos">737</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixation&#39;</span>
</span><span id="FixationLayer.layer_dict-738"><a href="#FixationLayer.layer_dict-738"><span class="linenos">738</span></a>        <span class="c1"># delete standard layer info for purposes of constructor</span>
</span><span id="FixationLayer.layer_dict-739"><a href="#FixationLayer.layer_dict-739"><span class="linenos">739</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">]</span>
</span><span id="FixationLayer.layer_dict-740"><a href="#FixationLayer.layer_dict-740"><span class="linenos">740</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span>
</span><span id="FixationLayer.layer_dict-741"><a href="#FixationLayer.layer_dict-741"><span class="linenos">741</span></a>        <span class="k">del</span> <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
</span><span id="FixationLayer.layer_dict-742"><a href="#FixationLayer.layer_dict-742"><span class="linenos">742</span></a>        <span class="c1"># Added arguments</span>
</span><span id="FixationLayer.layer_dict-743"><a href="#FixationLayer.layer_dict-743"><span class="linenos">743</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FixationLayer.layer_dict-744"><a href="#FixationLayer.layer_dict-744"><span class="linenos">744</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;fix_n_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer.layer_dict-745"><a href="#FixationLayer.layer_dict-745"><span class="linenos">745</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_mu_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="FixationLayer.layer_dict-746"><a href="#FixationLayer.layer_dict-746"><span class="linenos">746</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_sigma</span>
</span><span id="FixationLayer.layer_dict-747"><a href="#FixationLayer.layer_dict-747"><span class="linenos">747</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;single_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer.layer_dict-748"><a href="#FixationLayer.layer_dict-748"><span class="linenos">748</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;gauss_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;uncorrelated&#39;</span>
</span><span id="FixationLayer.layer_dict-749"><a href="#FixationLayer.layer_dict-749"><span class="linenos">749</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;align_corners&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FixationLayer.layer_dict-750"><a href="#FixationLayer.layer_dict-750"><span class="linenos">750</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_fixations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_fixations</span>
</span><span id="FixationLayer.layer_dict-751"><a href="#FixationLayer.layer_dict-751"><span class="linenos">751</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;num_spatial_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="FixationLayer.layer_dict-752"><a href="#FixationLayer.layer_dict-752"><span class="linenos">752</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="FixationLayer.layer_dict-753"><a href="#FixationLayer.layer_dict-753"><span class="linenos">753</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span></pre></div>


            <div class="docstring"><p>This outputs a dictionary of parameters that need to input into the layer to completely specify.
Output is a dictionary with these keywords. 
-- All layer-specific inputs are included in the returned dict
-- Values that must be set are set to empty lists
-- Other values will be given their defaults</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_fixations:</strong>  int, number of fixations</li>
<li><strong>num_spatial_dims:</strong>  int, number of spatial dimensions</li>
<li><strong>init_sigma:</strong>  float, standard deviation for uniform initialization of sigmas</li>
<li><strong>input_dims:</strong>  tuple or list of ints, (num_channels, height, width, lags)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Ldict: dictionary of layer parameters</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="ndnlayer.html#NDNLayer">NDNT.modules.layers.ndnlayer.NDNLayer</a></dt>
                                <dd id="FixationLayer.input_dims" class="variable"><a href="ndnlayer.html#NDNLayer.input_dims">input_dims</a></dd>
                <dd id="FixationLayer.num_filters" class="variable"><a href="ndnlayer.html#NDNLayer.num_filters">num_filters</a></dd>
                <dd id="FixationLayer.output_dims" class="variable"><a href="ndnlayer.html#NDNLayer.output_dims">output_dims</a></dd>
                <dd id="FixationLayer.norm_type" class="variable"><a href="ndnlayer.html#NDNLayer.norm_type">norm_type</a></dd>
                <dd id="FixationLayer.pos_constraint" class="variable"><a href="ndnlayer.html#NDNLayer.pos_constraint">pos_constraint</a></dd>
                <dd id="FixationLayer.conv" class="variable"><a href="ndnlayer.html#NDNLayer.conv">conv</a></dd>
                <dd id="FixationLayer.NL" class="variable"><a href="ndnlayer.html#NDNLayer.NL">NL</a></dd>
                <dd id="FixationLayer.shape" class="variable"><a href="ndnlayer.html#NDNLayer.shape">shape</a></dd>
                <dd id="FixationLayer.weight_scale" class="variable"><a href="ndnlayer.html#NDNLayer.weight_scale">weight_scale</a></dd>
                <dd id="FixationLayer.weight" class="variable"><a href="ndnlayer.html#NDNLayer.weight">weight</a></dd>
                <dd id="FixationLayer.reg" class="variable"><a href="ndnlayer.html#NDNLayer.reg">reg</a></dd>
                <dd id="FixationLayer.num_inh" class="variable"><a href="ndnlayer.html#NDNLayer.num_inh">num_inh</a></dd>
                <dd id="FixationLayer.reset_parameters" class="function"><a href="ndnlayer.html#NDNLayer.reset_parameters">reset_parameters</a></dd>
                <dd id="FixationLayer.initialize_gaussian_envelope" class="function"><a href="ndnlayer.html#NDNLayer.initialize_gaussian_envelope">initialize_gaussian_envelope</a></dd>
                <dd id="FixationLayer.preprocess_weights" class="function"><a href="ndnlayer.html#NDNLayer.preprocess_weights">preprocess_weights</a></dd>
                <dd id="FixationLayer.compute_reg_loss" class="function"><a href="ndnlayer.html#NDNLayer.compute_reg_loss">compute_reg_loss</a></dd>
                <dd id="FixationLayer.get_weights" class="function"><a href="ndnlayer.html#NDNLayer.get_weights">get_weights</a></dd>
                <dd id="FixationLayer.list_parameters" class="function"><a href="ndnlayer.html#NDNLayer.list_parameters">list_parameters</a></dd>
                <dd id="FixationLayer.set_parameters" class="function"><a href="ndnlayer.html#NDNLayer.set_parameters">set_parameters</a></dd>
                <dd id="FixationLayer.set_reg_val" class="function"><a href="ndnlayer.html#NDNLayer.set_reg_val">set_reg_val</a></dd>
                <dd id="FixationLayer.plot_filters" class="function"><a href="ndnlayer.html#NDNLayer.plot_filters">plot_filters</a></dd>
                <dd id="FixationLayer.info" class="function"><a href="ndnlayer.html#NDNLayer.info">info</a></dd>
                <dd id="FixationLayer.dim_info" class="function"><a href="ndnlayer.html#NDNLayer.dim_info">dim_info</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="FixationLayer.dump_patches" class="variable">dump_patches</dd>
                <dd id="FixationLayer.training" class="variable">training</dd>
                <dd id="FixationLayer.call_super_init" class="variable">call_super_init</dd>
                <dd id="FixationLayer.register_buffer" class="function">register_buffer</dd>
                <dd id="FixationLayer.register_parameter" class="function">register_parameter</dd>
                <dd id="FixationLayer.add_module" class="function">add_module</dd>
                <dd id="FixationLayer.register_module" class="function">register_module</dd>
                <dd id="FixationLayer.get_submodule" class="function">get_submodule</dd>
                <dd id="FixationLayer.get_parameter" class="function">get_parameter</dd>
                <dd id="FixationLayer.get_buffer" class="function">get_buffer</dd>
                <dd id="FixationLayer.get_extra_state" class="function">get_extra_state</dd>
                <dd id="FixationLayer.set_extra_state" class="function">set_extra_state</dd>
                <dd id="FixationLayer.apply" class="function">apply</dd>
                <dd id="FixationLayer.cuda" class="function">cuda</dd>
                <dd id="FixationLayer.ipu" class="function">ipu</dd>
                <dd id="FixationLayer.xpu" class="function">xpu</dd>
                <dd id="FixationLayer.cpu" class="function">cpu</dd>
                <dd id="FixationLayer.type" class="function">type</dd>
                <dd id="FixationLayer.float" class="function">float</dd>
                <dd id="FixationLayer.double" class="function">double</dd>
                <dd id="FixationLayer.half" class="function">half</dd>
                <dd id="FixationLayer.bfloat16" class="function">bfloat16</dd>
                <dd id="FixationLayer.to_empty" class="function">to_empty</dd>
                <dd id="FixationLayer.to" class="function">to</dd>
                <dd id="FixationLayer.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="FixationLayer.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="FixationLayer.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="FixationLayer.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="FixationLayer.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="FixationLayer.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="FixationLayer.state_dict" class="function">state_dict</dd>
                <dd id="FixationLayer.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="FixationLayer.load_state_dict" class="function">load_state_dict</dd>
                <dd id="FixationLayer.parameters" class="function">parameters</dd>
                <dd id="FixationLayer.named_parameters" class="function">named_parameters</dd>
                <dd id="FixationLayer.buffers" class="function">buffers</dd>
                <dd id="FixationLayer.named_buffers" class="function">named_buffers</dd>
                <dd id="FixationLayer.children" class="function">children</dd>
                <dd id="FixationLayer.named_children" class="function">named_children</dd>
                <dd id="FixationLayer.modules" class="function">modules</dd>
                <dd id="FixationLayer.named_modules" class="function">named_modules</dd>
                <dd id="FixationLayer.train" class="function">train</dd>
                <dd id="FixationLayer.eval" class="function">eval</dd>
                <dd id="FixationLayer.requires_grad_" class="function">requires_grad_</dd>
                <dd id="FixationLayer.zero_grad" class="function">zero_grad</dd>
                <dd id="FixationLayer.share_memory" class="function">share_memory</dd>
                <dd id="FixationLayer.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ReadoutLayerQsample">
                            <input id="ReadoutLayerQsample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ReadoutLayerQsample</span><wbr>(<span class="base"><a href="#ReadoutLayer3d">ReadoutLayer3d</a></span>):

                <label class="view-source-button" for="ReadoutLayerQsample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample-756"><a href="#ReadoutLayerQsample-756"><span class="linenos"> 756</span></a><span class="k">class</span> <span class="nc">ReadoutLayerQsample</span><span class="p">(</span><span class="n">ReadoutLayer3d</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample-757"><a href="#ReadoutLayerQsample-757"><span class="linenos"> 757</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-758"><a href="#ReadoutLayerQsample-758"><span class="linenos"> 758</span></a><span class="sd">    ReadoutLayerQsample for 3d readout with sampling over angle dimension Q.</span>
</span><span id="ReadoutLayerQsample-759"><a href="#ReadoutLayerQsample-759"><span class="linenos"> 759</span></a><span class="sd">    This is a subclass of ReadoutLayer3d.</span>
</span><span id="ReadoutLayerQsample-760"><a href="#ReadoutLayerQsample-760"><span class="linenos"> 760</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-761"><a href="#ReadoutLayerQsample-761"><span class="linenos"> 761</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_Qsample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_Qsigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Qsample_mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample-762"><a href="#ReadoutLayerQsample-762"><span class="linenos"> 762</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-763"><a href="#ReadoutLayerQsample-763"><span class="linenos"> 763</span></a><span class="sd">        ReadoutLayerQsample: 3d readout layer for NDNs.</span>
</span><span id="ReadoutLayerQsample-764"><a href="#ReadoutLayerQsample-764"><span class="linenos"> 764</span></a>
</span><span id="ReadoutLayerQsample-765"><a href="#ReadoutLayerQsample-765"><span class="linenos"> 765</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample-766"><a href="#ReadoutLayerQsample-766"><span class="linenos"> 766</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="ReadoutLayerQsample-767"><a href="#ReadoutLayerQsample-767"><span class="linenos"> 767</span></a><span class="sd">            filter_dims: tuple or list of ints, (num_channels, height, width, depth, lags)</span>
</span><span id="ReadoutLayerQsample-768"><a href="#ReadoutLayerQsample-768"><span class="linenos"> 768</span></a><span class="sd">            batch_Qample: bool, whether to sample Qgrid locations separately per sample per batch</span>
</span><span id="ReadoutLayerQsample-769"><a href="#ReadoutLayerQsample-769"><span class="linenos"> 769</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="ReadoutLayerQsample-770"><a href="#ReadoutLayerQsample-770"><span class="linenos"> 770</span></a><span class="sd">            Qsample_mode: str, &#39;bilinear&#39; or &#39;nearest&#39;</span>
</span><span id="ReadoutLayerQsample-771"><a href="#ReadoutLayerQsample-771"><span class="linenos"> 771</span></a>
</span><span id="ReadoutLayerQsample-772"><a href="#ReadoutLayerQsample-772"><span class="linenos"> 772</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-773"><a href="#ReadoutLayerQsample-773"><span class="linenos"> 773</span></a>
</span><span id="ReadoutLayerQsample-774"><a href="#ReadoutLayerQsample-774"><span class="linenos"> 774</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify input_dims&quot;</span>
</span><span id="ReadoutLayerQsample-775"><a href="#ReadoutLayerQsample-775"><span class="linenos"> 775</span></a>
</span><span id="ReadoutLayerQsample-776"><a href="#ReadoutLayerQsample-776"><span class="linenos"> 776</span></a>        <span class="c1"># Make sure filter_dims is filled in, and to single the spatial filter dimensions</span>
</span><span id="ReadoutLayerQsample-777"><a href="#ReadoutLayerQsample-777"><span class="linenos"> 777</span></a>        <span class="k">if</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-778"><a href="#ReadoutLayerQsample-778"><span class="linenos"> 778</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-779"><a href="#ReadoutLayerQsample-779"><span class="linenos"> 779</span></a>        
</span><span id="ReadoutLayerQsample-780"><a href="#ReadoutLayerQsample-780"><span class="linenos"> 780</span></a>        <span class="n">filter_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample-781"><a href="#ReadoutLayerQsample-781"><span class="linenos"> 781</span></a>        
</span><span id="ReadoutLayerQsample-782"><a href="#ReadoutLayerQsample-782"><span class="linenos"> 782</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cant handle temporal filter dims here, yet.&#39;</span>
</span><span id="ReadoutLayerQsample-783"><a href="#ReadoutLayerQsample-783"><span class="linenos"> 783</span></a>        
</span><span id="ReadoutLayerQsample-784"><a href="#ReadoutLayerQsample-784"><span class="linenos"> 784</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span>
</span><span id="ReadoutLayerQsample-785"><a href="#ReadoutLayerQsample-785"><span class="linenos"> 785</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="n">filter_dims</span><span class="p">,</span>
</span><span id="ReadoutLayerQsample-786"><a href="#ReadoutLayerQsample-786"><span class="linenos"> 786</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-787"><a href="#ReadoutLayerQsample-787"><span class="linenos"> 787</span></a>    
</span><span id="ReadoutLayerQsample-788"><a href="#ReadoutLayerQsample-788"><span class="linenos"> 788</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayerQsample-789"><a href="#ReadoutLayerQsample-789"><span class="linenos"> 789</span></a>
</span><span id="ReadoutLayerQsample-790"><a href="#ReadoutLayerQsample-790"><span class="linenos"> 790</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_Qsample</span> <span class="o">=</span> <span class="n">batch_Qsample</span>
</span><span id="ReadoutLayerQsample-791"><a href="#ReadoutLayerQsample-791"><span class="linenos"> 791</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample_mode</span> <span class="o">=</span> <span class="n">Qsample_mode</span>
</span><span id="ReadoutLayerQsample-792"><a href="#ReadoutLayerQsample-792"><span class="linenos"> 792</span></a>
</span><span id="ReadoutLayerQsample-793"><a href="#ReadoutLayerQsample-793"><span class="linenos"> 793</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span> <span class="o">=</span> <span class="n">init_Qsigma</span>
</span><span id="ReadoutLayerQsample-794"><a href="#ReadoutLayerQsample-794"><span class="linenos"> 794</span></a>
</span><span id="ReadoutLayerQsample-795"><a href="#ReadoutLayerQsample-795"><span class="linenos"> 795</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-796"><a href="#ReadoutLayerQsample-796"><span class="linenos"> 796</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;init_Qsigma is non-positive&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-797"><a href="#ReadoutLayerQsample-797"><span class="linenos"> 797</span></a>
</span><span id="ReadoutLayerQsample-798"><a href="#ReadoutLayerQsample-798"><span class="linenos"> 798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qgrid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-799"><a href="#ReadoutLayerQsample-799"><span class="linenos"> 799</span></a>
</span><span id="ReadoutLayerQsample-800"><a href="#ReadoutLayerQsample-800"><span class="linenos"> 800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="ReadoutLayerQsample-801"><a href="#ReadoutLayerQsample-801"><span class="linenos"> 801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="ReadoutLayerQsample-802"><a href="#ReadoutLayerQsample-802"><span class="linenos"> 802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-803"><a href="#ReadoutLayerQsample-803"><span class="linenos"> 803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-804"><a href="#ReadoutLayerQsample-804"><span class="linenos"> 804</span></a>        
</span><span id="ReadoutLayerQsample-805"><a href="#ReadoutLayerQsample-805"><span class="linenos"> 805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ReadoutLayerQsample-806"><a href="#ReadoutLayerQsample-806"><span class="linenos"> 806</span></a>    <span class="c1"># END ReadoutLayerQsample.__init__</span>
</span><span id="ReadoutLayerQsample-807"><a href="#ReadoutLayerQsample-807"><span class="linenos"> 807</span></a>
</span><span id="ReadoutLayerQsample-808"><a href="#ReadoutLayerQsample-808"><span class="linenos"> 808</span></a>    <span class="k">def</span> <span class="nf">sample_Qgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample-809"><a href="#ReadoutLayerQsample-809"><span class="linenos"> 809</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-810"><a href="#ReadoutLayerQsample-810"><span class="linenos"> 810</span></a><span class="sd">        Returns the chosen angle (Q) from the core by sampling from a Gaussian distribution</span>
</span><span id="ReadoutLayerQsample-811"><a href="#ReadoutLayerQsample-811"><span class="linenos"> 811</span></a><span class="sd">        More specifically, it returns sampled angle for each batch over all elements, given Qmus and Qsigmas</span>
</span><span id="ReadoutLayerQsample-812"><a href="#ReadoutLayerQsample-812"><span class="linenos"> 812</span></a><span class="sd">        Also implements wrap around for Qmus so edge mus get mapped back to first angle</span>
</span><span id="ReadoutLayerQsample-813"><a href="#ReadoutLayerQsample-813"><span class="linenos"> 813</span></a><span class="sd">        If &#39;Qsample&#39; is false, it just gives mu back (so testing has no randomness)</span>
</span><span id="ReadoutLayerQsample-814"><a href="#ReadoutLayerQsample-814"><span class="linenos"> 814</span></a><span class="sd">        This code is inherited and then modified, so different style than most other</span>
</span><span id="ReadoutLayerQsample-815"><a href="#ReadoutLayerQsample-815"><span class="linenos"> 815</span></a>
</span><span id="ReadoutLayerQsample-816"><a href="#ReadoutLayerQsample-816"><span class="linenos"> 816</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample-817"><a href="#ReadoutLayerQsample-817"><span class="linenos"> 817</span></a><span class="sd">            batch_size (int): size of the batch</span>
</span><span id="ReadoutLayerQsample-818"><a href="#ReadoutLayerQsample-818"><span class="linenos"> 818</span></a><span class="sd">            Qsample (bool/None): sample determines whether we draw a sample from Gaussian distribution, N(Qmu,Qsigma), defined per neuron</span>
</span><span id="ReadoutLayerQsample-819"><a href="#ReadoutLayerQsample-819"><span class="linenos"> 819</span></a><span class="sd">                            or use the mean, Qmu, of the Gaussian distribution without sampling.</span>
</span><span id="ReadoutLayerQsample-820"><a href="#ReadoutLayerQsample-820"><span class="linenos"> 820</span></a><span class="sd">                           if Qsample is None (default), samples from the N(Qmu,Qsigma) during training phase and</span>
</span><span id="ReadoutLayerQsample-821"><a href="#ReadoutLayerQsample-821"><span class="linenos"> 821</span></a><span class="sd">                             fixes to the mean, Qmu, during evaluation phase.</span>
</span><span id="ReadoutLayerQsample-822"><a href="#ReadoutLayerQsample-822"><span class="linenos"> 822</span></a><span class="sd">                           if Qsample is True/False, overrides the model_state (i.e training or eval) and does as instructed</span>
</span><span id="ReadoutLayerQsample-823"><a href="#ReadoutLayerQsample-823"><span class="linenos"> 823</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-824"><a href="#ReadoutLayerQsample-824"><span class="linenos"> 824</span></a>        
</span><span id="ReadoutLayerQsample-825"><a href="#ReadoutLayerQsample-825"><span class="linenos"> 825</span></a>        <span class="n">Qgrid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qgrid_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample-826"><a href="#ReadoutLayerQsample-826"><span class="linenos"> 826</span></a>                
</span><span id="ReadoutLayerQsample-827"><a href="#ReadoutLayerQsample-827"><span class="linenos"> 827</span></a>        <span class="n">Qsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">if</span> <span class="n">Qsample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Qsample</span>
</span><span id="ReadoutLayerQsample-828"><a href="#ReadoutLayerQsample-828"><span class="linenos"> 828</span></a>        <span class="k">if</span> <span class="n">Qsample</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-829"><a href="#ReadoutLayerQsample-829"><span class="linenos"> 829</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">Qgrid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="ReadoutLayerQsample-830"><a href="#ReadoutLayerQsample-830"><span class="linenos"> 830</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-831"><a href="#ReadoutLayerQsample-831"><span class="linenos"> 831</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">Qgrid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayerQsample-832"><a href="#ReadoutLayerQsample-832"><span class="linenos"> 832</span></a>
</span><span id="ReadoutLayerQsample-833"><a href="#ReadoutLayerQsample-833"><span class="linenos"> 833</span></a>        <span class="c1"># posision for sampling cells</span>
</span><span id="ReadoutLayerQsample-834"><a href="#ReadoutLayerQsample-834"><span class="linenos"> 834</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayerQsample-835"><a href="#ReadoutLayerQsample-835"><span class="linenos"> 835</span></a>        <span class="n">cell_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-836"><a href="#ReadoutLayerQsample-836"><span class="linenos"> 836</span></a>        <span class="n">cell_pos</span> <span class="o">=</span> <span class="n">cell_pos</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-837"><a href="#ReadoutLayerQsample-837"><span class="linenos"> 837</span></a>        
</span><span id="ReadoutLayerQsample-838"><a href="#ReadoutLayerQsample-838"><span class="linenos"> 838</span></a>        <span class="n">out_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">Qgrid_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayerQsample-839"><a href="#ReadoutLayerQsample-839"><span class="linenos"> 839</span></a>        <span class="c1">## SEEMS dim-4 HAS TO BE IN THE SECOND DIMENSION (RATHER THAN FIRST)</span>
</span><span id="ReadoutLayerQsample-840"><a href="#ReadoutLayerQsample-840"><span class="linenos"> 840</span></a>        <span class="n">out_norm</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_pos</span>
</span><span id="ReadoutLayerQsample-841"><a href="#ReadoutLayerQsample-841"><span class="linenos"> 841</span></a>        <span class="n">mu_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># scal mu values to account for circular padding</span>
</span><span id="ReadoutLayerQsample-842"><a href="#ReadoutLayerQsample-842"><span class="linenos"> 842</span></a>        <span class="c1">#mu_scale = 1</span>
</span><span id="ReadoutLayerQsample-843"><a href="#ReadoutLayerQsample-843"><span class="linenos"> 843</span></a>        <span class="n">out_norm</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_scale</span><span class="o">*</span><span class="p">(((</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># wraps around</span>
</span><span id="ReadoutLayerQsample-844"><a href="#ReadoutLayerQsample-844"><span class="linenos"> 844</span></a>
</span><span id="ReadoutLayerQsample-845"><a href="#ReadoutLayerQsample-845"><span class="linenos"> 845</span></a>        <span class="k">return</span> <span class="n">out_norm</span>
</span><span id="ReadoutLayerQsample-846"><a href="#ReadoutLayerQsample-846"><span class="linenos"> 846</span></a>
</span><span id="ReadoutLayerQsample-847"><a href="#ReadoutLayerQsample-847"><span class="linenos"> 847</span></a>    <span class="k">def</span> <span class="nf">fit_Qmus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Qsigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample-848"><a href="#ReadoutLayerQsample-848"><span class="linenos"> 848</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-849"><a href="#ReadoutLayerQsample-849"><span class="linenos"> 849</span></a><span class="sd">        Quick function that turns on or off fitting Qmus/Qsigmas and toggles sample</span>
</span><span id="ReadoutLayerQsample-850"><a href="#ReadoutLayerQsample-850"><span class="linenos"> 850</span></a><span class="sd">        </span>
</span><span id="ReadoutLayerQsample-851"><a href="#ReadoutLayerQsample-851"><span class="linenos"> 851</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample-852"><a href="#ReadoutLayerQsample-852"><span class="linenos"> 852</span></a><span class="sd">            val (bool): True or False -- must specify</span>
</span><span id="ReadoutLayerQsample-853"><a href="#ReadoutLayerQsample-853"><span class="linenos"> 853</span></a><span class="sd">            Qsigma (float): choose starting Qsigma value (default no choice)</span>
</span><span id="ReadoutLayerQsample-854"><a href="#ReadoutLayerQsample-854"><span class="linenos"> 854</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-855"><a href="#ReadoutLayerQsample-855"><span class="linenos"> 855</span></a>        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fit_mus(): must set val to be True or False&quot;</span>
</span><span id="ReadoutLayerQsample-856"><a href="#ReadoutLayerQsample-856"><span class="linenos"> 856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="ReadoutLayerQsample-857"><a href="#ReadoutLayerQsample-857"><span class="linenos"> 857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qmu&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-858"><a href="#ReadoutLayerQsample-858"><span class="linenos"> 858</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qsigma&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-859"><a href="#ReadoutLayerQsample-859"><span class="linenos"> 859</span></a>        <span class="k">if</span> <span class="n">Qsigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-860"><a href="#ReadoutLayerQsample-860"><span class="linenos"> 860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">Qsigma</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-861"><a href="#ReadoutLayerQsample-861"><span class="linenos"> 861</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-862"><a href="#ReadoutLayerQsample-862"><span class="linenos"> 862</span></a>            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-863"><a href="#ReadoutLayerQsample-863"><span class="linenos"> 863</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: fitting Qmus&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-864"><a href="#ReadoutLayerQsample-864"><span class="linenos"> 864</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-865"><a href="#ReadoutLayerQsample-865"><span class="linenos"> 865</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: not fitting Qmus&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-866"><a href="#ReadoutLayerQsample-866"><span class="linenos"> 866</span></a>
</span><span id="ReadoutLayerQsample-867"><a href="#ReadoutLayerQsample-867"><span class="linenos"> 867</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample-868"><a href="#ReadoutLayerQsample-868"><span class="linenos"> 868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-869"><a href="#ReadoutLayerQsample-869"><span class="linenos"> 869</span></a><span class="sd">        Propagates the input forwards through the readout</span>
</span><span id="ReadoutLayerQsample-870"><a href="#ReadoutLayerQsample-870"><span class="linenos"> 870</span></a>
</span><span id="ReadoutLayerQsample-871"><a href="#ReadoutLayerQsample-871"><span class="linenos"> 871</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample-872"><a href="#ReadoutLayerQsample-872"><span class="linenos"> 872</span></a><span class="sd">            x: input data</span>
</span><span id="ReadoutLayerQsample-873"><a href="#ReadoutLayerQsample-873"><span class="linenos"> 873</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="ReadoutLayerQsample-874"><a href="#ReadoutLayerQsample-874"><span class="linenos"> 874</span></a>
</span><span id="ReadoutLayerQsample-875"><a href="#ReadoutLayerQsample-875"><span class="linenos"> 875</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample-876"><a href="#ReadoutLayerQsample-876"><span class="linenos"> 876</span></a><span class="sd">            z: neuronal activity</span>
</span><span id="ReadoutLayerQsample-877"><a href="#ReadoutLayerQsample-877"><span class="linenos"> 877</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-878"><a href="#ReadoutLayerQsample-878"><span class="linenos"> 878</span></a>        
</span><span id="ReadoutLayerQsample-879"><a href="#ReadoutLayerQsample-879"><span class="linenos"> 879</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>  <span class="c1"># 3d change -- has extra dimension at end</span>
</span><span id="ReadoutLayerQsample-880"><a href="#ReadoutLayerQsample-880"><span class="linenos"> 880</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="ReadoutLayerQsample-881"><a href="#ReadoutLayerQsample-881"><span class="linenos"> 881</span></a>        <span class="n">c</span> <span class="o">*=</span> <span class="n">T</span>
</span><span id="ReadoutLayerQsample-882"><a href="#ReadoutLayerQsample-882"><span class="linenos"> 882</span></a>        <span class="c1"># get those last filter dims up before spatial</span>
</span><span id="ReadoutLayerQsample-883"><a href="#ReadoutLayerQsample-883"><span class="linenos"> 883</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
</span><span id="ReadoutLayerQsample-884"><a href="#ReadoutLayerQsample-884"><span class="linenos"> 884</span></a>
</span><span id="ReadoutLayerQsample-885"><a href="#ReadoutLayerQsample-885"><span class="linenos"> 885</span></a>        <span class="c1">#c_in, w_in, h_in = self.input_dims[:3]</span>
</span><span id="ReadoutLayerQsample-886"><a href="#ReadoutLayerQsample-886"><span class="linenos"> 886</span></a>        <span class="c1">#if (c_in, w_in, h_in) != (c, w, h):</span>
</span><span id="ReadoutLayerQsample-887"><a href="#ReadoutLayerQsample-887"><span class="linenos"> 887</span></a>        <span class="c1">#    raise ValueError(&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;)</span>
</span><span id="ReadoutLayerQsample-888"><a href="#ReadoutLayerQsample-888"><span class="linenos"> 888</span></a>
</span><span id="ReadoutLayerQsample-889"><a href="#ReadoutLayerQsample-889"><span class="linenos"> 889</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="c1"># this is the filter weights for each unit</span>
</span><span id="ReadoutLayerQsample-890"><a href="#ReadoutLayerQsample-890"><span class="linenos"> 890</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>  <span class="c1"># 3d change -- this is num_chan x num_angles now</span>
</span><span id="ReadoutLayerQsample-891"><a href="#ReadoutLayerQsample-891"><span class="linenos"> 891</span></a>
</span><span id="ReadoutLayerQsample-892"><a href="#ReadoutLayerQsample-892"><span class="linenos"> 892</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="ReadoutLayerQsample-893"><a href="#ReadoutLayerQsample-893"><span class="linenos"> 893</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayerQsample-894"><a href="#ReadoutLayerQsample-894"><span class="linenos"> 894</span></a>
</span><span id="ReadoutLayerQsample-895"><a href="#ReadoutLayerQsample-895"><span class="linenos"> 895</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-896"><a href="#ReadoutLayerQsample-896"><span class="linenos"> 896</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayerQsample-897"><a href="#ReadoutLayerQsample-897"><span class="linenos"> 897</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayerQsample-898"><a href="#ReadoutLayerQsample-898"><span class="linenos"> 898</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-899"><a href="#ReadoutLayerQsample-899"><span class="linenos"> 899</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayerQsample-900"><a href="#ReadoutLayerQsample-900"><span class="linenos"> 900</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-901"><a href="#ReadoutLayerQsample-901"><span class="linenos"> 901</span></a>        
</span><span id="ReadoutLayerQsample-902"><a href="#ReadoutLayerQsample-902"><span class="linenos"> 902</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-903"><a href="#ReadoutLayerQsample-903"><span class="linenos"> 903</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="ReadoutLayerQsample-904"><a href="#ReadoutLayerQsample-904"><span class="linenos"> 904</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ReadoutLayerQsample-905"><a href="#ReadoutLayerQsample-905"><span class="linenos"> 905</span></a>
</span><span id="ReadoutLayerQsample-906"><a href="#ReadoutLayerQsample-906"><span class="linenos"> 906</span></a>        <span class="c1"># Might have to do sample per cell (i.e. for loop)</span>
</span><span id="ReadoutLayerQsample-907"><a href="#ReadoutLayerQsample-907"><span class="linenos"> 907</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_Qsample</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-908"><a href="#ReadoutLayerQsample-908"><span class="linenos"> 908</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayerQsample-909"><a href="#ReadoutLayerQsample-909"><span class="linenos"> 909</span></a>            <span class="n">Qgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Qgrid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayerQsample-910"><a href="#ReadoutLayerQsample-910"><span class="linenos"> 910</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-911"><a href="#ReadoutLayerQsample-911"><span class="linenos"> 911</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayerQsample-912"><a href="#ReadoutLayerQsample-912"><span class="linenos"> 912</span></a>            <span class="n">Qgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Qgrid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-913"><a href="#ReadoutLayerQsample-913"><span class="linenos"> 913</span></a>        
</span><span id="ReadoutLayerQsample-914"><a href="#ReadoutLayerQsample-914"><span class="linenos"> 914</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-915"><a href="#ReadoutLayerQsample-915"><span class="linenos"> 915</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="ReadoutLayerQsample-916"><a href="#ReadoutLayerQsample-916"><span class="linenos"> 916</span></a>        
</span><span id="ReadoutLayerQsample-917"><a href="#ReadoutLayerQsample-917"><span class="linenos"> 917</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-918"><a href="#ReadoutLayerQsample-918"><span class="linenos"> 918</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-919"><a href="#ReadoutLayerQsample-919"><span class="linenos"> 919</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-920"><a href="#ReadoutLayerQsample-920"><span class="linenos"> 920</span></a>        <span class="n">y_pad</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;circular&#39;</span><span class="p">)</span> <span class="c1"># circular padding for angle dim)</span>
</span><span id="ReadoutLayerQsample-921"><a href="#ReadoutLayerQsample-921"><span class="linenos"> 921</span></a>        
</span><span id="ReadoutLayerQsample-922"><a href="#ReadoutLayerQsample-922"><span class="linenos"> 922</span></a>        <span class="c1"># reduce grid sample for angle</span>
</span><span id="ReadoutLayerQsample-923"><a href="#ReadoutLayerQsample-923"><span class="linenos"> 923</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">y_pad</span><span class="p">,</span> <span class="n">Qgrid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-924"><a href="#ReadoutLayerQsample-924"><span class="linenos"> 924</span></a>        
</span><span id="ReadoutLayerQsample-925"><a href="#ReadoutLayerQsample-925"><span class="linenos"> 925</span></a>        <span class="c1"># reduce grid sample for angle</span>
</span><span id="ReadoutLayerQsample-926"><a href="#ReadoutLayerQsample-926"><span class="linenos"> 926</span></a>        <span class="c1">#z = torch.zeros((N,self.input_dims[0],self.num_filters,1), dtype=torch.float32, device=self.weight.device)</span>
</span><span id="ReadoutLayerQsample-927"><a href="#ReadoutLayerQsample-927"><span class="linenos"> 927</span></a>        <span class="c1">#for i in range(self.num_filters):</span>
</span><span id="ReadoutLayerQsample-928"><a href="#ReadoutLayerQsample-928"><span class="linenos"> 928</span></a>        <span class="c1">#    y_i = y[:,:,i,:].reshape(N,self.input_dims[0],self.input_dims[3],1)</span>
</span><span id="ReadoutLayerQsample-929"><a href="#ReadoutLayerQsample-929"><span class="linenos"> 929</span></a>        <span class="c1">#    Qgrid_i = Qgrid[:,i,:,:].reshape(N,1,1,2)</span>
</span><span id="ReadoutLayerQsample-930"><a href="#ReadoutLayerQsample-930"><span class="linenos"> 930</span></a>        <span class="c1">#    z_i = F.grid_sample(y_i, Qgrid_i, mode=self.Qsample_mode, align_corners=self.align_corners, padding_mode=&#39;border&#39;)</span>
</span><span id="ReadoutLayerQsample-931"><a href="#ReadoutLayerQsample-931"><span class="linenos"> 931</span></a>        <span class="c1">#    z[:,:,i,:] = z_i.reshape(N,self.input_dims[0],1)</span>
</span><span id="ReadoutLayerQsample-932"><a href="#ReadoutLayerQsample-932"><span class="linenos"> 932</span></a>        
</span><span id="ReadoutLayerQsample-933"><a href="#ReadoutLayerQsample-933"><span class="linenos"> 933</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-934"><a href="#ReadoutLayerQsample-934"><span class="linenos"> 934</span></a>        <span class="c1">#z = (z.squeeze(-1)).sum(1).view(N, outdims) # for testing only</span>
</span><span id="ReadoutLayerQsample-935"><a href="#ReadoutLayerQsample-935"><span class="linenos"> 935</span></a>
</span><span id="ReadoutLayerQsample-936"><a href="#ReadoutLayerQsample-936"><span class="linenos"> 936</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-937"><a href="#ReadoutLayerQsample-937"><span class="linenos"> 937</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="ReadoutLayerQsample-938"><a href="#ReadoutLayerQsample-938"><span class="linenos"> 938</span></a>        
</span><span id="ReadoutLayerQsample-939"><a href="#ReadoutLayerQsample-939"><span class="linenos"> 939</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-940"><a href="#ReadoutLayerQsample-940"><span class="linenos"> 940</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-941"><a href="#ReadoutLayerQsample-941"><span class="linenos"> 941</span></a>        
</span><span id="ReadoutLayerQsample-942"><a href="#ReadoutLayerQsample-942"><span class="linenos"> 942</span></a>        <span class="k">return</span> <span class="n">z</span>
</span><span id="ReadoutLayerQsample-943"><a href="#ReadoutLayerQsample-943"><span class="linenos"> 943</span></a>    <span class="c1"># END ReadoutLayer3d.forward</span>
</span><span id="ReadoutLayerQsample-944"><a href="#ReadoutLayerQsample-944"><span class="linenos"> 944</span></a>
</span><span id="ReadoutLayerQsample-945"><a href="#ReadoutLayerQsample-945"><span class="linenos"> 945</span></a>    <span class="k">def</span> <span class="nf">degrees2mu</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">theta_deg</span><span class="p">,</span> <span class="n">to_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample-946"><a href="#ReadoutLayerQsample-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-947"><a href="#ReadoutLayerQsample-947"><span class="linenos"> 947</span></a><span class="sd">        Converts degrees into mu-values. If to_output=True, outputs to an array, and otherwise</span>
</span><span id="ReadoutLayerQsample-948"><a href="#ReadoutLayerQsample-948"><span class="linenos"> 948</span></a><span class="sd">        stores in the Qmu variable. It detects whether half-circle of full circle using stored angle values</span>
</span><span id="ReadoutLayerQsample-949"><a href="#ReadoutLayerQsample-949"><span class="linenos"> 949</span></a><span class="sd">        </span>
</span><span id="ReadoutLayerQsample-950"><a href="#ReadoutLayerQsample-950"><span class="linenos"> 950</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample-951"><a href="#ReadoutLayerQsample-951"><span class="linenos"> 951</span></a><span class="sd">            theta_deg (np array): array of angles in degrees into mu values, based on 180 or 360 deg wrap-around</span>
</span><span id="ReadoutLayerQsample-952"><a href="#ReadoutLayerQsample-952"><span class="linenos"> 952</span></a><span class="sd">            to_output (Boolean): whether to output to variable or store internally as Qmu (default: False, is the latter)</span>
</span><span id="ReadoutLayerQsample-953"><a href="#ReadoutLayerQsample-953"><span class="linenos"> 953</span></a><span class="sd">            continuous (Boolean): whether to convert to continuous angle or closest &quot;integer&quot; mu value (def True, continuous)</span>
</span><span id="ReadoutLayerQsample-954"><a href="#ReadoutLayerQsample-954"><span class="linenos"> 954</span></a><span class="sd">            max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</span>
</span><span id="ReadoutLayerQsample-955"><a href="#ReadoutLayerQsample-955"><span class="linenos"> 955</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample-956"><a href="#ReadoutLayerQsample-956"><span class="linenos"> 956</span></a><span class="sd">            Qmus: as numpy-array, if to_output is set to True, otherwise, nothing </span>
</span><span id="ReadoutLayerQsample-957"><a href="#ReadoutLayerQsample-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-958"><a href="#ReadoutLayerQsample-958"><span class="linenos"> 958</span></a>        <span class="n">num_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample-959"><a href="#ReadoutLayerQsample-959"><span class="linenos"> 959</span></a>
</span><span id="ReadoutLayerQsample-960"><a href="#ReadoutLayerQsample-960"><span class="linenos"> 960</span></a>        <span class="c1"># convert inputs to np.array</span>
</span><span id="ReadoutLayerQsample-961"><a href="#ReadoutLayerQsample-961"><span class="linenos"> 961</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theta_deg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample-962"><a href="#ReadoutLayerQsample-962"><span class="linenos"> 962</span></a>            <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta_deg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-963"><a href="#ReadoutLayerQsample-963"><span class="linenos"> 963</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">continuous</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-964"><a href="#ReadoutLayerQsample-964"><span class="linenos"> 964</span></a>            <span class="n">dQ</span> <span class="o">=</span> <span class="n">max_angle</span><span class="o">/</span><span class="n">num_angles</span>
</span><span id="ReadoutLayerQsample-965"><a href="#ReadoutLayerQsample-965"><span class="linenos"> 965</span></a>            <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">dQ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">theta_deg</span><span class="o">/</span><span class="n">dQ</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-966"><a href="#ReadoutLayerQsample-966"><span class="linenos"> 966</span></a>        <span class="n">theta_deg</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_deg</span><span class="o">%</span><span class="n">max_angle</span><span class="p">)</span>  <span class="c1"># map between 0 and max_angle</span>
</span><span id="ReadoutLayerQsample-967"><a href="#ReadoutLayerQsample-967"><span class="linenos"> 967</span></a>
</span><span id="ReadoutLayerQsample-968"><a href="#ReadoutLayerQsample-968"><span class="linenos"> 968</span></a>        <span class="n">mu_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_angles</span> <span class="c1"># first bin at 0 degrees is actually a shifted mu value (not right at edge)</span>
</span><span id="ReadoutLayerQsample-969"><a href="#ReadoutLayerQsample-969"><span class="linenos"> 969</span></a>        <span class="n">Qmus</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_deg</span><span class="o">-</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">mu_offset</span>
</span><span id="ReadoutLayerQsample-970"><a href="#ReadoutLayerQsample-970"><span class="linenos"> 970</span></a>        <span class="n">Qmus</span><span class="p">[</span><span class="n">Qmus</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="ReadoutLayerQsample-971"><a href="#ReadoutLayerQsample-971"><span class="linenos"> 971</span></a>        <span class="n">Qmus</span><span class="p">[</span><span class="n">Qmus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span>
</span><span id="ReadoutLayerQsample-972"><a href="#ReadoutLayerQsample-972"><span class="linenos"> 972</span></a>        <span class="k">if</span> <span class="n">to_output</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-973"><a href="#ReadoutLayerQsample-973"><span class="linenos"> 973</span></a>            <span class="k">return</span> <span class="n">Qmus</span>
</span><span id="ReadoutLayerQsample-974"><a href="#ReadoutLayerQsample-974"><span class="linenos"> 974</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Qmus</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;incorrect number of angles input </span><span class="si">%d</span><span class="s2"> neq </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qmus</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ReadoutLayerQsample-975"><a href="#ReadoutLayerQsample-975"><span class="linenos"> 975</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">Qmus</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ReadoutLayerQsample-976"><a href="#ReadoutLayerQsample-976"><span class="linenos"> 976</span></a>    <span class="c1"># END ReadoutLayerQsample.degrees2mu()</span>
</span><span id="ReadoutLayerQsample-977"><a href="#ReadoutLayerQsample-977"><span class="linenos"> 977</span></a>
</span><span id="ReadoutLayerQsample-978"><a href="#ReadoutLayerQsample-978"><span class="linenos"> 978</span></a>    <span class="k">def</span> <span class="nf">mu2degrees</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample-979"><a href="#ReadoutLayerQsample-979"><span class="linenos"> 979</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-980"><a href="#ReadoutLayerQsample-980"><span class="linenos"> 980</span></a><span class="sd">        Converts Qmu-values into degrees. Automatically reads from Qmu variable, and outputs a numpy array</span>
</span><span id="ReadoutLayerQsample-981"><a href="#ReadoutLayerQsample-981"><span class="linenos"> 981</span></a><span class="sd">        It detects whether half-circle of full circle using stored angle values</span>
</span><span id="ReadoutLayerQsample-982"><a href="#ReadoutLayerQsample-982"><span class="linenos"> 982</span></a><span class="sd">        </span>
</span><span id="ReadoutLayerQsample-983"><a href="#ReadoutLayerQsample-983"><span class="linenos"> 983</span></a><span class="sd">        Args:     </span>
</span><span id="ReadoutLayerQsample-984"><a href="#ReadoutLayerQsample-984"><span class="linenos"> 984</span></a><span class="sd">            Qmus: if dont want to read from layer, pass in values directly (default None, using self.Qmu)       </span>
</span><span id="ReadoutLayerQsample-985"><a href="#ReadoutLayerQsample-985"><span class="linenos"> 985</span></a><span class="sd">            max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</span>
</span><span id="ReadoutLayerQsample-986"><a href="#ReadoutLayerQsample-986"><span class="linenos"> 986</span></a>
</span><span id="ReadoutLayerQsample-987"><a href="#ReadoutLayerQsample-987"><span class="linenos"> 987</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample-988"><a href="#ReadoutLayerQsample-988"><span class="linenos"> 988</span></a><span class="sd">            thetas: angles in degrees (between 0 to max_angle)</span>
</span><span id="ReadoutLayerQsample-989"><a href="#ReadoutLayerQsample-989"><span class="linenos"> 989</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-990"><a href="#ReadoutLayerQsample-990"><span class="linenos"> 990</span></a>        <span class="n">num_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample-991"><a href="#ReadoutLayerQsample-991"><span class="linenos"> 991</span></a>        <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample-992"><a href="#ReadoutLayerQsample-992"><span class="linenos"> 992</span></a>            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
</span><span id="ReadoutLayerQsample-993"><a href="#ReadoutLayerQsample-993"><span class="linenos"> 993</span></a>
</span><span id="ReadoutLayerQsample-994"><a href="#ReadoutLayerQsample-994"><span class="linenos"> 994</span></a>        <span class="n">mu</span> <span class="o">+=</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_angles</span> <span class="c1"># first bin at 0 degrees is actually a shifted mu value (not right at edge)</span>
</span><span id="ReadoutLayerQsample-995"><a href="#ReadoutLayerQsample-995"><span class="linenos"> 995</span></a>        <span class="n">thetas</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span>
</span><span id="ReadoutLayerQsample-996"><a href="#ReadoutLayerQsample-996"><span class="linenos"> 996</span></a>        <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span> <span class="o">%</span> <span class="n">max_angle</span> 
</span><span id="ReadoutLayerQsample-997"><a href="#ReadoutLayerQsample-997"><span class="linenos"> 997</span></a>        <span class="k">return</span> <span class="n">thetas</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="ReadoutLayerQsample-998"><a href="#ReadoutLayerQsample-998"><span class="linenos"> 998</span></a>    <span class="c1"># END ReadoutLayerQsample.mu2degrees()</span>
</span><span id="ReadoutLayerQsample-999"><a href="#ReadoutLayerQsample-999"><span class="linenos"> 999</span></a>
</span><span id="ReadoutLayerQsample-1000"><a href="#ReadoutLayerQsample-1000"><span class="linenos">1000</span></a>    <span class="k">def</span> <span class="nf">_layer_abbrev</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample-1001"><a href="#ReadoutLayerQsample-1001"><span class="linenos">1001</span></a>        <span class="k">return</span> <span class="s2">&quot;readQsmp&quot;</span>
</span><span id="ReadoutLayerQsample-1002"><a href="#ReadoutLayerQsample-1002"><span class="linenos">1002</span></a>
</span><span id="ReadoutLayerQsample-1003"><a href="#ReadoutLayerQsample-1003"><span class="linenos">1003</span></a>    <span class="nd">@classmethod</span>
</span><span id="ReadoutLayerQsample-1004"><a href="#ReadoutLayerQsample-1004"><span class="linenos">1004</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Qsigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample-1005"><a href="#ReadoutLayerQsample-1005"><span class="linenos">1005</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-1006"><a href="#ReadoutLayerQsample-1006"><span class="linenos">1006</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="ReadoutLayerQsample-1007"><a href="#ReadoutLayerQsample-1007"><span class="linenos">1007</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="ReadoutLayerQsample-1008"><a href="#ReadoutLayerQsample-1008"><span class="linenos">1008</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="ReadoutLayerQsample-1009"><a href="#ReadoutLayerQsample-1009"><span class="linenos">1009</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="ReadoutLayerQsample-1010"><a href="#ReadoutLayerQsample-1010"><span class="linenos">1010</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="ReadoutLayerQsample-1011"><a href="#ReadoutLayerQsample-1011"><span class="linenos">1011</span></a>
</span><span id="ReadoutLayerQsample-1012"><a href="#ReadoutLayerQsample-1012"><span class="linenos">1012</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample-1013"><a href="#ReadoutLayerQsample-1013"><span class="linenos">1013</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayerQsample-1014"><a href="#ReadoutLayerQsample-1014"><span class="linenos">1014</span></a>
</span><span id="ReadoutLayerQsample-1015"><a href="#ReadoutLayerQsample-1015"><span class="linenos">1015</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample-1016"><a href="#ReadoutLayerQsample-1016"><span class="linenos">1016</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="ReadoutLayerQsample-1017"><a href="#ReadoutLayerQsample-1017"><span class="linenos">1017</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample-1018"><a href="#ReadoutLayerQsample-1018"><span class="linenos">1018</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample-1019"><a href="#ReadoutLayerQsample-1019"><span class="linenos">1019</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readoutQ&#39;</span>
</span><span id="ReadoutLayerQsample-1020"><a href="#ReadoutLayerQsample-1020"><span class="linenos">1020</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_Qample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ReadoutLayerQsample-1021"><a href="#ReadoutLayerQsample-1021"><span class="linenos">1021</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_Qsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="ReadoutLayerQsample-1022"><a href="#ReadoutLayerQsample-1022"><span class="linenos">1022</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;Qsample_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
</span><span id="ReadoutLayerQsample-1023"><a href="#ReadoutLayerQsample-1023"><span class="linenos">1023</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span><span id="ReadoutLayerQsample-1024"><a href="#ReadoutLayerQsample-1024"><span class="linenos">1024</span></a>    <span class="c1"># END [classmethod] ReadoutLayer3d.layer_dict</span>
</span></pre></div>


            <div class="docstring"><p>ReadoutLayerQsample for 3d readout with sampling over angle dimension Q.
This is a subclass of ReadoutLayer3d.</p>
</div>


                            <div id="ReadoutLayerQsample.__init__" class="classattr">
                                        <input id="ReadoutLayerQsample.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ReadoutLayerQsample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">batch_Qsample</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">init_Qsigma</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">Qsample_mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ReadoutLayerQsample.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.__init__-761"><a href="#ReadoutLayerQsample.__init__-761"><span class="linenos">761</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_Qsample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_Qsigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Qsample_mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample.__init__-762"><a href="#ReadoutLayerQsample.__init__-762"><span class="linenos">762</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.__init__-763"><a href="#ReadoutLayerQsample.__init__-763"><span class="linenos">763</span></a><span class="sd">        ReadoutLayerQsample: 3d readout layer for NDNs.</span>
</span><span id="ReadoutLayerQsample.__init__-764"><a href="#ReadoutLayerQsample.__init__-764"><span class="linenos">764</span></a>
</span><span id="ReadoutLayerQsample.__init__-765"><a href="#ReadoutLayerQsample.__init__-765"><span class="linenos">765</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample.__init__-766"><a href="#ReadoutLayerQsample.__init__-766"><span class="linenos">766</span></a><span class="sd">            input_dims: tuple or list of ints, (num_channels, height, width, lags)</span>
</span><span id="ReadoutLayerQsample.__init__-767"><a href="#ReadoutLayerQsample.__init__-767"><span class="linenos">767</span></a><span class="sd">            filter_dims: tuple or list of ints, (num_channels, height, width, depth, lags)</span>
</span><span id="ReadoutLayerQsample.__init__-768"><a href="#ReadoutLayerQsample.__init__-768"><span class="linenos">768</span></a><span class="sd">            batch_Qample: bool, whether to sample Qgrid locations separately per sample per batch</span>
</span><span id="ReadoutLayerQsample.__init__-769"><a href="#ReadoutLayerQsample.__init__-769"><span class="linenos">769</span></a><span class="sd">            init_sigma: float, standard deviation for uniform initialization of sigmas</span>
</span><span id="ReadoutLayerQsample.__init__-770"><a href="#ReadoutLayerQsample.__init__-770"><span class="linenos">770</span></a><span class="sd">            Qsample_mode: str, &#39;bilinear&#39; or &#39;nearest&#39;</span>
</span><span id="ReadoutLayerQsample.__init__-771"><a href="#ReadoutLayerQsample.__init__-771"><span class="linenos">771</span></a>
</span><span id="ReadoutLayerQsample.__init__-772"><a href="#ReadoutLayerQsample.__init__-772"><span class="linenos">772</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.__init__-773"><a href="#ReadoutLayerQsample.__init__-773"><span class="linenos">773</span></a>
</span><span id="ReadoutLayerQsample.__init__-774"><a href="#ReadoutLayerQsample.__init__-774"><span class="linenos">774</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ReadoutLayer: Must specify input_dims&quot;</span>
</span><span id="ReadoutLayerQsample.__init__-775"><a href="#ReadoutLayerQsample.__init__-775"><span class="linenos">775</span></a>
</span><span id="ReadoutLayerQsample.__init__-776"><a href="#ReadoutLayerQsample.__init__-776"><span class="linenos">776</span></a>        <span class="c1"># Make sure filter_dims is filled in, and to single the spatial filter dimensions</span>
</span><span id="ReadoutLayerQsample.__init__-777"><a href="#ReadoutLayerQsample.__init__-777"><span class="linenos">777</span></a>        <span class="k">if</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.__init__-778"><a href="#ReadoutLayerQsample.__init__-778"><span class="linenos">778</span></a>            <span class="n">filter_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.__init__-779"><a href="#ReadoutLayerQsample.__init__-779"><span class="linenos">779</span></a>        
</span><span id="ReadoutLayerQsample.__init__-780"><a href="#ReadoutLayerQsample.__init__-780"><span class="linenos">780</span></a>        <span class="n">filter_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample.__init__-781"><a href="#ReadoutLayerQsample.__init__-781"><span class="linenos">781</span></a>        
</span><span id="ReadoutLayerQsample.__init__-782"><a href="#ReadoutLayerQsample.__init__-782"><span class="linenos">782</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cant handle temporal filter dims here, yet.&#39;</span>
</span><span id="ReadoutLayerQsample.__init__-783"><a href="#ReadoutLayerQsample.__init__-783"><span class="linenos">783</span></a>        
</span><span id="ReadoutLayerQsample.__init__-784"><a href="#ReadoutLayerQsample.__init__-784"><span class="linenos">784</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span>
</span><span id="ReadoutLayerQsample.__init__-785"><a href="#ReadoutLayerQsample.__init__-785"><span class="linenos">785</span></a>            <span class="n">filter_dims</span><span class="o">=</span><span class="n">filter_dims</span><span class="p">,</span>
</span><span id="ReadoutLayerQsample.__init__-786"><a href="#ReadoutLayerQsample.__init__-786"><span class="linenos">786</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.__init__-787"><a href="#ReadoutLayerQsample.__init__-787"><span class="linenos">787</span></a>    
</span><span id="ReadoutLayerQsample.__init__-788"><a href="#ReadoutLayerQsample.__init__-788"><span class="linenos">788</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filter_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ReadoutLayerQsample.__init__-789"><a href="#ReadoutLayerQsample.__init__-789"><span class="linenos">789</span></a>
</span><span id="ReadoutLayerQsample.__init__-790"><a href="#ReadoutLayerQsample.__init__-790"><span class="linenos">790</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_Qsample</span> <span class="o">=</span> <span class="n">batch_Qsample</span>
</span><span id="ReadoutLayerQsample.__init__-791"><a href="#ReadoutLayerQsample.__init__-791"><span class="linenos">791</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample_mode</span> <span class="o">=</span> <span class="n">Qsample_mode</span>
</span><span id="ReadoutLayerQsample.__init__-792"><a href="#ReadoutLayerQsample.__init__-792"><span class="linenos">792</span></a>
</span><span id="ReadoutLayerQsample.__init__-793"><a href="#ReadoutLayerQsample.__init__-793"><span class="linenos">793</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span> <span class="o">=</span> <span class="n">init_Qsigma</span>
</span><span id="ReadoutLayerQsample.__init__-794"><a href="#ReadoutLayerQsample.__init__-794"><span class="linenos">794</span></a>
</span><span id="ReadoutLayerQsample.__init__-795"><a href="#ReadoutLayerQsample.__init__-795"><span class="linenos">795</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.__init__-796"><a href="#ReadoutLayerQsample.__init__-796"><span class="linenos">796</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;init_Qsigma is non-positive&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.__init__-797"><a href="#ReadoutLayerQsample.__init__-797"><span class="linenos">797</span></a>
</span><span id="ReadoutLayerQsample.__init__-798"><a href="#ReadoutLayerQsample.__init__-798"><span class="linenos">798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qgrid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.__init__-799"><a href="#ReadoutLayerQsample.__init__-799"><span class="linenos">799</span></a>
</span><span id="ReadoutLayerQsample.__init__-800"><a href="#ReadoutLayerQsample.__init__-800"><span class="linenos">800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="ReadoutLayerQsample.__init__-801"><a href="#ReadoutLayerQsample.__init__-801"><span class="linenos">801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span><span id="ReadoutLayerQsample.__init__-802"><a href="#ReadoutLayerQsample.__init__-802"><span class="linenos">802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.__init__-803"><a href="#ReadoutLayerQsample.__init__-803"><span class="linenos">803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_Qsigma</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.__init__-804"><a href="#ReadoutLayerQsample.__init__-804"><span class="linenos">804</span></a>        
</span><span id="ReadoutLayerQsample.__init__-805"><a href="#ReadoutLayerQsample.__init__-805"><span class="linenos">805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>ReadoutLayerQsample: 3d readout layer for NDNs.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>input_dims:</strong>  tuple or list of ints, (num_channels, height, width, lags)</li>
<li><strong>filter_dims:</strong>  tuple or list of ints, (num_channels, height, width, depth, lags)</li>
<li><strong>batch_Qample:</strong>  bool, whether to sample Qgrid locations separately per sample per batch</li>
<li><strong>init_sigma:</strong>  float, standard deviation for uniform initialization of sigmas</li>
<li><strong>Qsample_mode:</strong>  str, 'bilinear' or 'nearest'</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayerQsample.batch_Qsample" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_Qsample</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.batch_Qsample"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.Qsample_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">Qsample_mode</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.Qsample_mode"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.init_Qsigma" class="classattr">
                                <div class="attr variable">
            <span class="name">init_Qsigma</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.init_Qsigma"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.Qgrid_shape" class="classattr">
                                <div class="attr variable">
            <span class="name">Qgrid_shape</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.Qgrid_shape"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.Qmu" class="classattr">
                                <div class="attr variable">
            <span class="name">Qmu</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.Qmu"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.Qsigma" class="classattr">
                                <div class="attr variable">
            <span class="name">Qsigma</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.Qsigma"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.Qsample" class="classattr">
                                <div class="attr variable">
            <span class="name">Qsample</span>

        
    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.Qsample"></a>
    
    

                            </div>
                            <div id="ReadoutLayerQsample.sample_Qgrid" class="classattr">
                                        <input id="ReadoutLayerQsample.sample_Qgrid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_Qgrid</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch_size</span>, </span><span class="param"><span class="n">Qsample</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayerQsample.sample_Qgrid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.sample_Qgrid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.sample_Qgrid-808"><a href="#ReadoutLayerQsample.sample_Qgrid-808"><span class="linenos">808</span></a>    <span class="k">def</span> <span class="nf">sample_Qgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-809"><a href="#ReadoutLayerQsample.sample_Qgrid-809"><span class="linenos">809</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-810"><a href="#ReadoutLayerQsample.sample_Qgrid-810"><span class="linenos">810</span></a><span class="sd">        Returns the chosen angle (Q) from the core by sampling from a Gaussian distribution</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-811"><a href="#ReadoutLayerQsample.sample_Qgrid-811"><span class="linenos">811</span></a><span class="sd">        More specifically, it returns sampled angle for each batch over all elements, given Qmus and Qsigmas</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-812"><a href="#ReadoutLayerQsample.sample_Qgrid-812"><span class="linenos">812</span></a><span class="sd">        Also implements wrap around for Qmus so edge mus get mapped back to first angle</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-813"><a href="#ReadoutLayerQsample.sample_Qgrid-813"><span class="linenos">813</span></a><span class="sd">        If &#39;Qsample&#39; is false, it just gives mu back (so testing has no randomness)</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-814"><a href="#ReadoutLayerQsample.sample_Qgrid-814"><span class="linenos">814</span></a><span class="sd">        This code is inherited and then modified, so different style than most other</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-815"><a href="#ReadoutLayerQsample.sample_Qgrid-815"><span class="linenos">815</span></a>
</span><span id="ReadoutLayerQsample.sample_Qgrid-816"><a href="#ReadoutLayerQsample.sample_Qgrid-816"><span class="linenos">816</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-817"><a href="#ReadoutLayerQsample.sample_Qgrid-817"><span class="linenos">817</span></a><span class="sd">            batch_size (int): size of the batch</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-818"><a href="#ReadoutLayerQsample.sample_Qgrid-818"><span class="linenos">818</span></a><span class="sd">            Qsample (bool/None): sample determines whether we draw a sample from Gaussian distribution, N(Qmu,Qsigma), defined per neuron</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-819"><a href="#ReadoutLayerQsample.sample_Qgrid-819"><span class="linenos">819</span></a><span class="sd">                            or use the mean, Qmu, of the Gaussian distribution without sampling.</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-820"><a href="#ReadoutLayerQsample.sample_Qgrid-820"><span class="linenos">820</span></a><span class="sd">                           if Qsample is None (default), samples from the N(Qmu,Qsigma) during training phase and</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-821"><a href="#ReadoutLayerQsample.sample_Qgrid-821"><span class="linenos">821</span></a><span class="sd">                             fixes to the mean, Qmu, during evaluation phase.</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-822"><a href="#ReadoutLayerQsample.sample_Qgrid-822"><span class="linenos">822</span></a><span class="sd">                           if Qsample is True/False, overrides the model_state (i.e training or eval) and does as instructed</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-823"><a href="#ReadoutLayerQsample.sample_Qgrid-823"><span class="linenos">823</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-824"><a href="#ReadoutLayerQsample.sample_Qgrid-824"><span class="linenos">824</span></a>        
</span><span id="ReadoutLayerQsample.sample_Qgrid-825"><a href="#ReadoutLayerQsample.sample_Qgrid-825"><span class="linenos">825</span></a>        <span class="n">Qgrid_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qgrid_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-826"><a href="#ReadoutLayerQsample.sample_Qgrid-826"><span class="linenos">826</span></a>                
</span><span id="ReadoutLayerQsample.sample_Qgrid-827"><a href="#ReadoutLayerQsample.sample_Qgrid-827"><span class="linenos">827</span></a>        <span class="n">Qsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">if</span> <span class="n">Qsample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Qsample</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-828"><a href="#ReadoutLayerQsample.sample_Qgrid-828"><span class="linenos">828</span></a>        <span class="k">if</span> <span class="n">Qsample</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-829"><a href="#ReadoutLayerQsample.sample_Qgrid-829"><span class="linenos">829</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">Qgrid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">normal_</span><span class="p">()</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-830"><a href="#ReadoutLayerQsample.sample_Qgrid-830"><span class="linenos">830</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-831"><a href="#ReadoutLayerQsample.sample_Qgrid-831"><span class="linenos">831</span></a>            <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">Qgrid_shape</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-832"><a href="#ReadoutLayerQsample.sample_Qgrid-832"><span class="linenos">832</span></a>
</span><span id="ReadoutLayerQsample.sample_Qgrid-833"><a href="#ReadoutLayerQsample.sample_Qgrid-833"><span class="linenos">833</span></a>        <span class="c1"># posision for sampling cells</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-834"><a href="#ReadoutLayerQsample.sample_Qgrid-834"><span class="linenos">834</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-835"><a href="#ReadoutLayerQsample.sample_Qgrid-835"><span class="linenos">835</span></a>        <span class="n">cell_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-836"><a href="#ReadoutLayerQsample.sample_Qgrid-836"><span class="linenos">836</span></a>        <span class="n">cell_pos</span> <span class="o">=</span> <span class="n">cell_pos</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-837"><a href="#ReadoutLayerQsample.sample_Qgrid-837"><span class="linenos">837</span></a>        
</span><span id="ReadoutLayerQsample.sample_Qgrid-838"><a href="#ReadoutLayerQsample.sample_Qgrid-838"><span class="linenos">838</span></a>        <span class="n">out_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">Qgrid_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>  <span class="c1"># for consistency and CUDA capability</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-839"><a href="#ReadoutLayerQsample.sample_Qgrid-839"><span class="linenos">839</span></a>        <span class="c1">## SEEMS dim-4 HAS TO BE IN THE SECOND DIMENSION (RATHER THAN FIRST)</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-840"><a href="#ReadoutLayerQsample.sample_Qgrid-840"><span class="linenos">840</span></a>        <span class="n">out_norm</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_pos</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-841"><a href="#ReadoutLayerQsample.sample_Qgrid-841"><span class="linenos">841</span></a>        <span class="n">mu_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># scal mu values to account for circular padding</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-842"><a href="#ReadoutLayerQsample.sample_Qgrid-842"><span class="linenos">842</span></a>        <span class="c1">#mu_scale = 1</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-843"><a href="#ReadoutLayerQsample.sample_Qgrid-843"><span class="linenos">843</span></a>        <span class="n">out_norm</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_scale</span><span class="o">*</span><span class="p">(((</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># wraps around</span>
</span><span id="ReadoutLayerQsample.sample_Qgrid-844"><a href="#ReadoutLayerQsample.sample_Qgrid-844"><span class="linenos">844</span></a>
</span><span id="ReadoutLayerQsample.sample_Qgrid-845"><a href="#ReadoutLayerQsample.sample_Qgrid-845"><span class="linenos">845</span></a>        <span class="k">return</span> <span class="n">out_norm</span>
</span></pre></div>


            <div class="docstring"><p>Returns the chosen angle (Q) from the core by sampling from a Gaussian distribution
More specifically, it returns sampled angle for each batch over all elements, given Qmus and Qsigmas
Also implements wrap around for Qmus so edge mus get mapped back to first angle
If 'Qsample' is false, it just gives mu back (so testing has no randomness)
This code is inherited and then modified, so different style than most other</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>batch_size (int):</strong>  size of the batch</li>
<li><strong>Qsample (bool/None):</strong>  sample determines whether we draw a sample from Gaussian distribution, N(Qmu,Qsigma), defined per neuron
 or use the mean, Qmu, of the Gaussian distribution without sampling.
if Qsample is None (default), samples from the N(Qmu,Qsigma) during training phase and
  fixes to the mean, Qmu, during evaluation phase.
if Qsample is True/False, overrides the model_state (i.e training or eval) and does as instructed</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayerQsample.fit_Qmus" class="classattr">
                                        <input id="ReadoutLayerQsample.fit_Qmus-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_Qmus</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">Qsigma</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayerQsample.fit_Qmus-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.fit_Qmus"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.fit_Qmus-847"><a href="#ReadoutLayerQsample.fit_Qmus-847"><span class="linenos">847</span></a>    <span class="k">def</span> <span class="nf">fit_Qmus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Qsigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-848"><a href="#ReadoutLayerQsample.fit_Qmus-848"><span class="linenos">848</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-849"><a href="#ReadoutLayerQsample.fit_Qmus-849"><span class="linenos">849</span></a><span class="sd">        Quick function that turns on or off fitting Qmus/Qsigmas and toggles sample</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-850"><a href="#ReadoutLayerQsample.fit_Qmus-850"><span class="linenos">850</span></a><span class="sd">        </span>
</span><span id="ReadoutLayerQsample.fit_Qmus-851"><a href="#ReadoutLayerQsample.fit_Qmus-851"><span class="linenos">851</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-852"><a href="#ReadoutLayerQsample.fit_Qmus-852"><span class="linenos">852</span></a><span class="sd">            val (bool): True or False -- must specify</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-853"><a href="#ReadoutLayerQsample.fit_Qmus-853"><span class="linenos">853</span></a><span class="sd">            Qsigma (float): choose starting Qsigma value (default no choice)</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-854"><a href="#ReadoutLayerQsample.fit_Qmus-854"><span class="linenos">854</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-855"><a href="#ReadoutLayerQsample.fit_Qmus-855"><span class="linenos">855</span></a>        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;fit_mus(): must set val to be True or False&quot;</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-856"><a href="#ReadoutLayerQsample.fit_Qmus-856"><span class="linenos">856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-857"><a href="#ReadoutLayerQsample.fit_Qmus-857"><span class="linenos">857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qmu&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-858"><a href="#ReadoutLayerQsample.fit_Qmus-858"><span class="linenos">858</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Qsigma&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-859"><a href="#ReadoutLayerQsample.fit_Qmus-859"><span class="linenos">859</span></a>        <span class="k">if</span> <span class="n">Qsigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-860"><a href="#ReadoutLayerQsample.fit_Qmus-860"><span class="linenos">860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Qsigma</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">Qsigma</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-861"><a href="#ReadoutLayerQsample.fit_Qmus-861"><span class="linenos">861</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-862"><a href="#ReadoutLayerQsample.fit_Qmus-862"><span class="linenos">862</span></a>            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-863"><a href="#ReadoutLayerQsample.fit_Qmus-863"><span class="linenos">863</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: fitting Qmus&quot;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-864"><a href="#ReadoutLayerQsample.fit_Qmus-864"><span class="linenos">864</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.fit_Qmus-865"><a href="#ReadoutLayerQsample.fit_Qmus-865"><span class="linenos">865</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ReadoutLayer: not fitting Qmus&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Quick function that turns on or off fitting Qmus/Qsigmas and toggles sample</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>val (bool):</strong>  True or False -- must specify</li>
<li><strong>Qsigma (float):</strong>  choose starting Qsigma value (default no choice)</li>
</ul>
</div>


                            </div>
                            <div id="ReadoutLayerQsample.forward" class="classattr">
                                        <input id="ReadoutLayerQsample.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">shift</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayerQsample.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.forward-867"><a href="#ReadoutLayerQsample.forward-867"><span class="linenos">867</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample.forward-868"><a href="#ReadoutLayerQsample.forward-868"><span class="linenos">868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.forward-869"><a href="#ReadoutLayerQsample.forward-869"><span class="linenos">869</span></a><span class="sd">        Propagates the input forwards through the readout</span>
</span><span id="ReadoutLayerQsample.forward-870"><a href="#ReadoutLayerQsample.forward-870"><span class="linenos">870</span></a>
</span><span id="ReadoutLayerQsample.forward-871"><a href="#ReadoutLayerQsample.forward-871"><span class="linenos">871</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample.forward-872"><a href="#ReadoutLayerQsample.forward-872"><span class="linenos">872</span></a><span class="sd">            x: input data</span>
</span><span id="ReadoutLayerQsample.forward-873"><a href="#ReadoutLayerQsample.forward-873"><span class="linenos">873</span></a><span class="sd">            shift (bool): shifts the location of the grid (from eye-tracking data)</span>
</span><span id="ReadoutLayerQsample.forward-874"><a href="#ReadoutLayerQsample.forward-874"><span class="linenos">874</span></a>
</span><span id="ReadoutLayerQsample.forward-875"><a href="#ReadoutLayerQsample.forward-875"><span class="linenos">875</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample.forward-876"><a href="#ReadoutLayerQsample.forward-876"><span class="linenos">876</span></a><span class="sd">            z: neuronal activity</span>
</span><span id="ReadoutLayerQsample.forward-877"><a href="#ReadoutLayerQsample.forward-877"><span class="linenos">877</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.forward-878"><a href="#ReadoutLayerQsample.forward-878"><span class="linenos">878</span></a>        
</span><span id="ReadoutLayerQsample.forward-879"><a href="#ReadoutLayerQsample.forward-879"><span class="linenos">879</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>  <span class="c1"># 3d change -- has extra dimension at end</span>
</span><span id="ReadoutLayerQsample.forward-880"><a href="#ReadoutLayerQsample.forward-880"><span class="linenos">880</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>   <span class="c1"># N is number of time points -- note that its full dimensional....</span>
</span><span id="ReadoutLayerQsample.forward-881"><a href="#ReadoutLayerQsample.forward-881"><span class="linenos">881</span></a>        <span class="n">c</span> <span class="o">*=</span> <span class="n">T</span>
</span><span id="ReadoutLayerQsample.forward-882"><a href="#ReadoutLayerQsample.forward-882"><span class="linenos">882</span></a>        <span class="c1"># get those last filter dims up before spatial</span>
</span><span id="ReadoutLayerQsample.forward-883"><a href="#ReadoutLayerQsample.forward-883"><span class="linenos">883</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
</span><span id="ReadoutLayerQsample.forward-884"><a href="#ReadoutLayerQsample.forward-884"><span class="linenos">884</span></a>
</span><span id="ReadoutLayerQsample.forward-885"><a href="#ReadoutLayerQsample.forward-885"><span class="linenos">885</span></a>        <span class="c1">#c_in, w_in, h_in = self.input_dims[:3]</span>
</span><span id="ReadoutLayerQsample.forward-886"><a href="#ReadoutLayerQsample.forward-886"><span class="linenos">886</span></a>        <span class="c1">#if (c_in, w_in, h_in) != (c, w, h):</span>
</span><span id="ReadoutLayerQsample.forward-887"><a href="#ReadoutLayerQsample.forward-887"><span class="linenos">887</span></a>        <span class="c1">#    raise ValueError(&quot;the specified feature map dimension is not the readout&#39;s expected input dimension&quot;)</span>
</span><span id="ReadoutLayerQsample.forward-888"><a href="#ReadoutLayerQsample.forward-888"><span class="linenos">888</span></a>
</span><span id="ReadoutLayerQsample.forward-889"><a href="#ReadoutLayerQsample.forward-889"><span class="linenos">889</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="c1"># this is the filter weights for each unit</span>
</span><span id="ReadoutLayerQsample.forward-890"><a href="#ReadoutLayerQsample.forward-890"><span class="linenos">890</span></a>        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>  <span class="c1"># 3d change -- this is num_chan x num_angles now</span>
</span><span id="ReadoutLayerQsample.forward-891"><a href="#ReadoutLayerQsample.forward-891"><span class="linenos">891</span></a>
</span><span id="ReadoutLayerQsample.forward-892"><a href="#ReadoutLayerQsample.forward-892"><span class="linenos">892</span></a>        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</span><span id="ReadoutLayerQsample.forward-893"><a href="#ReadoutLayerQsample.forward-893"><span class="linenos">893</span></a>        <span class="n">outdims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span>
</span><span id="ReadoutLayerQsample.forward-894"><a href="#ReadoutLayerQsample.forward-894"><span class="linenos">894</span></a>
</span><span id="ReadoutLayerQsample.forward-895"><a href="#ReadoutLayerQsample.forward-895"><span class="linenos">895</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_sample</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-896"><a href="#ReadoutLayerQsample.forward-896"><span class="linenos">896</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayerQsample.forward-897"><a href="#ReadoutLayerQsample.forward-897"><span class="linenos">897</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayerQsample.forward-898"><a href="#ReadoutLayerQsample.forward-898"><span class="linenos">898</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-899"><a href="#ReadoutLayerQsample.forward-899"><span class="linenos">899</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayerQsample.forward-900"><a href="#ReadoutLayerQsample.forward-900"><span class="linenos">900</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_space_dims</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-901"><a href="#ReadoutLayerQsample.forward-901"><span class="linenos">901</span></a>        
</span><span id="ReadoutLayerQsample.forward-902"><a href="#ReadoutLayerQsample.forward-902"><span class="linenos">902</span></a>        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-903"><a href="#ReadoutLayerQsample.forward-903"><span class="linenos">903</span></a>            <span class="c1"># shifter is run outside the readout forward</span>
</span><span id="ReadoutLayerQsample.forward-904"><a href="#ReadoutLayerQsample.forward-904"><span class="linenos">904</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ReadoutLayerQsample.forward-905"><a href="#ReadoutLayerQsample.forward-905"><span class="linenos">905</span></a>
</span><span id="ReadoutLayerQsample.forward-906"><a href="#ReadoutLayerQsample.forward-906"><span class="linenos">906</span></a>        <span class="c1"># Might have to do sample per cell (i.e. for loop)</span>
</span><span id="ReadoutLayerQsample.forward-907"><a href="#ReadoutLayerQsample.forward-907"><span class="linenos">907</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_Qsample</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-908"><a href="#ReadoutLayerQsample.forward-908"><span class="linenos">908</span></a>            <span class="c1"># sample the grid_locations separately per sample per batch</span>
</span><span id="ReadoutLayerQsample.forward-909"><a href="#ReadoutLayerQsample.forward-909"><span class="linenos">909</span></a>            <span class="n">Qgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Qgrid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span><span class="p">)</span>  <span class="c1"># sample determines sampling from Gaussian</span>
</span><span id="ReadoutLayerQsample.forward-910"><a href="#ReadoutLayerQsample.forward-910"><span class="linenos">910</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-911"><a href="#ReadoutLayerQsample.forward-911"><span class="linenos">911</span></a>            <span class="c1"># use one sampled grid_locations for all sample in the batch</span>
</span><span id="ReadoutLayerQsample.forward-912"><a href="#ReadoutLayerQsample.forward-912"><span class="linenos">912</span></a>            <span class="n">Qgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_Qgrid</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Qsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-913"><a href="#ReadoutLayerQsample.forward-913"><span class="linenos">913</span></a>        
</span><span id="ReadoutLayerQsample.forward-914"><a href="#ReadoutLayerQsample.forward-914"><span class="linenos">914</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-915"><a href="#ReadoutLayerQsample.forward-915"><span class="linenos">915</span></a>        <span class="c1"># note I switched this from the default &#39;zeros&#39; so that it wont try to go past the border</span>
</span><span id="ReadoutLayerQsample.forward-916"><a href="#ReadoutLayerQsample.forward-916"><span class="linenos">916</span></a>        
</span><span id="ReadoutLayerQsample.forward-917"><a href="#ReadoutLayerQsample.forward-917"><span class="linenos">917</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-918"><a href="#ReadoutLayerQsample.forward-918"><span class="linenos">918</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_filters</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-919"><a href="#ReadoutLayerQsample.forward-919"><span class="linenos">919</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-920"><a href="#ReadoutLayerQsample.forward-920"><span class="linenos">920</span></a>        <span class="n">y_pad</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;circular&#39;</span><span class="p">)</span> <span class="c1"># circular padding for angle dim)</span>
</span><span id="ReadoutLayerQsample.forward-921"><a href="#ReadoutLayerQsample.forward-921"><span class="linenos">921</span></a>        
</span><span id="ReadoutLayerQsample.forward-922"><a href="#ReadoutLayerQsample.forward-922"><span class="linenos">922</span></a>        <span class="c1"># reduce grid sample for angle</span>
</span><span id="ReadoutLayerQsample.forward-923"><a href="#ReadoutLayerQsample.forward-923"><span class="linenos">923</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">y_pad</span><span class="p">,</span> <span class="n">Qgrid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Qsample_mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_corners</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;border&#39;</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-924"><a href="#ReadoutLayerQsample.forward-924"><span class="linenos">924</span></a>        
</span><span id="ReadoutLayerQsample.forward-925"><a href="#ReadoutLayerQsample.forward-925"><span class="linenos">925</span></a>        <span class="c1"># reduce grid sample for angle</span>
</span><span id="ReadoutLayerQsample.forward-926"><a href="#ReadoutLayerQsample.forward-926"><span class="linenos">926</span></a>        <span class="c1">#z = torch.zeros((N,self.input_dims[0],self.num_filters,1), dtype=torch.float32, device=self.weight.device)</span>
</span><span id="ReadoutLayerQsample.forward-927"><a href="#ReadoutLayerQsample.forward-927"><span class="linenos">927</span></a>        <span class="c1">#for i in range(self.num_filters):</span>
</span><span id="ReadoutLayerQsample.forward-928"><a href="#ReadoutLayerQsample.forward-928"><span class="linenos">928</span></a>        <span class="c1">#    y_i = y[:,:,i,:].reshape(N,self.input_dims[0],self.input_dims[3],1)</span>
</span><span id="ReadoutLayerQsample.forward-929"><a href="#ReadoutLayerQsample.forward-929"><span class="linenos">929</span></a>        <span class="c1">#    Qgrid_i = Qgrid[:,i,:,:].reshape(N,1,1,2)</span>
</span><span id="ReadoutLayerQsample.forward-930"><a href="#ReadoutLayerQsample.forward-930"><span class="linenos">930</span></a>        <span class="c1">#    z_i = F.grid_sample(y_i, Qgrid_i, mode=self.Qsample_mode, align_corners=self.align_corners, padding_mode=&#39;border&#39;)</span>
</span><span id="ReadoutLayerQsample.forward-931"><a href="#ReadoutLayerQsample.forward-931"><span class="linenos">931</span></a>        <span class="c1">#    z[:,:,i,:] = z_i.reshape(N,self.input_dims[0],1)</span>
</span><span id="ReadoutLayerQsample.forward-932"><a href="#ReadoutLayerQsample.forward-932"><span class="linenos">932</span></a>        
</span><span id="ReadoutLayerQsample.forward-933"><a href="#ReadoutLayerQsample.forward-933"><span class="linenos">933</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">outdims</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-934"><a href="#ReadoutLayerQsample.forward-934"><span class="linenos">934</span></a>        <span class="c1">#z = (z.squeeze(-1)).sum(1).view(N, outdims) # for testing only</span>
</span><span id="ReadoutLayerQsample.forward-935"><a href="#ReadoutLayerQsample.forward-935"><span class="linenos">935</span></a>
</span><span id="ReadoutLayerQsample.forward-936"><a href="#ReadoutLayerQsample.forward-936"><span class="linenos">936</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-937"><a href="#ReadoutLayerQsample.forward-937"><span class="linenos">937</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">bias</span>
</span><span id="ReadoutLayerQsample.forward-938"><a href="#ReadoutLayerQsample.forward-938"><span class="linenos">938</span></a>        
</span><span id="ReadoutLayerQsample.forward-939"><a href="#ReadoutLayerQsample.forward-939"><span class="linenos">939</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.forward-940"><a href="#ReadoutLayerQsample.forward-940"><span class="linenos">940</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NL</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.forward-941"><a href="#ReadoutLayerQsample.forward-941"><span class="linenos">941</span></a>        
</span><span id="ReadoutLayerQsample.forward-942"><a href="#ReadoutLayerQsample.forward-942"><span class="linenos">942</span></a>        <span class="k">return</span> <span class="n">z</span>
</span></pre></div>


            <div class="docstring"><p>Propagates the input forwards through the readout</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>x:</strong>  input data</li>
<li><strong>shift (bool):</strong>  shifts the location of the grid (from eye-tracking data)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>z: neuronal activity</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayerQsample.degrees2mu" class="classattr">
                                        <input id="ReadoutLayerQsample.degrees2mu-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">degrees2mu</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">theta_deg</span>, </span><span class="param"><span class="n">to_output</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">continuous</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayerQsample.degrees2mu-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.degrees2mu"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.degrees2mu-945"><a href="#ReadoutLayerQsample.degrees2mu-945"><span class="linenos">945</span></a>    <span class="k">def</span> <span class="nf">degrees2mu</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">theta_deg</span><span class="p">,</span> <span class="n">to_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample.degrees2mu-946"><a href="#ReadoutLayerQsample.degrees2mu-946"><span class="linenos">946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.degrees2mu-947"><a href="#ReadoutLayerQsample.degrees2mu-947"><span class="linenos">947</span></a><span class="sd">        Converts degrees into mu-values. If to_output=True, outputs to an array, and otherwise</span>
</span><span id="ReadoutLayerQsample.degrees2mu-948"><a href="#ReadoutLayerQsample.degrees2mu-948"><span class="linenos">948</span></a><span class="sd">        stores in the Qmu variable. It detects whether half-circle of full circle using stored angle values</span>
</span><span id="ReadoutLayerQsample.degrees2mu-949"><a href="#ReadoutLayerQsample.degrees2mu-949"><span class="linenos">949</span></a><span class="sd">        </span>
</span><span id="ReadoutLayerQsample.degrees2mu-950"><a href="#ReadoutLayerQsample.degrees2mu-950"><span class="linenos">950</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample.degrees2mu-951"><a href="#ReadoutLayerQsample.degrees2mu-951"><span class="linenos">951</span></a><span class="sd">            theta_deg (np array): array of angles in degrees into mu values, based on 180 or 360 deg wrap-around</span>
</span><span id="ReadoutLayerQsample.degrees2mu-952"><a href="#ReadoutLayerQsample.degrees2mu-952"><span class="linenos">952</span></a><span class="sd">            to_output (Boolean): whether to output to variable or store internally as Qmu (default: False, is the latter)</span>
</span><span id="ReadoutLayerQsample.degrees2mu-953"><a href="#ReadoutLayerQsample.degrees2mu-953"><span class="linenos">953</span></a><span class="sd">            continuous (Boolean): whether to convert to continuous angle or closest &quot;integer&quot; mu value (def True, continuous)</span>
</span><span id="ReadoutLayerQsample.degrees2mu-954"><a href="#ReadoutLayerQsample.degrees2mu-954"><span class="linenos">954</span></a><span class="sd">            max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</span>
</span><span id="ReadoutLayerQsample.degrees2mu-955"><a href="#ReadoutLayerQsample.degrees2mu-955"><span class="linenos">955</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample.degrees2mu-956"><a href="#ReadoutLayerQsample.degrees2mu-956"><span class="linenos">956</span></a><span class="sd">            Qmus: as numpy-array, if to_output is set to True, otherwise, nothing </span>
</span><span id="ReadoutLayerQsample.degrees2mu-957"><a href="#ReadoutLayerQsample.degrees2mu-957"><span class="linenos">957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.degrees2mu-958"><a href="#ReadoutLayerQsample.degrees2mu-958"><span class="linenos">958</span></a>        <span class="n">num_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample.degrees2mu-959"><a href="#ReadoutLayerQsample.degrees2mu-959"><span class="linenos">959</span></a>
</span><span id="ReadoutLayerQsample.degrees2mu-960"><a href="#ReadoutLayerQsample.degrees2mu-960"><span class="linenos">960</span></a>        <span class="c1"># convert inputs to np.array</span>
</span><span id="ReadoutLayerQsample.degrees2mu-961"><a href="#ReadoutLayerQsample.degrees2mu-961"><span class="linenos">961</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theta_deg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample.degrees2mu-962"><a href="#ReadoutLayerQsample.degrees2mu-962"><span class="linenos">962</span></a>            <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta_deg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.degrees2mu-963"><a href="#ReadoutLayerQsample.degrees2mu-963"><span class="linenos">963</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">continuous</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.degrees2mu-964"><a href="#ReadoutLayerQsample.degrees2mu-964"><span class="linenos">964</span></a>            <span class="n">dQ</span> <span class="o">=</span> <span class="n">max_angle</span><span class="o">/</span><span class="n">num_angles</span>
</span><span id="ReadoutLayerQsample.degrees2mu-965"><a href="#ReadoutLayerQsample.degrees2mu-965"><span class="linenos">965</span></a>            <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">dQ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">theta_deg</span><span class="o">/</span><span class="n">dQ</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.degrees2mu-966"><a href="#ReadoutLayerQsample.degrees2mu-966"><span class="linenos">966</span></a>        <span class="n">theta_deg</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_deg</span><span class="o">%</span><span class="n">max_angle</span><span class="p">)</span>  <span class="c1"># map between 0 and max_angle</span>
</span><span id="ReadoutLayerQsample.degrees2mu-967"><a href="#ReadoutLayerQsample.degrees2mu-967"><span class="linenos">967</span></a>
</span><span id="ReadoutLayerQsample.degrees2mu-968"><a href="#ReadoutLayerQsample.degrees2mu-968"><span class="linenos">968</span></a>        <span class="n">mu_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_angles</span> <span class="c1"># first bin at 0 degrees is actually a shifted mu value (not right at edge)</span>
</span><span id="ReadoutLayerQsample.degrees2mu-969"><a href="#ReadoutLayerQsample.degrees2mu-969"><span class="linenos">969</span></a>        <span class="n">Qmus</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_deg</span><span class="o">-</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">mu_offset</span>
</span><span id="ReadoutLayerQsample.degrees2mu-970"><a href="#ReadoutLayerQsample.degrees2mu-970"><span class="linenos">970</span></a>        <span class="n">Qmus</span><span class="p">[</span><span class="n">Qmus</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="ReadoutLayerQsample.degrees2mu-971"><a href="#ReadoutLayerQsample.degrees2mu-971"><span class="linenos">971</span></a>        <span class="n">Qmus</span><span class="p">[</span><span class="n">Qmus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span>
</span><span id="ReadoutLayerQsample.degrees2mu-972"><a href="#ReadoutLayerQsample.degrees2mu-972"><span class="linenos">972</span></a>        <span class="k">if</span> <span class="n">to_output</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.degrees2mu-973"><a href="#ReadoutLayerQsample.degrees2mu-973"><span class="linenos">973</span></a>            <span class="k">return</span> <span class="n">Qmus</span>
</span><span id="ReadoutLayerQsample.degrees2mu-974"><a href="#ReadoutLayerQsample.degrees2mu-974"><span class="linenos">974</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Qmus</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;incorrect number of angles input </span><span class="si">%d</span><span class="s2"> neq </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qmus</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ReadoutLayerQsample.degrees2mu-975"><a href="#ReadoutLayerQsample.degrees2mu-975"><span class="linenos">975</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">Qmus</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Converts degrees into mu-values. If to_output=True, outputs to an array, and otherwise
stores in the Qmu variable. It detects whether half-circle of full circle using stored angle values</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>theta_deg (np array):</strong>  array of angles in degrees into mu values, based on 180 or 360 deg wrap-around</li>
<li><strong>to_output (Boolean):</strong>  whether to output to variable or store internally as Qmu (default: False, is the latter)</li>
<li><strong>continuous (Boolean):</strong>  whether to convert to continuous angle or closest "integer" mu value (def True, continuous)</li>
<li><strong>max_angle:</strong>  maximum angle represented in OriConv layers (default 180, but could be 360)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Qmus: as numpy-array, if to_output is set to True, otherwise, nothing</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayerQsample.mu2degrees" class="classattr">
                                        <input id="ReadoutLayerQsample.mu2degrees-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mu2degrees</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mu</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayerQsample.mu2degrees-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.mu2degrees"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.mu2degrees-978"><a href="#ReadoutLayerQsample.mu2degrees-978"><span class="linenos">978</span></a>    <span class="k">def</span> <span class="nf">mu2degrees</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">180</span> <span class="p">):</span>
</span><span id="ReadoutLayerQsample.mu2degrees-979"><a href="#ReadoutLayerQsample.mu2degrees-979"><span class="linenos">979</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.mu2degrees-980"><a href="#ReadoutLayerQsample.mu2degrees-980"><span class="linenos">980</span></a><span class="sd">        Converts Qmu-values into degrees. Automatically reads from Qmu variable, and outputs a numpy array</span>
</span><span id="ReadoutLayerQsample.mu2degrees-981"><a href="#ReadoutLayerQsample.mu2degrees-981"><span class="linenos">981</span></a><span class="sd">        It detects whether half-circle of full circle using stored angle values</span>
</span><span id="ReadoutLayerQsample.mu2degrees-982"><a href="#ReadoutLayerQsample.mu2degrees-982"><span class="linenos">982</span></a><span class="sd">        </span>
</span><span id="ReadoutLayerQsample.mu2degrees-983"><a href="#ReadoutLayerQsample.mu2degrees-983"><span class="linenos">983</span></a><span class="sd">        Args:     </span>
</span><span id="ReadoutLayerQsample.mu2degrees-984"><a href="#ReadoutLayerQsample.mu2degrees-984"><span class="linenos">984</span></a><span class="sd">            Qmus: if dont want to read from layer, pass in values directly (default None, using self.Qmu)       </span>
</span><span id="ReadoutLayerQsample.mu2degrees-985"><a href="#ReadoutLayerQsample.mu2degrees-985"><span class="linenos">985</span></a><span class="sd">            max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</span>
</span><span id="ReadoutLayerQsample.mu2degrees-986"><a href="#ReadoutLayerQsample.mu2degrees-986"><span class="linenos">986</span></a>
</span><span id="ReadoutLayerQsample.mu2degrees-987"><a href="#ReadoutLayerQsample.mu2degrees-987"><span class="linenos">987</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample.mu2degrees-988"><a href="#ReadoutLayerQsample.mu2degrees-988"><span class="linenos">988</span></a><span class="sd">            thetas: angles in degrees (between 0 to max_angle)</span>
</span><span id="ReadoutLayerQsample.mu2degrees-989"><a href="#ReadoutLayerQsample.mu2degrees-989"><span class="linenos">989</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.mu2degrees-990"><a href="#ReadoutLayerQsample.mu2degrees-990"><span class="linenos">990</span></a>        <span class="n">num_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ReadoutLayerQsample.mu2degrees-991"><a href="#ReadoutLayerQsample.mu2degrees-991"><span class="linenos">991</span></a>        <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ReadoutLayerQsample.mu2degrees-992"><a href="#ReadoutLayerQsample.mu2degrees-992"><span class="linenos">992</span></a>            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qmu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
</span><span id="ReadoutLayerQsample.mu2degrees-993"><a href="#ReadoutLayerQsample.mu2degrees-993"><span class="linenos">993</span></a>
</span><span id="ReadoutLayerQsample.mu2degrees-994"><a href="#ReadoutLayerQsample.mu2degrees-994"><span class="linenos">994</span></a>        <span class="n">mu</span> <span class="o">+=</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_angles</span> <span class="c1"># first bin at 0 degrees is actually a shifted mu value (not right at edge)</span>
</span><span id="ReadoutLayerQsample.mu2degrees-995"><a href="#ReadoutLayerQsample.mu2degrees-995"><span class="linenos">995</span></a>        <span class="n">thetas</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">max_angle</span><span class="o">/</span><span class="mi">2</span>
</span><span id="ReadoutLayerQsample.mu2degrees-996"><a href="#ReadoutLayerQsample.mu2degrees-996"><span class="linenos">996</span></a>        <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span> <span class="o">%</span> <span class="n">max_angle</span> 
</span><span id="ReadoutLayerQsample.mu2degrees-997"><a href="#ReadoutLayerQsample.mu2degrees-997"><span class="linenos">997</span></a>        <span class="k">return</span> <span class="n">thetas</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Converts Qmu-values into degrees. Automatically reads from Qmu variable, and outputs a numpy array
It detects whether half-circle of full circle using stored angle values</p>

<p>Args:<br />
    Qmus: if dont want to read from layer, pass in values directly (default None, using self.Qmu)<br />
    max_angle: maximum angle represented in OriConv layers (default 180, but could be 360)</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>thetas: angles in degrees (between 0 to max_angle)</p>
</blockquote>
</div>


                            </div>
                            <div id="ReadoutLayerQsample.layer_dict" class="classattr">
                                        <input id="ReadoutLayerQsample.layer_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">layer_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">Qsigma</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadoutLayerQsample.layer_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadoutLayerQsample.layer_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadoutLayerQsample.layer_dict-1003"><a href="#ReadoutLayerQsample.layer_dict-1003"><span class="linenos">1003</span></a>    <span class="nd">@classmethod</span>
</span><span id="ReadoutLayerQsample.layer_dict-1004"><a href="#ReadoutLayerQsample.layer_dict-1004"><span class="linenos">1004</span></a>    <span class="k">def</span> <span class="nf">layer_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Qsigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ReadoutLayerQsample.layer_dict-1005"><a href="#ReadoutLayerQsample.layer_dict-1005"><span class="linenos">1005</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.layer_dict-1006"><a href="#ReadoutLayerQsample.layer_dict-1006"><span class="linenos">1006</span></a><span class="sd">        This outputs a dictionary of parameters that need to input into the layer to completely specify.</span>
</span><span id="ReadoutLayerQsample.layer_dict-1007"><a href="#ReadoutLayerQsample.layer_dict-1007"><span class="linenos">1007</span></a><span class="sd">        Output is a dictionary with these keywords. </span>
</span><span id="ReadoutLayerQsample.layer_dict-1008"><a href="#ReadoutLayerQsample.layer_dict-1008"><span class="linenos">1008</span></a><span class="sd">        -- All layer-specific inputs are included in the returned dict</span>
</span><span id="ReadoutLayerQsample.layer_dict-1009"><a href="#ReadoutLayerQsample.layer_dict-1009"><span class="linenos">1009</span></a><span class="sd">        -- Values that must be set are set to empty lists</span>
</span><span id="ReadoutLayerQsample.layer_dict-1010"><a href="#ReadoutLayerQsample.layer_dict-1010"><span class="linenos">1010</span></a><span class="sd">        -- Other values will be given their defaults</span>
</span><span id="ReadoutLayerQsample.layer_dict-1011"><a href="#ReadoutLayerQsample.layer_dict-1011"><span class="linenos">1011</span></a>
</span><span id="ReadoutLayerQsample.layer_dict-1012"><a href="#ReadoutLayerQsample.layer_dict-1012"><span class="linenos">1012</span></a><span class="sd">        Args:</span>
</span><span id="ReadoutLayerQsample.layer_dict-1013"><a href="#ReadoutLayerQsample.layer_dict-1013"><span class="linenos">1013</span></a><span class="sd">            None</span>
</span><span id="ReadoutLayerQsample.layer_dict-1014"><a href="#ReadoutLayerQsample.layer_dict-1014"><span class="linenos">1014</span></a>
</span><span id="ReadoutLayerQsample.layer_dict-1015"><a href="#ReadoutLayerQsample.layer_dict-1015"><span class="linenos">1015</span></a><span class="sd">        Returns:</span>
</span><span id="ReadoutLayerQsample.layer_dict-1016"><a href="#ReadoutLayerQsample.layer_dict-1016"><span class="linenos">1016</span></a><span class="sd">            Ldict: dictionary of layer parameters</span>
</span><span id="ReadoutLayerQsample.layer_dict-1017"><a href="#ReadoutLayerQsample.layer_dict-1017"><span class="linenos">1017</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReadoutLayerQsample.layer_dict-1018"><a href="#ReadoutLayerQsample.layer_dict-1018"><span class="linenos">1018</span></a>        <span class="n">Ldict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ReadoutLayerQsample.layer_dict-1019"><a href="#ReadoutLayerQsample.layer_dict-1019"><span class="linenos">1019</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;readoutQ&#39;</span>
</span><span id="ReadoutLayerQsample.layer_dict-1020"><a href="#ReadoutLayerQsample.layer_dict-1020"><span class="linenos">1020</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;batch_Qample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ReadoutLayerQsample.layer_dict-1021"><a href="#ReadoutLayerQsample.layer_dict-1021"><span class="linenos">1021</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;init_Qsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="ReadoutLayerQsample.layer_dict-1022"><a href="#ReadoutLayerQsample.layer_dict-1022"><span class="linenos">1022</span></a>        <span class="n">Ldict</span><span class="p">[</span><span class="s1">&#39;Qsample_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
</span><span id="ReadoutLayerQsample.layer_dict-1023"><a href="#ReadoutLayerQsample.layer_dict-1023"><span class="linenos">1023</span></a>        <span class="k">return</span> <span class="n">Ldict</span>
</span></pre></div>


            <div class="docstring"><p>This outputs a dictionary of parameters that need to input into the layer to completely specify.
Output is a dictionary with these keywords. 
-- All layer-specific inputs are included in the returned dict
-- Values that must be set are set to empty lists
-- Other values will be given their defaults</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Ldict: dictionary of layer parameters</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ReadoutLayer3d">ReadoutLayer3d</a></dt>
                                <dd id="ReadoutLayerQsample.input_dims" class="variable"><a href="#ReadoutLayer3d.input_dims">input_dims</a></dd>
                <dd id="ReadoutLayerQsample.filter_dims" class="variable"><a href="#ReadoutLayer3d.filter_dims">filter_dims</a></dd>
                <dd id="ReadoutLayerQsample.reg" class="variable"><a href="#ReadoutLayer3d.reg">reg</a></dd>
                <dd id="ReadoutLayerQsample.set_mask" class="function"><a href="#ReadoutLayer3d.set_mask">set_mask</a></dd>
                <dd id="ReadoutLayerQsample.passive_readout" class="function"><a href="#ReadoutLayer3d.passive_readout">passive_readout</a></dd>

            </div>
            <div><dt><a href="#ReadoutLayer">ReadoutLayer</a></dt>
                                <dd id="ReadoutLayerQsample.batch_sample" class="variable"><a href="#ReadoutLayer.batch_sample">batch_sample</a></dd>
                <dd id="ReadoutLayerQsample.sample_mode" class="variable"><a href="#ReadoutLayer.sample_mode">sample_mode</a></dd>
                <dd id="ReadoutLayerQsample.init_mu_range" class="variable"><a href="#ReadoutLayer.init_mu_range">init_mu_range</a></dd>
                <dd id="ReadoutLayerQsample.init_sigma" class="variable"><a href="#ReadoutLayer.init_sigma">init_sigma</a></dd>
                <dd id="ReadoutLayerQsample.align_corners" class="variable"><a href="#ReadoutLayer.align_corners">align_corners</a></dd>
                <dd id="ReadoutLayerQsample.grid_shape" class="variable"><a href="#ReadoutLayer.grid_shape">grid_shape</a></dd>
                <dd id="ReadoutLayerQsample.mu" class="variable"><a href="#ReadoutLayer.mu">mu</a></dd>
                <dd id="ReadoutLayerQsample.sigma" class="variable"><a href="#ReadoutLayer.sigma">sigma</a></dd>
                <dd id="ReadoutLayerQsample.level_reg" class="variable"><a href="#ReadoutLayer.level_reg">level_reg</a></dd>
                <dd id="ReadoutLayerQsample.sample" class="variable"><a href="#ReadoutLayer.sample">sample</a></dd>
                <dd id="ReadoutLayerQsample.features" class="variable"><a href="#ReadoutLayer.features">features</a></dd>
                <dd id="ReadoutLayerQsample.grid" class="variable"><a href="#ReadoutLayer.grid">grid</a></dd>
                <dd id="ReadoutLayerQsample.initialize_spatial_mapping" class="function"><a href="#ReadoutLayer.initialize_spatial_mapping">initialize_spatial_mapping</a></dd>
                <dd id="ReadoutLayerQsample.sample_grid" class="function"><a href="#ReadoutLayer.sample_grid">sample_grid</a></dd>
                <dd id="ReadoutLayerQsample.get_weights" class="function"><a href="#ReadoutLayer.get_weights">get_weights</a></dd>
                <dd id="ReadoutLayerQsample.compute_reg_loss" class="function"><a href="#ReadoutLayer.compute_reg_loss">compute_reg_loss</a></dd>
                <dd id="ReadoutLayerQsample.set_readout_locations" class="function"><a href="#ReadoutLayer.set_readout_locations">set_readout_locations</a></dd>
                <dd id="ReadoutLayerQsample.get_readout_locations" class="function"><a href="#ReadoutLayer.get_readout_locations">get_readout_locations</a></dd>
                <dd id="ReadoutLayerQsample.fit_mus" class="function"><a href="#ReadoutLayer.fit_mus">fit_mus</a></dd>
                <dd id="ReadoutLayerQsample.enforce_grid" class="function"><a href="#ReadoutLayer.enforce_grid">enforce_grid</a></dd>

            </div>
            <div><dt><a href="ndnlayer.html#NDNLayer">NDNT.modules.layers.ndnlayer.NDNLayer</a></dt>
                                <dd id="ReadoutLayerQsample.num_filters" class="variable"><a href="ndnlayer.html#NDNLayer.num_filters">num_filters</a></dd>
                <dd id="ReadoutLayerQsample.output_dims" class="variable"><a href="ndnlayer.html#NDNLayer.output_dims">output_dims</a></dd>
                <dd id="ReadoutLayerQsample.norm_type" class="variable"><a href="ndnlayer.html#NDNLayer.norm_type">norm_type</a></dd>
                <dd id="ReadoutLayerQsample.pos_constraint" class="variable"><a href="ndnlayer.html#NDNLayer.pos_constraint">pos_constraint</a></dd>
                <dd id="ReadoutLayerQsample.conv" class="variable"><a href="ndnlayer.html#NDNLayer.conv">conv</a></dd>
                <dd id="ReadoutLayerQsample.NL" class="variable"><a href="ndnlayer.html#NDNLayer.NL">NL</a></dd>
                <dd id="ReadoutLayerQsample.shape" class="variable"><a href="ndnlayer.html#NDNLayer.shape">shape</a></dd>
                <dd id="ReadoutLayerQsample.weight_scale" class="variable"><a href="ndnlayer.html#NDNLayer.weight_scale">weight_scale</a></dd>
                <dd id="ReadoutLayerQsample.weight" class="variable"><a href="ndnlayer.html#NDNLayer.weight">weight</a></dd>
                <dd id="ReadoutLayerQsample.num_inh" class="variable"><a href="ndnlayer.html#NDNLayer.num_inh">num_inh</a></dd>
                <dd id="ReadoutLayerQsample.reset_parameters" class="function"><a href="ndnlayer.html#NDNLayer.reset_parameters">reset_parameters</a></dd>
                <dd id="ReadoutLayerQsample.initialize_gaussian_envelope" class="function"><a href="ndnlayer.html#NDNLayer.initialize_gaussian_envelope">initialize_gaussian_envelope</a></dd>
                <dd id="ReadoutLayerQsample.preprocess_weights" class="function"><a href="ndnlayer.html#NDNLayer.preprocess_weights">preprocess_weights</a></dd>
                <dd id="ReadoutLayerQsample.list_parameters" class="function"><a href="ndnlayer.html#NDNLayer.list_parameters">list_parameters</a></dd>
                <dd id="ReadoutLayerQsample.set_parameters" class="function"><a href="ndnlayer.html#NDNLayer.set_parameters">set_parameters</a></dd>
                <dd id="ReadoutLayerQsample.set_reg_val" class="function"><a href="ndnlayer.html#NDNLayer.set_reg_val">set_reg_val</a></dd>
                <dd id="ReadoutLayerQsample.plot_filters" class="function"><a href="ndnlayer.html#NDNLayer.plot_filters">plot_filters</a></dd>
                <dd id="ReadoutLayerQsample.info" class="function"><a href="ndnlayer.html#NDNLayer.info">info</a></dd>
                <dd id="ReadoutLayerQsample.dim_info" class="function"><a href="ndnlayer.html#NDNLayer.dim_info">dim_info</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ReadoutLayerQsample.dump_patches" class="variable">dump_patches</dd>
                <dd id="ReadoutLayerQsample.training" class="variable">training</dd>
                <dd id="ReadoutLayerQsample.call_super_init" class="variable">call_super_init</dd>
                <dd id="ReadoutLayerQsample.register_buffer" class="function">register_buffer</dd>
                <dd id="ReadoutLayerQsample.register_parameter" class="function">register_parameter</dd>
                <dd id="ReadoutLayerQsample.add_module" class="function">add_module</dd>
                <dd id="ReadoutLayerQsample.register_module" class="function">register_module</dd>
                <dd id="ReadoutLayerQsample.get_submodule" class="function">get_submodule</dd>
                <dd id="ReadoutLayerQsample.get_parameter" class="function">get_parameter</dd>
                <dd id="ReadoutLayerQsample.get_buffer" class="function">get_buffer</dd>
                <dd id="ReadoutLayerQsample.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ReadoutLayerQsample.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ReadoutLayerQsample.apply" class="function">apply</dd>
                <dd id="ReadoutLayerQsample.cuda" class="function">cuda</dd>
                <dd id="ReadoutLayerQsample.ipu" class="function">ipu</dd>
                <dd id="ReadoutLayerQsample.xpu" class="function">xpu</dd>
                <dd id="ReadoutLayerQsample.cpu" class="function">cpu</dd>
                <dd id="ReadoutLayerQsample.type" class="function">type</dd>
                <dd id="ReadoutLayerQsample.float" class="function">float</dd>
                <dd id="ReadoutLayerQsample.double" class="function">double</dd>
                <dd id="ReadoutLayerQsample.half" class="function">half</dd>
                <dd id="ReadoutLayerQsample.bfloat16" class="function">bfloat16</dd>
                <dd id="ReadoutLayerQsample.to_empty" class="function">to_empty</dd>
                <dd id="ReadoutLayerQsample.to" class="function">to</dd>
                <dd id="ReadoutLayerQsample.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ReadoutLayerQsample.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ReadoutLayerQsample.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ReadoutLayerQsample.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ReadoutLayerQsample.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ReadoutLayerQsample.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ReadoutLayerQsample.state_dict" class="function">state_dict</dd>
                <dd id="ReadoutLayerQsample.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ReadoutLayerQsample.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ReadoutLayerQsample.parameters" class="function">parameters</dd>
                <dd id="ReadoutLayerQsample.named_parameters" class="function">named_parameters</dd>
                <dd id="ReadoutLayerQsample.buffers" class="function">buffers</dd>
                <dd id="ReadoutLayerQsample.named_buffers" class="function">named_buffers</dd>
                <dd id="ReadoutLayerQsample.children" class="function">children</dd>
                <dd id="ReadoutLayerQsample.named_children" class="function">named_children</dd>
                <dd id="ReadoutLayerQsample.modules" class="function">modules</dd>
                <dd id="ReadoutLayerQsample.named_modules" class="function">named_modules</dd>
                <dd id="ReadoutLayerQsample.train" class="function">train</dd>
                <dd id="ReadoutLayerQsample.eval" class="function">eval</dd>
                <dd id="ReadoutLayerQsample.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ReadoutLayerQsample.zero_grad" class="function">zero_grad</dd>
                <dd id="ReadoutLayerQsample.share_memory" class="function">share_memory</dd>
                <dd id="ReadoutLayerQsample.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>